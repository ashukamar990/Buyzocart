<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
  <title>Buyzo Cart - India's Best Online Shopping Deals & Offers</title>
  <link rel="icon" type="image/png" href="favicon.png" sizes="32x32" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />
  <meta name="title" content="Buyzo Cart - India's Best Online Shopping Deals & Offers" />
  <meta name="description" content="Buyzo Cart: Shop the best deals on fashion, electronics, home essentials & more. ‚úì Free Shipping ‚úì Secure Payments ‚úì Easy Returns ‚úì COD Available." />
  <meta name="keywords" content="online shopping, buyzo cart, best deals, fashion, electronics, home decor, India shopping, discount offers" />
  <meta name="author" content="Buyzo Cart" />
  <meta name="robots" content="index, follow" />
  <meta name="language" content="English" />
  <meta name="revisit-after" content="1 day" />
  <link rel="canonical" href="https://buyzocartshop.com/" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://buyzocartshop.com/" />
  <meta property="og:title" content="Buyzo Cart - India's Best Online Shopping Deals" />
  <meta property="og:description" content="Shop the best deals on fashion, electronics, home essentials & more. ‚úì Free Shipping ‚úì Secure Payments ‚úì Easy Returns" />
  <meta property="og:image" content="https://buyzocartshop.com/og-image.jpg" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:site_name" content="Buyzo Cart" />
  <meta property="og:locale" content="en_IN" />
  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content="https://buyzocartshop.com/" />
  <meta property="twitter:title" content="Buyzo Cart - India's Best Online Shopping Deals" />
  <meta property="twitter:description" content="Shop the best deals on fashion, electronics, home essentials & more. ‚úì Free Shipping ‚úì Secure Payments ‚úì Easy Returns" />
  <meta property="twitter:image" content="https://buyzocartshop.com/twitter-image.jpg" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preconnect" href="https://images.unsplash.com" />
  <link rel="preconnect" href="https://www.gstatic.com" />
  <link rel="preconnect" href="https://buyzocart-default-rtdb.firebaseio.com" />
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" as="style" />
  <link rel="preload" href="style.css" as="style" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Buyzo Cart",
    "url": "https://buyzocartshop.com/",
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://buyzocartshop.com/#searchResultsPage?q={search_term_string}",
      "query-input": "required name=search_term_string"
    },
    "description": "India's premier online shopping destination for fashion, electronics, and home essentials.",
    "publisher": {
      "@type": "Organization",
      "name": "Buyzo Cart",
      "logo": {
        "@type": "ImageObject",
        "url": "https://buyzocartshop.com/logo.png"
      }
    }
  }
  </script>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "Buyzo Cart",
    "url": "https://buyzocartshop.com/",
    "logo": "https://buyzocartshop.com/logo.png",
    "sameAs": [
      "https://www.facebook.com/share/1ADdTZ89qu/",
      "https://www.instagram.com/buyzo.cart",
      "https://www.youtube.com/@BuyzoCart",
      "https://t.me/buyzocartshop"
    ],
    "contactPoint": {
      "@type": "ContactPoint",
      "telephone": "+91-9557987574",
      "contactType": "customer service",
      "areaServed": "IN",
      "availableLanguage": "English"
    }
  }
  </script>
  <meta name="theme-color" content="#3b82f6" />
  <meta name="msapplication-TileColor" content="#3b82f6" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Buyzo Cart" />
  <meta name="google-site-verification" content="your-verification-code" />
</head>
<body>
  <div class="menu-overlay" id="menuOverlay"></div>
  
  <div class="mobile-menu" id="mobileMenu">
    <div class="menu-header">
      <div class="brand">
        <span class="chip">BUYZO</span>
        <span>Cart</span>
      </div>
      <div class="menu-close" id="menuClose">√ó</div>
    </div>
    <div class="menu-items">
      <div class="menu-item" onclick="showPage('homePage'); closeMenu();">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        Home
      </div>
      <div class="menu-item" onclick="showPage('productsPage'); closeMenu();">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px;">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        Products
      </div>
      <div class="menu-item" onclick="checkAuthAndShowPage('myOrdersPage'); closeMenu();">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
        My Orders
      </div>
      <div class="menu-item" onclick="checkAuthAndShowPage('wishlistPage'); closeMenu();">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
        </svg>
        Wishlist
      </div>
      <div class="menu-item" onclick="showCategories(); closeMenu();">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
          <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
        </svg>
        Categories
      </div>
      <div class="menu-item" onclick="window.location.href='offers.html'; closeMenu();">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px;">
          <polygon points="12 2 15 8.5 22 9.3 17 14.1 18.5 21 12 17.5 5.5 21 7 14.1 2 9.3 9 8.5 12 2"/>
        </svg>
        Offers
      </div>
      <div class="menu-item" onclick="checkAuthAndShowPage('myOrdersPage'); closeMenu();">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px;">
          <circle cx="12" cy="12" r="9"></circle>
          <polyline points="12 7 12 12 15 15"></polyline>
        </svg>
        Track Order
      </div>
      <div class="menu-item" onclick="window.location.href='notifications.html'; closeMenu();">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px;">
          <path d="M18 8a6 6 0 0 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"></path>
          <path d="M13.7 21a2 2 0 0 1-3.4 0"></path>
        </svg>
        Notifications
      </div>
      <div class="menu-item" onclick="window.location.href='contact.html'; closeMenu();">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px;">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M9.1 9a3 3 0 1 1 5.8 1c0 2-3 2-3 4"></path>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
        Help & Support
      </div>
      <div class="menu-item" onclick="window.location.href='refund.html'; closeMenu();">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px;">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="15" y1="9" x2="9" y2="15"></line>
          <line x1="9" y1="9" x2="15" y2="15"></line>
        </svg>
        Refund & Cancellation
      </div>
      <div class="menu-item" onclick="window.location.href='sellproduct.html'; closeMenu();">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--accent);">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="16"></line>
          <line x1="8" y1="12" x2="16" y2="12"></line>
        </svg>
        <span style="color:var(--accent); font-weight: 600;">Sell Product</span>
      </div>
      <div class="menu-item" onclick="checkAuthAndShowRecentlyViewed(); closeMenu();">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        Recently Viewed
      </div>
      <div style="display: flex; justify-content: center; gap: 10px; padding: 15px 20px; border-top: 1px solid var(--border);">
        <div class="social-menu-item" onclick="window.open('https://www.facebook.com/share/1ADdTZ89qu/', '_blank'); closeMenu();">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#1877F2">
            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
          </svg>
        </div>
        <div class="social-menu-item" onclick="window.open('https://www.instagram.com/buyzo.cart?igsh=d2Mxc2EwMW45cWwy', '_blank'); closeMenu();">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#E4405F">
            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.069-1.644-.069-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073z"></path>
            <path d="M12 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"></path>
          </svg>
        </div>
        <div class="social-menu-item" onclick="window.open('https://www.youtube.com/@BuyzoCart', '_blank'); closeMenu();">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#FF0000">
            <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
          </svg>
        </div>
        <div class="social-menu-item" onclick="window.open('https://t.me/buyzocartshop', '_blank'); closeMenu();">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#26A5E4">
            <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.447 1.394c-.14.141-.259.259-.374.261l.213-3.053 5.56-5.022c.24-.213-.054-.334-.373-.121l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.136-.954l11.566-4.458c.538-.196 1.006.128.832.941z"/>
          </svg>
        </div>
      </div>
      <div class="menu-item" id="mobileLoginBtn" onclick="showLoginModal(); closeMenu();">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 21v -2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        Login / Sign Up
      </div>
      <div class="menu-item" id="mobileUserProfile" style="display:none;" onclick="window.location.href='account.html'; closeMenu();">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <span id="mobileUserName">My Account</span>
      </div>
      <div class="menu-item" id="mobileLogoutBtn" style="display:none;" onclick="showLogoutConfirmation(); closeMenu();">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
        Logout
      </div>
    </div>
  </div>

  <div class="search-panel" id="searchPanel">
    <div class="search-panel-header">
      <input type="text" class="search-panel-input" id="searchPanelInput" placeholder="Search products, brands, categories..." autocomplete="off">
      <button class="search-panel-close" id="searchPanelClose">√ó</button>
    </div>
    <div class="search-suggestions" id="searchSuggestions" style="display: none;"></div>
    <div class="search-section">
      <div class="search-section-title">
        Recent Searches
        <button class="clear-history" id="clearHistoryBtn">Clear All</button>
      </div>
      <div class="recent-searches" id="recentSearches"></div>
    </div>
    <div class="search-section">
      <div class="search-section-title">Popular Searches</div>
      <div class="popular-searches" id="popularSearches"></div>
    </div>
    <div class="search-section">
      <div class="search-section-title">Search Tags</div>
      <div class="search-tags" id="searchTags"></div>
    </div>
  </div>

  <header>
    <div class="header-inner">
      <div class="menu-icon" id="menuIcon">
        <span></span>
        <span></span>
        <span></span>
      </div>
      <div class="brand" aria-label="Buyzo Cart brand" onclick="showPage('homePage')">
        <span class="chip">BUYZO</span>
        <span>Cart</span>
      </div>
      <div class="cta">
        <button class="theme-toggle" id="themeToggle" title="Toggle Light/Dark Mode">
          <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
          <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
        </button>
        <div class="user-profile" id="userProfile" style="display:none;" onclick="window.location.href='account.html'">
          <div class="user-avatar" id="userAvatar">
            <img class="user-avatar-img" id="userAvatarImg" style="display:none;" />
            <span id="userAvatarInitial">U</span>
          </div>
          <span id="headerUserNameShort" style="font-size:14px;margin-left:5px;"></span>
        </div>
        <button class="btn secondary" id="openLoginTop" title="Login / Sign Up">Login / Sign Up</button>
      </div>
    </div>
    <div class="header-search-container" id="headerSearchContainer">
      <div class="header-search-wrap">
        <input id="headerSearchInput" placeholder="Search products (e.g. 'Sneakers', 'T-shirt')" readonly onclick="openSearchPanel()" />
        <button class="header-search-btn" onclick="openSearchPanel()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="page active" id="homePage">
      <section class="hero">
        <h1 id="heroHeading">Welcome to <span style="color:var(--accent)">Buyzo Cart</span></h1>
        <p id="heroSubheading">Clean, fast checkout. Hand‚Äëpicked products. Fully responsive UI.</p>
        <div class="hero-messages" id="heroMessages">
          <span class="active">üî• Big Sale Today</span>
          <span>üöö Free Shipping over ‚Çπ999</span>
          <span>‚ú® New Arrivals Just Dropped</span>
        </div>
        <div class="highlight-strip" onclick="showPage('productsPage')">
          Limited Time Offer: Flat 40% OFF on all Fashion Items ‚Äî <u>Shop Now ‚Üí</u>
        </div>
      </section>

      <div class="banner-carousel skeleton" id="bannerCarousel">
        <div class="banner-track" id="bannerTrack"></div>
        <div class="banner-controls" id="bannerControls"></div>
      </div>

      <div class="trending-section">
        <div class="trending-header">
          <h2 class="trending-title">Trending Now</h2>
        </div>
        <div class="slider-container">
          <div class="slider-track" id="productSlider">
          </div>
        </div>
      </div>

      <div class="category-circles">
        <h2 class="category-circles-title">Shop by Category</h2>
        <div class="category-circles-container" id="categoryCirclesContainer">
        </div>
      </div>

      <div class="steps center">
        <div class="step-pill" id="pill-products">1 ‚Ä¢ Products</div>
        <div class="step-pill disabled" id="pill-order">2 ‚Ä¢ Order Details</div>
        <div class="step-pill disabled" id="pill-user">3 ‚Ä¢ Your Info</div>
        <div class="step-pill disabled" id="pill-pay">4 ‚Ä¢ Payment</div>
      </div>

      <div class="card-panel" style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <h2 style="margin:0">Featured Products</h2>
      </div>

      <div class="product-grid" id="homeProductGrid">
      </div>

      <div class="recently-viewed" id="recentlyViewedSection" style="display:none;">
        <h2 class="recently-viewed-title">Recently Viewed</h2>
        <div class="slider-container">
          <div class="slider-track" id="recentlyViewedSlider"></div>
        </div>
      </div>

      <div class="newsletter-section">
        <h2 class="newsletter-title">Stay Updated</h2>
        <p class="newsletter-desc">Subscribe to our newsletter for exclusive deals, new arrivals, and special offers.</p>
        <div class="newsletter-form">
          <input type="email" class="newsletter-input" placeholder="Enter your email" id="newsletterEmail" />
          <button class="newsletter-btn" id="subscribeBtn">Subscribe</button>
        </div>
      </div>
    </section>

    <section class="page" id="productsPage">
      <div class="card-panel" style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <h2 style="margin:0">All Products</h2>
        <div style="font-size:14px;color:var(--muted)" id="productsCount"></div>
      </div>

      <div class="price-filter">
        <div class="price-filter-title">Filter by Price</div>
        <div class="price-range-slider-container">
          <div class="price-slider-track" id="priceSliderTrack">
            <div class="price-slider-range" id="priceSliderRange"></div>
            <div class="price-slider-thumb" id="priceMinThumb" style="left: 0%;"></div>
            <div class="price-slider-thumb" id="priceMaxThumb" style="left: 100%;"></div>
          </div>
        </div>
        <div class="price-range-inputs">
          <div class="price-input-wrapper">
            <span id="currencySymbolPriceFilter">‚Çπ</span>
            <input type="number" class="price-input" id="minPrice" placeholder="Min" min="0" max="10000" />
          </div>
          <div class="price-input-separator">-</div>
          <div class="price-input-wrapper">
            <span id="currencySymbolPriceFilter2">‚Çπ</span>
            <input type="number" class="price-input" id="maxPrice" placeholder="Max" min="0" max="10000" />
          </div>
        </div>
        <div class="price-filter-buttons">
          <button class="btn" id="applyPriceFilter">Apply Filter</button>
          <button class="btn secondary" id="resetPriceFilter">Reset</button>
        </div>
      </div>

      <div class="categories" id="categoriesContainer"></div>

      <div class="product-grid" id="productGrid"></div>

      <div id="noProductsMessage" class="card-panel center" style="display:none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="15" y1="9" x2="9" y2="15"></line>
          <line x1="9" y1="9" x2="15" y2="15"></line>
        </svg>
        <h3 style="margin:16px 0 8px;color:var(--muted)">No products found</h3>
        <p style="color:var(--muted-light)">Try adjusting your filters or search terms</p>
        <button class="btn" style="margin-top:16px" onclick="resetAllFilters()">Reset All Filters</button>
      </div>
    </section>

    <section class="page" id="searchResultsPage">
      <div class="card-panel" style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap; margin-bottom:20px;">
        <h2 style="margin:0">Search Results</h2>
        <div style="font-size:14px;color:var(--muted)" id="searchResultsCount"></div>
      </div>

      <div class="header-search-container" style="position: sticky; top: 0; z-index: 10; background: var(--surface); padding: 10px 0;">
        <div class="header-search-wrap">
          <input id="searchResultsInput" placeholder="Search products..." autocomplete="off" value="" />
          <button class="header-search-btn" id="searchResultsBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
          </button>
        </div>
      </div>

      <div class="price-filter" style="margin-top: 10px;">
        <div class="price-filter-title">Filter by Price</div>
        <div class="price-range-slider-container">
          <div class="price-slider-track" id="searchPriceSliderTrack">
            <div class="price-slider-range" id="searchPriceSliderRange"></div>
            <div class="price-slider-thumb" id="searchPriceMinThumb" style="left: 0%;"></div>
            <div class="price-slider-thumb" id="searchPriceMaxThumb" style="left: 100%;"></div>
          </div>
        </div>
        <div class="price-range-inputs">
          <div class="price-input-wrapper">
            <span id="currencySymbolSearch1">‚Çπ</span>
            <input type="number" class="price-input" id="searchMinPrice" placeholder="Min" min="0" max="10000" />
          </div>
          <div class="price-input-separator">-</div>
          <div class="price-input-wrapper">
            <span id="currencySymbolSearch2">‚Çπ</span>
            <input type="number" class="price-input" id="searchMaxPrice" placeholder="Max" min="0" max="10000" />
          </div>
        </div>
        <div class="price-filter-buttons">
          <button class="btn" id="applySearchPriceFilter">Apply Filter</button>
          <button class="btn secondary" id="resetSearchPriceFilter">Reset</button>
        </div>
      </div>

      <div class="product-grid" id="searchResultsGrid"></div>

      <div id="noSearchResultsMessage" class="card-panel center" style="display:none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <h3 style="margin:16px 0 8px;color:var(--muted)">No products found</h3>
        <p style="color:var(--muted-light)">Try different keywords or adjust your price filter</p>
        <button class="btn" style="margin-top:16px" onclick="resetSearchPriceFilter()">Reset Filters</button>
      </div>
    </section>

    <section class="page" id="productDetailPage">
      <div class="product-detail-page">
        <div class="breadcrumb">
          <a href="#" onclick="showPage('homePage')">Home</a>
          <span>></span>
          <a href="#" onclick="showPage('productsPage')">Products</a>
          <span>></span>
          <span id="breadcrumbProductName">Product Details</span>
        </div>
        
        <div class="back-to-products" onclick="showPage('productsPage')">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back to Products
        </div>
        
        <div class="product-detail-container">
          <div class="product-detail-gallery">
            <div class="product-gallery">
              <div class="main-product-image" id="mainProductImage">
                <button class="detail-carousel-control prev">‚ùÆ</button>
                <button class="detail-carousel-control next">‚ùØ</button>
                <button class="image-zoom-btn" id="imageZoomBtn">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    <line x1="11" y1="8" x2="11" y2="14"></line>
                    <line x1="8" y1="11" x2="14" y2="11"></line>
                  </svg>
                </button>
              </div>
              
              <div class="detail-carousel-dots" id="detailCarouselDots"></div>
              
              <div class="similar-products-small">
                <h3 class="similar-products-title">Similar Products</h3>
                <div class="similar-products-slider" id="similarProductsSmallSlider"></div>
              </div>
            </div>
          </div>
          
          <div class="product-detail-info">
            <h1 class="product-detail-title" id="detailTitle"></h1>
            <div class="product-sku" id="detailSku"></div>
            <div class="product-detail-price" id="detailPrice"></div>
            <div class="stock-status in-stock" id="detailStockStatus">In Stock</div>

            <div class="product-detail-desc" id="detailDesc"></div>
            <div class="product-detail-full-desc" id="detailFullDesc"></div>

            <div class="review-section">
              <div class="review-form">
                <h3>Add Your Review</h3>
                <div class="rating-input" id="ratingInput">
                  <span class="rating-star" data-rating="1">‚òÖ</span>
                  <span class="rating-star" data-rating="2">‚òÖ</span>
                  <span class="rating-star" data-rating="3">‚òÖ</span>
                  <span class="rating-star" data-rating="4">‚òÖ</span>
                  <span class="rating-star" data-rating="5">‚òÖ</span>
                </div>
                <textarea class="review-textarea" id="reviewText" placeholder="Share your experience with this product..."></textarea>
                <div class="review-file-upload">
                  <label for="reviewFile" class="file-upload-label">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect>
                      <line x1="9" y1="2" x2="9" y2="22"></line>
                      <line x1="15" y1="2" x2="15" y2="22"></line>
                      <line x1="2" y1="9" x2="22" y2="9"></line>
                      <line x1="2" y1="15" x2="22" y2="15"></line>
                    </svg>
                    Add Photo/Video
                  </label>
                  <input type="file" id="reviewFile" accept="image/*,video/*" style="display:none;">
                  <div class="file-preview" id="filePreview"></div>
                </div>
                <button class="btn review-submit-btn" id="submitReview">Submit Review</button>
                <div id="reviewError" class="review-error" style="display:none;"></div>
              </div>
              
              <div class="reviews-list" id="reviewsList"></div>
              <div class="center" style="margin-top: 15px;">
                <button class="btn secondary" id="viewAllRatingsBtn">View All Ratings</button>
              </div>
            </div>
            
            <div class="product-detail-meta" style="margin-top: 20px;">
              <h4>Share This Product</h4>
              <div style="display: flex; gap: 10px; margin-top: 10px;">
                <input type="text" id="productShareLink" readonly style="flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: var(--radius); background: #f8fafc;">
                <button class="btn secondary" id="copyShareLink">Copy Link</button>
              </div>
            </div>
          </div>
        </div>

        <div class="product-detail-actions">
          <button class="btn" id="detailOrderBtn" style="flex: 2;">Order Now</button>
          <button class="btn secondary" id="detailWishlistBtn" style="flex: 1;">Add to Wishlist</button>
        </div>

        <div class="similar-products">
          <h2 class="similar-title">Similar Products</h2>
          <div class="slider-container">
            <div class="slider-track" id="similarProductsSlider"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="page" id="orderPage">
      <div class="card-panel">
        <h3 style="margin-top:0">Order Details</h3>
        <p style="color:var(--muted)">Choose size/quantity and confirm product before entering contact or payment details.</p>

        <div id="selectedProductCard" class="card" style="margin-bottom:16px">
          <div style="display:flex;gap:16px;flex-direction:column">
            <div id="galleryMain" class="gallery-main">
              <button class="carousel-control prev">‚ùÆ</button>
              <button class="carousel-control next">‚ùØ</button>
              <div class="carousel-dots" id="orderCarouselDots"></div>
            </div>
          </div>
          <div class="card-body">
            <div class="title" id="spTitle"></div>
            <div class="price" id="spPrice"></div>
            <div class="badge" id="spDesc"></div>
            
            <div class="product-selection-section">
              <div class="selection-title">Select Size *</div>
              <div class="size-options" id="sizeOptions">
              </div>
              
              <div style="margin-top: 20px;">
                <div class="selection-title">Select Quantity</div>
                <div class="quantity-control" style="max-width: 200px;">
                  <button class="qty-minus">-</button>
                  <input type="number" id="qtySelect" min="1" value="1" max="3" readonly>
                  <button class="qty-plus">+</button>
                </div>
                <div style="font-size: 12px; color: var(--muted); margin-top: 8px;">Max 3 units per order</div>
              </div>
              
              <div class="size-validation-error" id="sizeValidationError">Please select a size to continue</div>
            </div>

            <div class="product-details" style="margin-top:20px;">
              <h4>Product Details</h4>
              <p id="spFullDesc"></p>
            </div>
            
            <div class="sticky-order-buttons-fixed">
              <button id="toUserInfo" class="btn" style="flex:1">Continue ‚Üí Provide Your Info</button>
              <button id="backToProducts" class="btn secondary" style="flex:1">Back to Products</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="page" id="userPage">
      <div class="card-panel">
        <h3 style="margin-top:0">Your Contact & Delivery Address</h3>
        <p style="color:var(--muted)">We do not use saved addresses. Please provide a fresh delivery address for this order.</p>

        <div class="card-panel" id="savedAddressesSection" style="margin-bottom: 20px;">
          <h4 style="margin-top:0">Select Saved Address</h4>
          <div id="savedAddressesList"></div>
          <button class="btn secondary" onclick="showNewAddressForm()" style="margin-top: 12px;">Add New Address</button>
        </div>

        <div class="card-panel" id="newAddressForm">
          <h4 style="margin-top:0">Delivery Address</h4>
          <div style="display:flex;gap:16px;flex-direction:column">
            <div>
              <label>Full Name *</label>
              <input id="fullname" placeholder="Enter full name" />
            </div>
            <div class="row">
              <div class="col"><label>Mobile Number *</label><input id="mobile" placeholder="10-digit mobile number" type="tel" /></div>
              <div class="col"><label>Pincode *</label><input id="pincode" placeholder="Pincode" type="text" /></div>
            </div>
            <div class="row">
              <div class="col"><label>City *</label><input id="city" /></div>
              <div class="col"><label>State *</label><input id="state" /></div>
            </div>
            <div>
              <label>House / Street *</label>
              <input id="house" placeholder="House no., Building, Street, Area" />
            </div>
            <div>
              <label>Address Type</label>
              <select id="addressType">
                <option value="home">Home</option>
                <option value="work">Work</option>
                <option value="other">Other</option>
              </select>
            </div>
            
            <div class="sticky-action-buttons-fixed">
              <button id="toPayment" class="btn" style="flex:1">Continue to Payment</button>
              <button id="editOrder" class="btn secondary" style="flex:1">Edit Order Details</button>
              <button id="saveUserInfo" class="btn secondary" style="flex:1">Save This Address</button>
            </div>
            
            <div style="margin-top:16px;color:var(--muted);font-size:14px">
              <strong>Note:</strong> If you prefer to change products, click "Edit Order Details" or use "Products" to go back.
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="page" id="paymentPage">
      <div class="card-panel">
        <h3 style="margin-top:0">Payment Method</h3>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px">
          <label style="flex:1;display:flex;align-items:center;gap:8px;padding:12px;border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;">
            <input type="radio" name="pay" value="prepaid" checked /> Prepaid (UPI / Card)
          </label>
          <label style="flex:1;display:flex;align-items:center;gap:8px;padding:12px;border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;">
            <input type="radio" name="pay" value="cod" /> Cash on Delivery
          </label>
        </div>
        
        <div class="payment-charge-note" id="paymentChargeNote" style="display: none;">
          <strong>Note:</strong> For online payments, a payment gateway charge of <span id="gatewayChargePercent">2%</span> will be applied to your order total.
        </div>
        
        <div class="summary">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px"><div>Product</div><div id="sumProduct">-</div></div>
          <div style="display:flex;justify-content:space-between;margin-bottom:8px"><div>Qty</div><div id="sumQty">-</div></div>
          <div style="display:flex;justify-content:space-between;margin-bottom:8px"><div>Price</div><div id="sumPrice">-</div></div>
          <div style="display:flex;justify-content:space-between;margin-bottom:8px"><div>Delivery</div><div id="sumDel">‚Çπ<span id="deliveryCharge">50</span></div></div>
          <div style="display:flex;justify-content:space-between;margin-bottom:12px;padding-bottom:8px;border-bottom:1px dashed var(--border)"><div>Payment Gateway Charge</div><div id="sumGateway">‚Çπ0</div></div>
          <div style="display:flex;justify-content:space-between;font-weight:700;margin-top:8px;font-size:18px"><div>Total</div><div id="sumTotal">-</div></div>
        </div>
        
        <div style="height:16px"></div>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <button id="confirmOrder" class="btn" style="flex:1">Confirm & Place Order</button>
          <button id="payBack" class="btn secondary" style="flex:1">Back</button>
        </div>
      </div>
    </section>

    <section class="page center" id="successPage">
      <div class="card-panel" style="max-width:520px;margin:32px auto;padding:32px; animation: successPop 0.5s ease;">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin:0 auto 16px; animation: successCheck 0.5s ease;">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        <div style="font-size:24px;font-weight:700;color:var(--success);margin-bottom:8px" id="successTitle">Your Order is Placed ‚úÖ</div>
        <div style="margin-top:10px;color:var(--muted)" id="successMessage">
          Order ID: <strong id="orderIdDisplay"></strong><br>
          Take screenshot for future reference.
        </div>
        <div style="margin-top:24px;display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
          <button id="goHome" class="btn">Back to Home</button>
          <button id="viewOrders" class="btn secondary">View My Orders</button>
        </div>
      </div>
    </section>

    <section class="page" id="myOrdersPage">
      <div class="policy-page">
        <div class="back-button" onclick="showPage('homePage')">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back to Home
        </div>
        
        <div class="orders-container">
          <h2>My Orders</h2>
          <p style="color:var(--muted);margin-bottom:24px">View and manage your recent orders</p>
          
          <div id="ordersList"></div>
          
          <div id="orders-empty" class="empty-state" style="display:none">
            <img src="https://cdn-icons-png.flaticon.com/512/891/891419.png" class="empty-icon">
            <h3>No Orders Yet</h3>
            <p>Your orders will appear here after you place them. Start shopping to see your order history.</p>
            <a href="#" class="empty-btn" onclick="showPage('productsPage')">Start Shopping</a>
          </div>
        </div>
      </div>
    </section>

    <section class="page" id="orderDetailPage">
      <div class="policy-page">
        <div class="back-button" onclick="showMyOrders(); showPage('myOrdersPage');">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back to My Orders
        </div>
        
        <div class="orders-container">
          <h2>Order Details</h2>
          
          <div class="order-detail-page" id="orderDetailContent"></div>
        </div>
      </div>
    </section>

    <section class="page" id="wishlistPage">
      <div class="policy-page">
        <div class="back-button" onclick="showPage('homePage')">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back to Home
        </div>
        
        <div class="orders-container">
          <h2>My Wishlist</h2>
          <p style="color:var(--muted);margin-bottom:24px">Your favorite products</p>
          
          <div id="wishlistItems" class="product-grid"></div>
          
          <div id="emptyWishlist" class="card-panel center" style="display:none">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--muted-light)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
            <h3 style="margin:16px 0 8px;color:var(--muted)">Your wishlist is empty.</h3>
            <p style="color:var(--muted-light)">You haven't added any products to your wishlist yet.</p>
            <button class="btn" style="margin-top:16px" onclick="showPage('productsPage')">Browse Products</button>
          </div>
        </div>
      </div>
    </section>

    <section class="page" id="allRatingsPage">
      <div class="policy-page">
        <div class="back-button" onclick="showPage('productDetailPage')">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back to Product
        </div>
        <h2>All Ratings & Reviews</h2>
        <div class="reviews-list" id="allRatingsList"></div>
        <div id="noAllRatingsMessage" class="center" style="display:none;">No reviews yet.</div>
      </div>
    </section>
    
    <section class="page" id="recentlyViewedPage">
      <div class="policy-page">
        <div class="back-button" onclick="showPage('homePage')">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back to Home
        </div>
        
        <h2>Recently Viewed Products</h2>
        <div class="product-grid" id="recentlyViewedGrid"></div>
        
        <div id="emptyRecentlyViewed" class="card-panel center" style="display:none">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--muted-light)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          <h3 style="margin:16px 0 8px;color:var(--muted)">No recently viewed products</h3>
          <p style="color:var(--muted-light)">Products you view will appear here.</p>
          <button class="btn" style="margin-top:16px" onclick="showPage('productsPage')">Browse Products</button>
        </div>
      </div>
    </section>
  </main>

  <div class="bottom-nav">
    <div class="bottom-nav-item active" onclick="showPage('homePage')">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="bottom-nav-icon">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
      </svg>
      <span class="bottom-nav-label">Home</span>
    </div>
    <div class="bottom-nav-item" onclick="showPage('productsPage')">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="bottom-nav-icon">
        <rect x="3" y="3" width="7" height="7"></rect>
        <rect x="14" y="3" width="7" height="7"></rect>
        <rect x="14" y="14" width="7" height="7"></rect>
        <rect x="3" y="14" width="7" height="7"></rect>
      </svg>
      <span class="bottom-nav-label">Products</span>
    </div>
    <div class="bottom-nav-item" onclick="checkAuthAndShowPage('myOrdersPage')">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="bottom-nav-icon">
        <circle cx="9" cy="21" r="1"></circle>
        <circle cx="20" cy="21" r="1"></circle>
        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
      </svg>
      <span class="bottom-nav-label">Orders</span>
    </div>
    <div class="bottom-nav-item" onclick="checkAuthAndShowAccount()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="bottom-nav-icon">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
      <span class="bottom-nav-label">Account</span>
    </div>
  </div>

  <footer>
    <div class="footer-container">
      <div class="footer-content">
        <div class="footer-section">
          <h3>Buyzo Cart</h3>
          <p style="color:var(--muted);margin-bottom:16px">Your trusted online shopping destination for quality products at affordable prices.</p>
          <div class="contact-info">
            <p>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                <polyline points="22,6 12,13 2,6"></polyline>
              </svg>
              <a href="mailto:buyzocartshop@gmail.com">buyzocartshop@gmail.com</a>
            </p>
            <p>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
              </svg>
              <a href="https://wa.me/919557987574?text=Hello%20Buyzo%20Cart%2C%20I%20need%20help%20with%20my%20order%20%F0%9F%99%82%20Please%20assist%20me%20with%20my%20query." target="_blank">
                9557987574 (WhatsApp)
              </a>
            </p>
            <p>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                <polyline points="22,6 12,13 2,6"></polyline>
              </svg>
              <a href="mailto:buyzocart.help@gmail.com">buyzocart.help@gmail.com</a>
            </p>
          </div>
          <div class="social-links">
            <a href="https://www.facebook.com/share/1ADdTZ89qu/" target="_blank" class="social-link facebook">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
              </svg>
            </a>
            <a href="https://www.instagram.com/buyzo.cart?igsh=d2Mxc2EwMW45cWwy" target="_blank" class="social-link instagram">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="2" width="20" height="20" rx="5" ry="5" fill="url(#instagram-gradient-footer)"/>
                <circle cx="12" cy="12" r="5" fill="white"/>
                <circle cx="18" cy="6" r="1.5" fill="white"/>
                <defs>
                  <linearGradient id="instagram-gradient-footer" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="#405DE6" />
                    <stop offset="25%" stop-color="#5851DB" />
                    <stop offset="50%" stop-color="#833AB4" />
                    <stop offset="75%" stop-color="#C13584" />
                    <stop offset="100%" stop-color="#E1306C" />
                  </linearGradient>
                </defs>
              </svg>
            </a>
            <a href="https://www.youtube.com/@BuyzoCart" target="_blank" class="social-link youtube">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
              </svg>
            </a>
            <a href="https://t.me/buyzocartshop" target="_blank" class="social-link telegram">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.447 1.394c-.14.141-.259.259-.374.261l.213-3.053 5.56-5.022c.24-.213-.054-.334-.373-.121l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.136-.954l11.566-4.458c.538-.196 1.006.128.832.941z"/>
              </svg>
            </a>
          </div>
        </div>
        
        <div class="footer-section">
          <h3>Quick Links</h3>
          <ul class="footer-links">
            <li><a onclick="showPage('homePage')">Home</a></li>
            <li><a onclick="showPage('productsPage')">Products</a></li>
            <li><a onclick="checkAuthAndShowPage('myOrdersPage')">My Orders</a></li>
            <li><a onclick="checkAuthAndShowPage('wishlistPage')">Wishlist</a></li>
            <li><a onclick="showCategories()">Categories</a></li>
            <li><a onclick="window.location.href='offers.html'">Offers</a></li>
          </ul>
        </div>
        
        <div class="footer-section">
          <h3>Customer Service</h3>
          <ul class="footer-links">
            <li><a href="shipping.html">Shipping Policy</a></li>
            <li><a href="refund.html">Refund & Cancellation</a></li>
            <li><a onclick="window.location.href='sellproduct.html'">Sell Product</a></li>
            <li><a href="terms.html">Terms & Conditions</a></li>
            <li><a href="privacy.html">Privacy Policy</a></li>
            <li><a href="contact.html">Help & Support</a></li>
            <li><a href="notifications.html">Notifications</a></li>
          </ul>
        </div>
      </div>
    </div>
    
    <div class="copyright">
      &copy; 2024 Buyzo Cart. All rights reserved.
    </div>
  </footer>

  <div class="toast" id="toast"></div>

  <div class="product-image-modal" id="productImageModal">
    <div class="product-image-modal-content">
      <button class="product-image-modal-close" id="productImageModalClose">√ó</button>
      <img class="product-image-modal-image" id="productImageModalImage" src="" alt="Product image">
      <div class="product-image-modal-controls">
        <button class="product-image-modal-prev" id="productImageModalPrev">‚ùÆ</button>
        <button class="product-image-modal-next" id="productImageModalNext">‚ùØ</button>
      </div>
      <div class="product-image-modal-dots" id="productImageModalDots"></div>
    </div>
  </div>

  <div class="modal-overlay zoom-modal" id="zoomModal">
    <div class="zoom-content">
      <button class="zoom-close" id="zoomClose">√ó</button>
      <img class="zoom-image" id="zoomImage" src="" alt="Zoomed product image">
      <div class="zoom-controls">
        <button class="zoom-btn" id="zoomIn">+</button>
        <button class="zoom-btn" id="zoomOut">-</button>
        <button class="zoom-btn" id="zoomReset">‚ü≤</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="authModal">
    <div class="auth-modal">
      <button class="auth-close" id="authClose">√ó</button>
      <h3>Welcome to Buyzo Cart</h3>
      
      <div class="auth-tabs">
        <div class="auth-tab active" id="loginTab">Login</div>
        <div class="auth-tab" id="signupTab">Sign Up</div>
      </div>
      
      <div class="auth-form active" id="loginForm">
        <div class="auth-form-group">
          <label>Email</label>
          <input type="email" id="loginEmail" placeholder="Enter your email">
        </div>
        <div class="auth-form-group">
          <label>Password</label>
          <input type="password" id="loginPassword" placeholder="Enter your password">
        </div>
        <div id="loginError" style="color:red; font-size:14px; margin-bottom:12px;"></div>
        <button class="btn" id="loginBtn" style="width:100%">Login</button>
        
        <div class="divider"><span>or</span></div>
        
        <button class="google-signin-btn" id="googleLoginBtn">
          <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google">
          Continue with Google
        </button>
        
        <div class="auth-form-footer">
          <a id="forgotPasswordLink">Forgot Password?</a>
        </div>
      </div>
      
      <div class="auth-form" id="signupForm">
        <div class="auth-form-group">
          <label>Full Name</label>
          <input type="text" id="signupName" placeholder="Enter your full name">
        </div>
        <div class="auth-form-group">
          <label>Email</label>
          <input type="email" id="signupEmail" placeholder="Enter your email">
        </div>
        <div class="auth-form-group">
          <label>Password</label>
          <input type="password" id="signupPassword" placeholder="Create a password">
        </div>
        <div id="signupError" style="color:red; font-size:14px; margin-bottom:12px;"></div>
        <button class="btn" id="signupBtn" style="width:100%">Sign Up</button>
        
        <div class="divider"><span>or</span></div>
        
        <button class="google-signin-btn" id="googleSignupBtn">
          <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google">
          Continue with Google
        </button>
        
        <div class="auth-form-footer">
          Already have an account? <a id="switchToLogin">Login</a>
        </div>
      </div>
      
      <div class="forgot-password-form" id="forgotPasswordForm">
        <div class="auth-form-group">
          <label>Email</label>
          <input type="email" id="forgotPasswordEmail" placeholder="Enter your email">
        </div>
        <button class="btn" id="resetPasswordBtn" style="width:100%">Send Reset Link</button>
        <div class="back-to-login" id="backToLogin">Back to Login</div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="passwordResetModal">
    <div class="password-reset-modal">
      <h3>Reset Password</h3>
      <input type="email" id="passwordResetEmail" placeholder="Enter your email">
      <div style="display:flex;gap:12px;margin-top:20px;justify-content:flex-end">
        <button class="btn secondary" id="cancelPasswordReset">Cancel</button>
        <button class="btn" id="confirmPasswordReset">Send Reset Link</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="cancellationModal">
    <div class="cancellation-modal">
      <h3>Cancel Order</h3>
      <p>Please select a reason for cancellation:</p>
      
      <div class="cancellation-reason selected">
        <label>
          <input type="radio" name="cancelReason" value="changed-mind" checked> Changed my mind
        </label>
      </div>
      <div class="cancellation-reason">
        <label>
          <input type="radio" name="cancelReason" value="shipping-delay"> Shipping is taking too long
        </label>
      </div>
      <div class="cancellation-reason">
        <label>
          <input type="radio" name="cancelReason" value="found-better-price"> Found a better price elsewhere
        </label>
      </div>
      <div class="cancellation-reason">
        <label>
          <input type="radio" name="cancelReason" value="ordered-by-mistake"> Ordered by mistake
        </label>
      </div>
      <div class="cancellation-reason">
        <label>
          <input type="radio" name="cancelReason" value="other"> Other reason
        </label>
      </div>
      
      <div class="cancellation-actions">
        <button class="btn secondary" id="cancelCancel">Cancel</button>
        <button class="btn error" id="confirmCancel">Confirm Cancellation</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="returnReplaceModal">
    <div class="cancellation-modal">
      <h3 id="returnReplaceTitle">Return or Replace</h3>
      <p>Please select an option:</p>
      
      <div class="cancellation-reason selected">
        <label>
          <input type="radio" name="returnReplaceReason" value="return" checked> Return (Refund)
        </label>
      </div>
      <div class="cancellation-reason">
        <label>
          <input type="radio" name="returnReplaceReason" value="replace"> Replace (Same Product)
        </label>
      </div>
      
      <div class="cancellation-actions">
        <button class="btn secondary" id="cancelReturnReplace">Cancel</button>
        <button class="btn error" id="confirmReturnReplace">Confirm</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="alertModal">
    <div class="alert-modal">
      <div class="alert-icon">‚ö†Ô∏è</div>
      <h3 id="alertTitle">Alert</h3>
      <p id="alertMessage">This is an alert message.</p>
      <div class="alert-modal-buttons">
        <button class="btn secondary" id="alertCancelBtn">Cancel</button>
        <button class="btn" id="alertConfirmBtn">Yes</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getDatabase, ref, set, get, update, remove, onValue, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCHFUx3Y1L3mvyLyDMHVKQE6eXi50_fewE",
      authDomain: "buyzocart.firebaseapp.com",
      databaseURL: "https://buyzocart-default-rtdb.firebaseio.com",
      projectId: "buyzocart",
      storageBucket: "buyzocart.firebasestorage.app",
      messagingSenderId: "640560737762",
      appId: "1:640560737762:web:7fe368df6486d6da759dbb"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth(app);
    
    window.firebase = { app, database, auth, ref, set, get, update, remove, onValue, query, orderByChild, equalTo, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup };
    
    document.addEventListener('DOMContentLoaded', function() {
      initApp();
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    html {
      scroll-behavior: smooth;
    }
    
    body {
      margin: 0;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    
    img {
      max-width: 100%;
      height: auto;
    }
    
    .product-card, .slider-item, .category-circle {
      transform: translateZ(0);
      backface-visibility: hidden;
      perspective: 1000px;
    }
    
    .header-search-container {
      padding: 10px 20px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      transition: all 0.3s ease;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-search-wrap {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .header-search-wrap input {
      width: 100%;
      padding: 12px 50px 12px 20px;
      border: 1px solid var(--border);
      border-radius: 30px;
      background: var(--surface);
      color: var(--text);
      font-size: 16px;
      cursor: pointer;
    }
    
    .header-search-wrap input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .header-search-btn {
      position: absolute;
      right: 10px;
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .header-inner .cta {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .header-inner .user-profile {
      margin: 0;
      cursor: pointer;
      align-items: center;
    }
    
    .product-card .size-selection,
    .product-card .size-options {
      display: none !important;
    }
    
    .product-card-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 5px;
    }
    
    .action-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      transition: color 0.2s;
      flex-shrink: 0;
    }
    
    .action-btn:hover {
      color: var(--accent);
    }
    
    .share-btn:hover {
      color: #3b82f6;
    }
    
    .wishlist-btn {
      margin-right: auto;
    }
    
    .wishlist-btn.active {
      color: #ef4444;
    }
    
    .wishlist-btn.active svg {
      fill: #ef4444;
    }
    
    .search-suggestions {
      max-height: 300px;
      overflow-y: auto;
      border-top: 1px solid var(--border);
    }
    
    .search-suggestion {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .search-suggestion:hover {
      background: var(--hover);
    }
    
    .search-suggestion-img {
      width: 50px;
      height: 50px;
      border-radius: 5px;
      background-size: cover;
      background-position: center;
      margin-right: 10px;
    }
    
    .search-suggestion-info {
      flex: 1;
    }
    
    .search-suggestion-name {
      font-weight: 500;
      margin-bottom: 3px;
    }
    
    .search-suggestion-price {
      color: var(--accent);
      font-weight: 600;
    }
    
    .similar-products-small {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }
    
    .similar-products-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--text);
    }
    
    .similar-products-slider {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    
    .similar-product-small {
      cursor: pointer;
      border-radius: var(--radius);
      overflow: hidden;
      background: var(--surface);
      border: 1px solid var(--border);
      transition: transform 0.2s, box-shadow 0.2s;
      transform: translateZ(0);
    }
    
    .similar-product-small:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .similar-product-small-img {
      height: 80px;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    
    .similar-product-small-info {
      padding: 10px;
    }
    
    .similar-product-small-title {
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 5px;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .similar-product-small-price {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent);
    }
    
    .product-card-current-price {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
    }
    
    .product-card-original-price {
      font-size: 14px;
      color: var(--muted);
      text-decoration: line-through;
    }
    
    .slider-item-price {
      font-size: 16px;
      font-weight: 600;
      color: var(--accent);
    }
    
    .product-gallery {
      position: relative;
    }
    
    .main-product-image {
      position: relative;
      height: 400px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      background-color: #f8fafc;
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 10px;
      cursor: pointer;
      touch-action: pan-y pinch-zoom;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    .image-zoom-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(0, 0, 0, 0.5);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      z-index: 10;
      backdrop-filter: blur(4px);
    }
    
    .image-zoom-btn:hover {
      background: rgba(0, 0, 0, 0.7);
    }
    
    .detail-carousel-dots {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: -15px 0 20px 0;
      padding: 5px 0;
      position: relative;
      z-index: 5;
    }
    
    .detail-carousel-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid rgba(0, 0, 0, 0.3);
    }
    
    .detail-carousel-dot.active {
      background: var(--accent);
      transform: scale(1.2);
    }
    
    .sticky-order-buttons-fixed {
      position: fixed;
      bottom: 70px;
      left: 0;
      right: 0;
      background: var(--surface);
      padding: 15px 20px;
      border-top: 1px solid var(--border);
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 100;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .sticky-action-buttons-fixed {
      position: fixed;
      bottom: 70px;
      left: 0;
      right: 0;
      background: var(--surface);
      padding: 15px 20px;
      border-top: 1px solid var(--border);
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 100;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    #orderPage .card {
      padding-bottom: 100px;
      min-height: calc(100vh - 200px);
    }
    
    #orderPage .card-body {
      display: flex;
      flex-direction: column;
      min-height: 400px;
    }
    
    .contact-info p {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    
    .contact-info a {
      color: var(--text);
      text-decoration: none;
      transition: color 0.2s;
    }
    
    .contact-info a:hover {
      color: var(--accent);
    }
    
    .banner-carousel {
      touch-action: pan-y pinch-zoom;
    }
    
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    .lazy-image {
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .lazy-image.loaded {
      opacity: 1;
    }
    
    .contact-info a[href*="wa.me"] {
      color: #25D366;
      font-weight: 600;
    }
    
    .contact-info a[href*="wa.me"]:hover {
      color: #128C7E;
    }
    
    .search-panel-input {
      font-size: 16px;
      padding: 15px;
      border: 2px solid var(--border);
      border-radius: 10px;
      width: 100%;
      margin-bottom: 15px;
    }
    
    .search-panel-input:focus {
      border-color: var(--accent);
      outline: none;
    }
    
    .recent-search-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
    }
    
    .recent-search-text {
      flex: 1;
      color: var(--text);
    }
    
    .recent-search-text:hover {
      color: var(--accent);
    }
    
    .recent-search-remove {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 18px;
      padding: 0 5px;
    }
    
    .recent-search-remove:hover {
      color: #ef4444;
    }
    
    .slider-container {
      position: relative;
      overflow: hidden;
    }
    
    .slider-track {
      display: flex;
      overflow-x: auto;
      scroll-behavior: smooth;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .slider-track::-webkit-scrollbar {
      display: none;
    }
    
    .banner-track {
      display: flex;
      transition: transform 0.3s ease;
    }
    
    .banner-slide {
      flex: 0 0 100%;
      height: 250px;
      background-size: cover;
      background-position: center;
      border-radius: 10px;
    }
    
    .payment-charge-note {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 5px;
      padding: 10px;
      margin: 15px 0;
      color: #856404;
    }
    
    .product-card-stars {
      font-size: 14px;
      color: #ffc107;
      letter-spacing: 1px;
    }
    
    .product-card-review-count {
      font-size: 12px;
      color: var(--muted);
      margin-left: 5px;
    }

    #searchResultsPage .header-search-container {
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 10px 0;
    }

    #searchResultsPage .price-filter {
      margin-top: 10px;
      margin-bottom: 20px;
    }

    #productDetailPage .product-selection-section {
      display: none;
    }

    .size-option {
      display: inline-block;
      padding: 8px 16px;
      margin: 0 5px 5px 0;
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .size-option.selected {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .quantity-control {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .quantity-control button {
      width: 32px;
      height: 32px;
      border: 1px solid var(--border);
      background: var(--surface);
      border-radius: 4px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .quantity-control input {
      width: 60px;
      text-align: center;
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 5px;
    }

    .size-validation-error {
      color: #ef4444;
      font-size: 14px;
      margin-top: 10px;
      display: none;
    }

    .size-validation-error.show {
      display: block;
    }

    #viewAllRatingsBtn {
      margin-top: 10px;
      width: 100%;
    }

    .review-item {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      position: relative;
    }
    
    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    
    .reviewer-name {
      font-weight: 600;
    }
    
    .review-date {
      color: var(--muted);
      font-size: 12px;
    }
    
    .review-rating {
      color: #ffc107;
      margin-bottom: 10px;
    }
    
    .review-text {
      margin-bottom: 10px;
    }
    
    .review-delete-btn {
      background: none;
      border: 1px solid #ef4444;
      color: #ef4444;
      padding: 4px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-top: 10px;
    }
    
    .review-delete-btn:hover {
      background: #ef4444;
      color: white;
    }
    
    .review-verified-badge {
      display: inline-block;
      background: #22c55e;
      color: white;
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 12px;
      margin-left: 8px;
    }
    
    .review-file-preview {
      margin-top: 10px;
    }
    
    .review-file-preview img {
      max-width: 100%;
      max-height: 200px;
      border-radius: 5px;
    }
    
    .review-file-preview video {
      max-width: 100%;
      max-height: 200px;
      border-radius: 5px;
    }
    
    .review-error {
      color: #ef4444;
      font-size: 14px;
      margin-top: 10px;
      padding: 10px;
      background: #fee2e2;
      border-radius: 5px;
    }
    
    .file-upload-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      margin-top: 10px;
    }
    
    .file-upload-label:hover {
      background: var(--hover);
    }
    
    .saved-address-card {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 15px;
      margin-bottom: 10px;
      cursor: pointer;
    }
    
    .address-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .order-card {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 15px;
      margin-bottom: 15px;
      cursor: pointer;
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .order-id {
      font-weight: 600;
    }
    
    .order-date {
      color: var(--muted);
      font-size: 12px;
    }
    
    .order-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-confirmed {
      background: #fef9c3;
      color: #854d0e;
    }
    
    .status-shipped {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .status-delivered {
      background: #dcfce7;
      color: #166534;
    }
    
    .status-cancelled {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .order-details {
      display: flex;
      gap: 15px;
    }
    
    .order-product-image {
      width: 80px;
      height: 80px;
      background-size: cover;
      background-position: center;
      border-radius: var(--radius);
      flex-shrink: 0;
    }
    
    .order-product-title {
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .order-product-price {
      color: var(--accent);
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .order-product-meta {
      color: var(--muted);
      font-size: 12px;
    }
    
    .order-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .order-action-btn {
      padding: 8px 16px;
      border: 1px solid var(--border);
      background: var(--surface);
      border-radius: var(--radius);
      cursor: pointer;
    }
    
    .order-action-btn.cancel {
      color: #ef4444;
      border-color: #ef4444;
    }
    
    .order-action-btn.return {
      color: #3b82f6;
      border-color: #3b82f6;
    }
    
    .order-action-btn.disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    
    #recentlyViewedGrid .product-card {
      margin-bottom: 20px;
    }

    @keyframes successPop {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    @keyframes successCheck {
      0% { transform: scale(0) rotate(-30deg); opacity: 0; }
      50% { transform: scale(1.2) rotate(10deg); }
      100% { transform: scale(1) rotate(0); opacity: 1; }
    }

    .slide-indicators {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 10px;
    }
    
    .slide-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--muted);
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .slide-indicator.active {
      background: var(--accent);
      transform: scale(1.2);
    }
  </style>

  <script>
    let currentUser = null;
    let currentProduct = null;
    let userInfo = {};
    let currentOrderId = null;
    let products = [];
    let categories = [];
    let banners = [];
    let recentlyViewed = [];
    let currentImageIndex = 0;
    let currentZoomLevel = 1;
    let currentCategoryFilter = null;
    let currentProductImages = [];
    let currentProductModalIndex = 0;
    let currentSelectedColor = null;
    let adminSettings = {
      deliveryCharge: 50,
      gatewayChargePercent: 2,
      freeShippingOver: 999,
      heroHeading: 'Welcome to <span style="color:var(--accent)">Buyzo Cart</span>',
      heroSubheading: 'Clean, fast checkout. Hand‚Äëpicked products. Fully responsive UI.',
      heroMessages: ['üî• Big Sale Today', 'üöö Free Shipping over ‚Çπ999', '‚ú® New Arrivals Just Dropped'],
      currencySymbol: '‚Çπ'
    };
    let savedAddresses = [];
    let recentSearches = [];
    let popularSearches = ['T-Shirt', 'Sneakers', 'Jeans', 'Watch', 'Headphones', 'Mobile', 'Laptop', 'Shoes'];
    let searchTags = ['Summer Collection', 'Winter Sale', 'New Arrivals', 'Best Sellers', 'Limited Edition'];
    let deliveredOrders = [];
    let globalCurrencySymbol = adminSettings.currencySymbol;
    let userCurrencyPreference = localStorage.getItem('userCurrency') || null;
    
    let autoSlideInterval;
    let slidePaused = false;
    let bannerAutoSlideInterval;
    let trendingAutoSlideInterval;

    function safeGetElement(id) {
      const el = document.getElementById(id);
      if (!el) {
        return null;
      }
      return el;
    }

    function safeAddEventListener(element, event, handler, options = {}) {
      if (!element) {
        return;
      }
      element.addEventListener(event, handler, options);
    }

    const cacheManager = {
      KEYS: {
        PRODUCTS: 'bz_products',
        CART: 'bz_cart',
        USER_SESSION: 'bz_user_session',
        ORDERS: 'bz_orders',
        WISHLIST: 'bz_wishlist',
        CATEGORIES: 'bz_categories',
        BANNERS: 'bz_banners',
        SETTINGS: 'bz_settings',
        ADDRESSES: 'bz_addresses'
      },
      TTL: {
        PRODUCTS: 7 * 24 * 60 * 60 * 1000,
        CART: 30 * 24 * 60 * 60 * 1000,
        ORDERS: 30 * 24 * 60 * 60 * 1000,
        DEFAULT: 7 * 24 * 60 * 60 * 1000
      },
      set: function(key, data, ttl = this.TTL.DEFAULT) {
        try {
          const item = {
            data: data,
            timestamp: Date.now(),
            ttl: ttl,
            version: '1.0'
          };
          localStorage.setItem(key, JSON.stringify(item));
          return true;
        } catch (e) {
          if (e.name === 'QuotaExceededError') {
            this.cleanupOldItems();
            try {
              localStorage.setItem(key, JSON.stringify(item));
            } catch (retryError) {}
          }
          return false;
        }
      },
      get: function(key) {
        try {
          const item = localStorage.getItem(key);
          if (!item) return null;
          const parsed = JSON.parse(item);
          const now = Date.now();
          if (now - parsed.timestamp > parsed.ttl) {
            localStorage.removeItem(key);
            return null;
          }
          return parsed.data;
        } catch (e) {
          localStorage.removeItem(key);
          return null;
        }
      },
      remove: function(key) {
        try {
          localStorage.removeItem(key);
          return true;
        } catch (e) {
          return false;
        }
      },
      clear: function() {
        try {
          Object.values(this.KEYS).forEach(key => {
            localStorage.removeItem(key);
          });
          return true;
        } catch (e) {
          return false;
        }
      },
      cleanupOldItems: function() {
        try {
          const now = Date.now();
          Object.keys(localStorage).forEach(key => {
            if (key.startsWith('bz_')) {
              try {
                const item = JSON.parse(localStorage.getItem(key));
                if (now - item.timestamp > this.TTL.DEFAULT) {
                  localStorage.removeItem(key);
                }
              } catch (e) {
                localStorage.removeItem(key);
              }
            }
          });
        } catch (e) {}
      },
      mergeWithLiveData: function(cachedData, liveData, mergeFields = []) {
        if (!cachedData) return liveData;
        if (!liveData) return cachedData;
        if (Array.isArray(cachedData) && Array.isArray(liveData)) {
          const merged = [...liveData];
          cachedData.forEach(cachedItem => {
            if (cachedItem && cachedItem.id) {
              const existing = merged.find(item => item && item.id === cachedItem.id);
              if (!existing) {
                merged.push(cachedItem);
              } else if (mergeFields.length > 0) {
                mergeFields.forEach(field => {
                  if (cachedItem[field] !== undefined && existing[field] === undefined) {
                    existing[field] = cachedItem[field];
                  }
                });
              }
            }
          });
          return merged;
        }
        return { ...cachedData, ...liveData };
      }
    };

    class GlobalSliderController {
      constructor() {
        this.sliders = new Map();
        this.activeSliders = new Set();
        this.autoSlideIntervals = new Map();
        this.isPaused = false;
        this.init();
      }
      
      init() {
        document.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: true });
        document.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
        document.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: true });
        document.addEventListener('mousedown', this.handleMouseDown.bind(this));
        document.addEventListener('mousemove', this.handleMouseMove.bind(this));
        document.addEventListener('mouseup', this.handleMouseUp.bind(this));
        document.addEventListener('mouseleave', this.handleMouseLeave.bind(this));
        
        this.observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
              if (node.nodeType === 1) {
                if (node.classList && node.classList.contains('slider-container')) {
                  this.registerSlider(node);
                }
                if (node.querySelectorAll) {
                  node.querySelectorAll?.('.slider-container').forEach(container => {
                    this.registerSlider(container);
                  });
                }
              }
            });
          });
        });
        this.observer.observe(document.body, { childList: true, subtree: true });
        document.querySelectorAll('.slider-container').forEach(container => {
          this.registerSlider(container);
        });
      }
      
      registerSlider(container) {
        if (!container || this.sliders.has(container)) return;
        const track = container.querySelector('.slider-track');
        if (!track) return;
        const slides = track.children;
        if (slides.length === 0) return;
        const sliderId = `slider-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        container.dataset.sliderId = sliderId;
        this.sliders.set(container, {
          id: sliderId,
          container: container,
          track: track,
          slides: slides,
          currentIndex: 0,
          slideWidth: 0,
          isDragging: false,
          startX: 0,
          startY: 0,
          currentX: 0,
          startTransform: 0,
          totalSlides: slides.length,
          autoSlideEnabled: true,
          autoSlideInterval: 3000
        });
        this.updateSliderDimensions(container);
        this.startAutoSlide(container);
      }
      
      updateSliderDimensions(container) {
        const slider = this.sliders.get(container);
        if (!slider) return;
        slider.slideWidth = container.offsetWidth;
        slider.track.style.width = `${slider.slideWidth * slider.totalSlides}px`;
        slider.track.querySelectorAll('.slider-item').forEach(item => {
          item.style.minWidth = `${slider.slideWidth}px`;
          item.style.maxWidth = `${slider.slideWidth}px`;
        });
      }
      
      goToSlide(container, index, animate = true) {
        const slider = this.sliders.get(container);
        if (!slider) return;
        index = Math.max(0, Math.min(index, slider.totalSlides - 1));
        if (animate) {
          slider.track.style.transition = 'transform 0.3s ease';
        } else {
          slider.track.style.transition = 'none';
        }
        slider.track.style.transform = `translateX(-${index * slider.slideWidth}px)`;
        slider.currentIndex = index;
      }
      
      nextSlide(container) {
        const slider = this.sliders.get(container);
        if (!slider) return;
        this.goToSlide(container, slider.currentIndex + 1);
      }
      
      prevSlide(container) {
        const slider = this.sliders.get(container);
        if (!slider) return;
        this.goToSlide(container, slider.currentIndex - 1);
      }
      
      startAutoSlide(container) {
        const slider = this.sliders.get(container);
        if (!slider || !slider.autoSlideEnabled) return;
        this.stopAutoSlide(container);
        const intervalId = setInterval(() => {
          if (!this.isPaused && !slider.isDragging) {
            this.nextSlide(container);
          }
        }, slider.autoSlideInterval);
        this.autoSlideIntervals.set(container, intervalId);
      }
      
      stopAutoSlide(container) {
        const intervalId = this.autoSlideIntervals.get(container);
        if (intervalId) {
          clearInterval(intervalId);
          this.autoSlideIntervals.delete(container);
        }
      }
      
      pauseAll() {
        this.isPaused = true;
      }
      
      resumeAll() {
        this.isPaused = false;
      }
      
      handleTouchStart(e) {
        const container = e.target.closest('.slider-container');
        if (!container) return;
        const slider = this.sliders.get(container);
        if (!slider) return;
        this.pauseAll();
        slider.isDragging = true;
        slider.startX = e.touches[0].clientX;
        slider.startY = e.touches[0].clientY;
        slider.currentX = slider.startX;
        slider.startTransform = slider.currentIndex * slider.slideWidth;
        slider.track.style.transition = 'none';
      }
      
      handleTouchMove(e) {
        const container = e.target.closest('.slider-container');
        if (!container) return;
        const slider = this.sliders.get(container);
        if (!slider || !slider.isDragging) return;
        const currentX = e.touches[0].clientX;
        const diffX = slider.startX - currentX;
        const diffY = slider.startY - e.touches[0].clientY;
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 5) {
          e.preventDefault();
          const dragDistance = slider.startX - currentX;
          const newTransform = -slider.startTransform - dragDistance;
          const maxDrag = slider.slideWidth * 0.2;
          const minTransform = -((slider.totalSlides - 1) * slider.slideWidth) - maxDrag;
          const maxTransform = maxDrag;
          if (newTransform >= minTransform && newTransform <= maxTransform) {
            slider.track.style.transform = `translateX(${newTransform}px)`;
            slider.currentX = currentX;
          }
        }
      }
      
      handleTouchEnd(e) {
        const container = e.target.closest('.slider-container');
        if (!container) return;
        const slider = this.sliders.get(container);
        if (!slider || !slider.isDragging) return;
        const diffX = slider.startX - slider.currentX;
        if (Math.abs(diffX) > 50) {
          if (diffX > 0) {
            this.nextSlide(container);
          } else {
            this.prevSlide(container);
          }
        } else {
          this.goToSlide(container, slider.currentIndex);
        }
        slider.isDragging = false;
        setTimeout(() => {
          this.resumeAll();
        }, 3000);
      }
      
      handleMouseDown(e) {
        const container = e.target.closest('.slider-container');
        if (!container) return;
        const slider = this.sliders.get(container);
        if (!slider) return;
        e.preventDefault();
        this.pauseAll();
        slider.isDragging = true;
        slider.startX = e.clientX;
        slider.startTransform = slider.currentIndex * slider.slideWidth;
        slider.track.style.transition = 'none';
      }
      
      handleMouseMove(e) {
        const container = e.target.closest('.slider-container');
        if (!container) return;
        const slider = this.sliders.get(container);
        if (!slider || !slider.isDragging) return;
        e.preventDefault();
        const diffX = slider.startX - e.clientX;
        const newTransform = -slider.startTransform - diffX;
        const maxDrag = slider.slideWidth * 0.2;
        const minTransform = -((slider.totalSlides - 1) * slider.slideWidth) - maxDrag;
        const maxTransform = maxDrag;
        if (newTransform >= minTransform && newTransform <= maxTransform) {
          slider.track.style.transform = `translateX(${newTransform}px)`;
          slider.currentX = e.clientX;
        }
      }
      
      handleMouseUp(e) {
        const container = e.target.closest('.slider-container');
        if (!container) return;
        const slider = this.sliders.get(container);
        if (!slider || !slider.isDragging) return;
        const diffX = slider.startX - e.clientX;
        if (Math.abs(diffX) > 50) {
          if (diffX > 0) {
            this.nextSlide(container);
          } else {
            this.prevSlide(container);
          }
        } else {
          this.goToSlide(container, slider.currentIndex);
        }
        slider.isDragging = false;
        setTimeout(() => {
          this.resumeAll();
        }, 3000);
      }
      
      handleMouseLeave(e) {
        const container = e.target.closest('.slider-container');
        if (!container) return;
        const slider = this.sliders.get(container);
        if (slider && slider.isDragging) {
          this.goToSlide(container, slider.currentIndex);
          slider.isDragging = false;
          setTimeout(() => {
            this.resumeAll();
          }, 3000);
        }
      }
      
      destroy() {
        this.autoSlideIntervals.forEach(interval => clearInterval(interval));
        this.autoSlideIntervals.clear();
        this.sliders.clear();
        this.observer.disconnect();
      }
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function parsePrice(p) {
      if (typeof p === "number") return p;
      if (typeof p === "string") {
        const num = parseFloat(p.replace(/[‚Çπ$]/g, "").replace(/,/g, ""));
        return isNaN(num) ? 0 : num;
      }
      return 0;
    }

    function getCurrencySymbol() {
      return userCurrencyPreference || globalCurrencySymbol || '‚Çπ';
    }

    function formatPrice(price) {
      const symbol = getCurrencySymbol();
      return symbol + parsePrice(price).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
    }

    function getProductImage(product, idx = 0) {
      if (!product) return "https://via.placeholder.com/300x300/f3f4f6/64748b?text=No+Image";
      if (Array.isArray(product.images) && product.images.length > 0) {
        if (idx < product.images.length) return product.images[idx];
        return product.images[0];
      }
      const possibleImageFields = ['image', 'img', 'imageUrl', 'photo', 'thumbnail', 'picture', 'url', 'mainImage', 'productImage'];
      for (const field of possibleImageFields) {
        if (product[field]) {
          if (typeof product[field] === 'string') {
            return product[field];
          }
          if (Array.isArray(product[field]) && product[field].length > 0) {
            return product[field][0];
          }
        }
      }
      if (typeof product === 'string' && (product.startsWith('http') || product.startsWith('/') || product.startsWith('data:'))) {
        return product;
      }
      if (product.value && typeof product.value === 'string' && product.value.startsWith('http')) {
        return product.value;
      }
      return "https://via.placeholder.com/300x300/f3f4f6/64748b?text=No+Image";
    }

    function getProductImages(product) {
      if (!product) return [];
      if (Array.isArray(product.images) && product.images.length > 0) {
        return product.images;
      }
      if (product.similarFromAdmin && Array.isArray(product.similarFromAdmin)) {
        return product.similarFromAdmin;
      }
      const possibleImageArrays = ['images', 'photos', 'gallery', 'pictures'];
      for (const field of possibleImageArrays) {
        if (Array.isArray(product[field]) && product[field].length > 0) {
          return product[field];
        }
      }
      const possibleImageFields = ['image', 'img', 'imageUrl', 'photo', 'thumbnail', 'picture', 'url', 'mainImage', 'productImage'];
      for (const field of possibleImageFields) {
        if (product[field]) {
          if (typeof product[field] === 'string') {
            return [product[field]];
          }
          if (Array.isArray(product[field]) && product[field].length > 0) {
            return product[field];
          }
        }
      }
      return ["https://via.placeholder.com/300x300/f3f4f6/64748b?text=No+Image"];
    }

    function generateOrderId() {
        const date = new Date();
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        const randomNum = Math.floor(100000 + Math.random() * 900000); 
        return `ORDER-${yyyy}${mm}${dd}-${randomNum}`;
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      if (!toast) return;
      toast.textContent = message;
      toast.className = 'toast ' + type;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    (function() {
      emailjs.init("user_your_user_id_here");
    })();

    function openMenu() {
      document.getElementById('mobileMenu').classList.add('active');
      document.getElementById('menuOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      document.getElementById('mobileMenu').classList.remove('active');
      document.getElementById('menuOverlay').classList.remove('active');
      document.body.style.overflow = '';
    }

    function showCategories() {
      filterByCategory('all');
    }

    function openSearchPanel() {
      document.getElementById('searchPanel').classList.add('active');
      document.getElementById('searchPanelInput').focus();
      loadRecentSearches();
      loadPopularSearches();
      loadSearchTags();
    }

    function closeSearchPanel() {
      document.getElementById('searchPanel').classList.remove('active');
      document.getElementById('searchPanelInput').value = '';
      document.getElementById('searchSuggestions').style.display = 'none';
    }

    function performSearch(query) {
      if (!query.trim()) return;
      document.getElementById('searchPanelInput').blur();
      addToRecentSearches(query);
      const filteredProducts = products.filter(product => 
        product.name?.toLowerCase().includes(query.toLowerCase()) ||
        product.description?.toLowerCase().includes(query.toLowerCase()) ||
        product.category?.toLowerCase().includes(query.toLowerCase()) ||
        (product.tags && product.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase())))
      );
      window.currentSearchQuery = query;
      window.currentSearchResults = filteredProducts;
      showPage('searchResultsPage');
      renderSearchResults(filteredProducts, query);
      closeSearchPanel();
    }

    function handleSearchPanelInput(e) {
      const query = e.target.value.trim();
      const suggestionsContainer = document.getElementById('searchSuggestions');
      if (!suggestionsContainer) return;
      if (query.length >= 1) {
        showSearchSuggestions(query);
        suggestionsContainer.style.display = 'block';
      } else {
        clearSearchSuggestions();
        suggestionsContainer.style.display = 'none';
      }
    }

    function showSearchSuggestions(query) {
      const suggestionsContainer = document.getElementById('searchSuggestions');
      if (!suggestionsContainer) return;
      let suggestions = products.filter(product => 
        product.name?.toLowerCase().includes(query.toLowerCase()) ||
        product.description?.toLowerCase().includes(query.toLowerCase()) ||
        product.category?.toLowerCase().includes(query.toLowerCase()) ||
        (product.tags && product.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase())))
      );
      const ratingMap = {};
      suggestions.forEach(p => {
        const productReviews = reviews.filter(r => r.productId === p.id);
        if (productReviews.length) {
          const sum = productReviews.reduce((acc, r) => acc + r.rating, 0);
          ratingMap[p.id] = sum / productReviews.length;
        } else {
          ratingMap[p.id] = 0;
        }
      });
      suggestions.sort((a, b) => (ratingMap[b.id] || 0) - (ratingMap[a.id] || 0));
      const topThree = suggestions.slice(0, 3);
      suggestionsContainer.innerHTML = '';
      if (topThree.length === 0) {
        suggestionsContainer.innerHTML = '<div class="search-suggestion" style="justify-content:center;color:var(--muted)">No products found</div>';
        return;
      }
      topThree.forEach(product => {
        const suggestion = document.createElement('div');
        suggestion.className = 'search-suggestion';
        suggestion.innerHTML = `
          <div class="search-suggestion-img" style="background-image: url('${getProductImage(product)}')"></div>
          <div class="search-suggestion-info">
            <div class="search-suggestion-name">${product.name || 'Product'}</div>
            <div class="search-suggestion-price">${formatPrice(product.price)}</div>
          </div>
        `;
        suggestion.addEventListener('click', () => {
          showProductDetail(product);
          closeSearchPanel();
        });
        suggestionsContainer.appendChild(suggestion);
      });
      if (suggestions.length > 3) {
        const categorySuggestion = document.createElement('div');
        categorySuggestion.className = 'search-suggestion';
        categorySuggestion.innerHTML = `
          <div class="search-suggestion-info" style="padding-left:0;">
            <div class="search-suggestion-name" style="color:var(--accent);">View all ${suggestions.length} products in "${query}"</div>
          </div>
        `;
        categorySuggestion.addEventListener('click', () => {
          performSearch(query);
        });
        suggestionsContainer.appendChild(categorySuggestion);
      }
    }

    function clearSearchSuggestions() {
      const suggestionsContainer = document.getElementById('searchSuggestions');
      if (suggestionsContainer) {
        suggestionsContainer.innerHTML = '';
      }
    }

    function addToRecentSearches(query) {
      if (!query.trim()) return;
      recentSearches = recentSearches.filter(item => item !== query);
      recentSearches.unshift(query);
      if (recentSearches.length > 10) {
        recentSearches.pop();
      }
      localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
      loadRecentSearches();
    }

    function loadRecentSearches() {
      const container = document.getElementById('recentSearches');
      if (!container) return;
      container.innerHTML = '';
      if (recentSearches.length === 0) {
        container.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px;">No recent searches</div>';
        return;
      }
      recentSearches.forEach(search => {
        const item = document.createElement('div');
        item.className = 'recent-search-item';
        item.innerHTML = `
          <span class="recent-search-text">${search}</span>
          <button class="recent-search-remove" data-search="${search}">√ó</button>
        `;
        item.querySelector('.recent-search-text').addEventListener('click', () => {
          document.getElementById('searchPanelInput').value = search;
          performSearch(search);
        });
        item.querySelector('.recent-search-remove').addEventListener('click', (e) => {
          e.stopPropagation();
          removeFromRecentSearches(search);
        });
        container.appendChild(item);
      });
    }

    function removeFromRecentSearches(search) {
      recentSearches = recentSearches.filter(item => item !== search);
      localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
      loadRecentSearches();
    }

    function clearSearchHistory() {
      recentSearches = [];
      localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
      loadRecentSearches();
    }

    function loadPopularSearches() {
      const container = document.getElementById('popularSearches');
      if (!container) return;
      container.innerHTML = '';
      popularSearches.forEach(search => {
        const tag = document.createElement('div');
        tag.className = 'popular-search-tag';
        tag.textContent = search;
        tag.addEventListener('click', () => {
          document.getElementById('searchPanelInput').value = search;
          performSearch(search);
        });
        container.appendChild(tag);
      });
    }

    function loadSearchTags() {
      const container = document.getElementById('searchTags');
      if (!container) return;
      container.innerHTML = '';
      searchTags.forEach(tag => {
        const element = document.createElement('div');
        element.className = 'search-tag';
        element.textContent = tag;
        element.addEventListener('click', () => {
          document.getElementById('searchPanelInput').value = tag;
          performSearch(tag);
        });
        container.appendChild(element);
      });
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    }

    function showPage(pageId) {
      const newUrl = window.location.origin + window.location.pathname.replace('index.html', '') + '#' + pageId;
      window.history.pushState(null, '', newUrl);
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      const pageElement = document.getElementById(pageId);
      if (pageElement) {
        pageElement.classList.add('active');
      }
      updateBottomNav();
      updateStepPills();
      window.scrollTo(0, 0);
      switch(pageId) {
        case 'myOrdersPage':
          if (currentUser) showMyOrders();
          break;
        case 'wishlistPage':
          renderWishlist();
          break;
        case 'productDetailPage':
          if (currentProduct) {
            loadProductReviews(currentProduct.id);
            loadSimilarProducts(currentProduct);
            loadSimilarProductsSmall(currentProduct);
          }
          break;
        case 'paymentPage':
          updatePaymentSummary();
          break;
        case 'userPage':
          if (currentUser) loadSavedAddresses();
          break;
        case 'orderPage':
          if (currentProduct) initOrderPageGallery();
          break;
        case 'productsPage':
          renderProducts(products, 'productGrid');
          updateProductsCount();
          break;
        case 'homePage':
          renderProducts(products, 'homeProductGrid');
          setTimeout(setupTrendingAutoSlide, 1000);
          setTimeout(setupBannerAutoSlide, 1000);
          break;
        case 'searchResultsPage':
          if (window.currentSearchQuery) {
            document.getElementById('searchResultsInput').value = window.currentSearchQuery;
            setupSearchPriceSlider();
          }
          break;
        case 'recentlyViewedPage':
          renderRecentlyViewedPage();
          break;
      }
    }

    function renderRecentlyViewedPage() {
      const container = document.getElementById('recentlyViewedGrid');
      const empty = document.getElementById('emptyRecentlyViewed');
      if (!container || !empty) return;
      if (!currentUser) {
        container.style.display = 'none';
        empty.style.display = 'block';
        return;
      }
      const recentlyViewedProducts = products.filter(product => 
        recentlyViewed.includes(product.id)
      );
      if (recentlyViewedProducts.length === 0) {
        container.style.display = 'none';
        empty.style.display = 'block';
        return;
      }
      container.style.display = 'grid';
      empty.style.display = 'none';
      renderProducts(recentlyViewedProducts, 'recentlyViewedGrid');
    }

    function checkAuthAndShowPage(pageId) {
      if (!currentUser && (pageId === 'myOrdersPage' || pageId === 'wishlistPage' || pageId === 'accountPage')) {
        showLoginModal();
        return;
      }
      if (pageId === 'accountPage') {
        window.location.href = 'account.html';
        return;
      }
      showPage(pageId);
    }

    function checkAuthAndShowAccount() {
      if (!currentUser) {
        showLoginModal();
        return;
      }
      window.location.href = 'account.html';
    }

    function checkAuthAndShowRecentlyViewed() {
      if (!currentUser) {
        showLoginModal();
        return;
      }
      showPage('recentlyViewedPage');
    }

    function updateBottomNav() {
      const currentPage = document.querySelector('.page.active').id;
      document.querySelectorAll('.bottom-nav-item').forEach(item => {
        item.classList.remove('active');
      });
      switch(currentPage) {
        case 'homePage':
          document.querySelector('.bottom-nav-item:nth-child(1)')?.classList.add('active');
          break;
        case 'productsPage':
        case 'productDetailPage':
        case 'searchResultsPage':
          document.querySelector('.bottom-nav-item:nth-child(2)')?.classList.add('active');
          break;
        case 'myOrdersPage':
        case 'orderDetailPage':
          document.querySelector('.bottom-nav-item:nth-child(3)')?.classList.add('active');
          break;
        default:
          break;
      }
    }

    function updateStepPills() {
      const currentPage = document.querySelector('.page.active').id;
      document.querySelectorAll('.step-pill').forEach(pill => {
        pill.classList.remove('disabled');
      });
      switch(currentPage) {
        case 'homePage':
        case 'productsPage':
        case 'productDetailPage':
        case 'searchResultsPage':
          document.getElementById('pill-order')?.classList.add('disabled');
          document.getElementById('pill-user')?.classList.add('disabled');
          document.getElementById('pill-pay')?.classList.add('disabled');
          break;
        case 'orderPage':
          document.getElementById('pill-user')?.classList.add('disabled');
          document.getElementById('pill-pay')?.classList.add('disabled');
          break;
        case 'userPage':
          document.getElementById('pill-pay')?.classList.add('disabled');
          break;
      }
    }

    function renderSearchResults(results, query) {
      const grid = document.getElementById('searchResultsGrid');
      const count = document.getElementById('searchResultsCount');
      const noResults = document.getElementById('noSearchResultsMessage');
      if (!grid) return;
      if (results.length === 0) {
        grid.innerHTML = '';
        noResults.style.display = 'block';
        count.textContent = 'No products found';
        return;
      }
      noResults.style.display = 'none';
      count.textContent = `${results.length} products found for "${query}"`;
      renderProducts(results, 'searchResultsGrid');
    }

    function setupSearchPriceSlider() {
      const minThumb = document.getElementById('searchPriceMinThumb');
      const maxThumb = document.getElementById('searchPriceMaxThumb');
      const track = document.getElementById('searchPriceSliderTrack');
      const range = document.getElementById('searchPriceSliderRange');
      const minInput = document.getElementById('searchMinPrice');
      const maxInput = document.getElementById('searchMaxPrice');
      if (minThumb && maxThumb && track) {
        let minPercent = 0;
        let maxPercent = 100;
        const minPrice = 0;
        const maxPrice = 10000;
        function updateSlider() {
          minThumb.style.left = minPercent + '%';
          maxThumb.style.left = maxPercent + '%';
          range.style.left = minPercent + '%';
          range.style.width = (maxPercent - minPercent) + '%';
          const minValue = Math.round(minPrice + (minPercent / 100) * (maxPrice - minPrice));
          const maxValue = Math.round(minPrice + (maxPercent / 100) * (maxPrice - minPrice));
          minInput.value = minValue;
          maxInput.value = maxValue;
        }
        function onThumbMove(thumb, isMin) {
          return function(e) {
            e.preventDefault();
            const trackRect = track.getBoundingClientRect();
            let percent;
            if (e.type === 'touchmove') {
              percent = ((e.touches[0].clientX - trackRect.left) / trackRect.width) * 100;
            } else {
              percent = ((e.clientX - trackRect.left) / trackRect.width) * 100;
            }
            percent = Math.max(0, Math.min(100, percent));
            if (isMin) {
              if (percent < maxPercent - 5) {
                minPercent = percent;
              }
            } else {
              if (percent > minPercent + 5) {
                maxPercent = percent;
              }
            }
            updateSlider();
          };
        }
        function onThumbUp() {
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onThumbUp);
          document.removeEventListener('touchmove', onTouchMove);
          document.removeEventListener('touchend', onThumbUp);
        }
        let onMouseMove, onTouchMove;
        function onThumbDown(isMin) {
          return function(e) {
            e.preventDefault();
            if (isMin) {
              onMouseMove = onThumbMove(minThumb, true);
              onTouchMove = onThumbMove(minThumb, true);
            } else {
              onMouseMove = onThumbMove(maxThumb, false);
              onTouchMove = onThumbMove(maxThumb, false);
            }
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onThumbUp);
            document.addEventListener('touchmove', onTouchMove);
            document.addEventListener('touchend', onThumbUp);
          };
        }
        minThumb.addEventListener('mousedown', onThumbDown(true));
        maxThumb.addEventListener('mousedown', onThumbDown(false));
        minThumb.addEventListener('touchstart', onThumbDown(true));
        maxThumb.addEventListener('touchstart', onThumbDown(false));
        minInput.addEventListener('input', function() {
          const value = parseInt(this.value) || 0;
          minPercent = ((value - minPrice) / (maxPrice - minPrice)) * 100;
          if (minPercent >= maxPercent - 5) minPercent = maxPercent - 5;
          updateSlider();
        });
        maxInput.addEventListener('input', function() {
          const value = parseInt(this.value) || maxPrice;
          maxPercent = ((value - minPrice) / (maxPrice - minPrice)) * 100;
          if (maxPercent <= minPercent + 5) maxPercent = minPercent + 5;
          updateSlider();
        });
        updateSlider();
      }
    }

    function applySearchPriceFilter() {
      const minPrice = parseFloat(document.getElementById('searchMinPrice').value) || 0;
      const maxPrice = parseFloat(document.getElementById('searchMaxPrice').value) || 10000;
      const filteredResults = window.currentSearchResults.filter(product => {
        const price = parsePrice(product.price);
        return price >= minPrice && price <= maxPrice;
      });
      renderSearchResults(filteredResults, window.currentSearchQuery);
    }

    function resetSearchPriceFilter() {
      document.getElementById('searchMinPrice').value = '0';
      document.getElementById('searchMaxPrice').value = '10000';
      const minThumb = document.getElementById('searchPriceMinThumb');
      const maxThumb = document.getElementById('searchPriceMaxThumb');
      const range = document.getElementById('searchPriceSliderRange');
      if (minThumb && maxThumb && range) {
        minThumb.style.left = '0%';
        maxThumb.style.left = '100%';
        range.style.left = '0%';
        range.style.width = '100%';
      }
      renderSearchResults(window.currentSearchResults, window.currentSearchQuery);
    }

    let reviews = [];

    function calculateProductRating(productId) {
      const productReviews = reviews.filter(r => r.productId === productId);
      if (productReviews.length === 0) return 0;
      const sum = productReviews.reduce((acc, r) => acc + r.rating, 0);
      return sum / productReviews.length;
    }

    function createProductCard(product) {
      if (!product) {
        return document.createElement('div');
      }
      const card = document.createElement('div');
      card.className = 'product-card';
      const productId = product.id || product.productId || product._id || product.key || `product-${Date.now()}-${Math.random()}`;
      card.setAttribute('data-product-id', productId);
      const isWishlisted = isInWishlist(productId);
      const rating = calculateProductRating(productId);
      const productName = product.name || product.title || 'Product Name';
      const productPrice = formatPrice(product.price);
      const productImage = getProductImage(product);
      const productBadge = product.badge || product.tag || '';
      const isTrending = product.isTrending || product.trending || false;
      const isFeatured = product.isFeatured || product.featured || false;
      let badgeHtml = '';
      if (isFeatured) {
        badgeHtml = `<div class="professional-badge" style="background:#22c55e;">FEATURED</div>`;
      } else if (isTrending) {
        badgeHtml = `<div class="professional-badge">TRENDING</div>`;
      } else if (productBadge) {
        badgeHtml = `<div class="product-card-badge">${productBadge}</div>`;
      }
      card.innerHTML = `
        <div class="product-card-image" style="background-image: url('${productImage}')">
          ${badgeHtml}
        </div>
        <div class="product-card-body">
          <div class="product-card-title">${productName}</div>
          <div class="product-card-rating">
            <div class="product-card-stars">${generateStarRating(rating)}</div>
            <div class="product-card-review-count">(${product.reviewCount || '0'})</div>
          </div>
          <div class="product-card-price">
            <div class="product-card-current-price">${productPrice}</div>
            ${product.originalPrice ? `<div class="product-card-original-price">${formatPrice(product.originalPrice)}</div>` : ''}
          </div>
          <div class="product-card-actions">
            <button class="action-btn wishlist-btn ${isWishlisted ? 'active' : ''}" data-product-id="${productId}" title="Wishlist">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="${isWishlisted ? 'red' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
              </svg>
            </button>
            <div style="flex:1"></div>
            <button class="action-btn share-btn" data-product-id="${productId}" title="Share">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="18" cy="5" r="3"></circle>
                <circle cx="6" cy="12" r="3"></circle>
                <circle cx="18" cy="19" r="3"></circle>
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
              </svg>
            </button>
          </div>
        </div>
      `;
      if (!product.id) {
        product.id = productId;
      }
      card.addEventListener('click', (e) => {
        if (e.target.closest('.wishlist-btn') || e.target.closest('.share-btn')) {
          return;
        }
        e.preventDefault();
        e.stopPropagation();
        showProductDetail(product);
      });
      const wishlistBtn = card.querySelector('.wishlist-btn');
      wishlistBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleWishlist(productId);
      });
      const shareBtn = card.querySelector('.share-btn');
      shareBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        shareProduct(product);
      });
      return card;
    }

    function generateStarRating(rating) {
      const fullStars = Math.floor(rating);
      const halfStar = rating % 1 >= 0.5;
      const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
      let stars = '';
      for (let i = 0; i < fullStars; i++) stars += '‚òÖ';
      if (halfStar) stars += '¬Ω';
      for (let i = 0; i < emptyStars; i++) stars += '‚òÜ';
      return stars;
    }

    function shareProduct(product) {
      const productId = product.id || product.productId || product._id;
      const shareLink = window.location.origin + window.location.pathname.replace('index.html', '') + '#productDetailPage?product=' + productId;
      if (navigator.share) {
        navigator.share({
          title: product.name || product.title,
          text: `Check out ${product.name || product.title} on Buyzo Cart`,
          url: shareLink,
        })
        .then(() => {})
        .catch((error) => {});
      } else {
        navigator.clipboard.writeText(shareLink)
          .then(() => showToast('Link copied to clipboard!', 'success'))
          .catch(err => {
            showToast('Failed to copy link', 'error');
          });
      }
    }

    function showProductDetail(product) {
      if (!product) {
        showToast('Product not found', 'error');
        return;
      }
      const productId = product.id || product.productId || product._id || product.key;
      if (!productId) {
        product.id = 'temp-' + Date.now();
      }
      let freshProduct = null;
      if (productId) {
        freshProduct = products.find(p => 
          p.id === productId || 
          p.productId === productId || 
          p._id === productId || 
          p.key === productId
        );
      }
      if (!freshProduct) {
        freshProduct = product;
      }
      if (!freshProduct.id && productId) {
        freshProduct.id = productId;
      } else if (!freshProduct.id) {
        freshProduct.id = 'product-' + Date.now();
      }
      currentProduct = freshProduct;
      currentProductImages = getProductImages(freshProduct);
      currentImageIndex = 0;
      const elements = {
        detailTitle: document.getElementById('detailTitle'),
        detailPrice: document.getElementById('detailPrice'),
        detailDesc: document.getElementById('detailDesc'),
        detailFullDesc: document.getElementById('detailFullDesc'),
        detailSku: document.getElementById('detailSku'),
        breadcrumbProductName: document.getElementById('breadcrumbProductName'),
        mainProductImage: document.getElementById('mainProductImage')
      };
      const productName = freshProduct.name || freshProduct.title || 'Product';
      const productPrice = formatPrice(freshProduct.price);
      const productDescription = freshProduct.description || freshProduct.desc || '';
      const productFullDesc = freshProduct.fullDescription || freshProduct.fullDesc || freshProduct.details || productDescription;
      const productSku = freshProduct.sku || freshProduct.SKU || 'N/A';
      if (elements.detailTitle) 
        elements.detailTitle.textContent = productName;
      if (elements.detailPrice) 
        elements.detailPrice.textContent = productPrice;
      if (elements.detailDesc) 
        elements.detailDesc.textContent = productDescription;
      if (elements.detailFullDesc) 
        elements.detailFullDesc.textContent = productFullDesc;
      if (elements.detailSku) 
        elements.detailSku.textContent = 'SKU: ' + productSku;
      if (elements.breadcrumbProductName) 
        elements.breadcrumbProductName.textContent = productName;
      if (elements.mainProductImage && currentProductImages.length > 0) {
        elements.mainProductImage.style.backgroundImage = `url('${currentProductImages[0]}')`;
      }
      const stockStatus = document.getElementById('detailStockStatus');
      const orderBtn = document.getElementById('detailOrderBtn');
      if (stockStatus) {
        const quantity = freshProduct.quantity || freshProduct.stock || freshProduct.inventory || 0;
        if (quantity > 0) {
          stockStatus.textContent = 'In Stock';
          stockStatus.className = 'stock-status in-stock';
          if (orderBtn) orderBtn.disabled = false;
        } else {
          stockStatus.textContent = 'Out of Stock';
          stockStatus.className = 'stock-status out-of-stock';
          if (orderBtn) orderBtn.disabled = true;
        }
      }
      const shareLink = document.getElementById('productShareLink');
      if (shareLink) {
        const url = window.location.origin + window.location.pathname + '#productDetailPage?product=' + freshProduct.id;
        shareLink.value = url;
      }
      const wishlistBtn = document.getElementById('detailWishlistBtn');
      if (wishlistBtn) {
        if (isInWishlist(freshProduct.id)) {
          wishlistBtn.textContent = 'Remove from Wishlist';
          wishlistBtn.classList.add('active');
        } else {
          wishlistBtn.textContent = 'Add to Wishlist';
          wishlistBtn.classList.remove('active');
        }
      }
      initProductDetailGallery(freshProduct);
      loadSimilarProducts(freshProduct);
      loadSimilarProductsSmall(freshProduct);
      loadProductReviews(freshProduct.id);
      if (currentUser) {
        addToRecentlyViewed(freshProduct.id);
      }
      showPage('productDetailPage');
      window.scrollTo(0, 0);
      updateProductSchema(freshProduct);
    }

    function updateProductSchema(product) {
      if (!product) return;
      const productSchema = {
        "@context": "https://schema.org",
        "@type": "Product",
        "name": product.name || product.title,
        "description": product.description || product.desc || '',
        "image": getProductImage(product),
        "sku": product.sku || product.id,
        "mpn": product.mpn || product.id,
        "brand": {
          "@type": "Brand",
          "name": product.brand || "Buyzo Cart"
        },
        "offers": {
          "@type": "Offer",
          "url": window.location.href,
          "priceCurrency": "INR",
          "price": parsePrice(product.price),
          "priceValidUntil": new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0],
          "itemCondition": "https://schema.org/NewCondition",
          "availability": (product.quantity || product.stock) > 0 ? 
            "https://schema.org/InStock" : "https://schema.org/OutOfStock"
        }
      };
      const productReviews = reviews.filter(r => r.productId === product.id);
      if (productReviews.length > 0) {
        const sum = productReviews.reduce((acc, r) => acc + r.rating, 0);
        const avgRating = sum / productReviews.length;
        productSchema.aggregateRating = {
          "@type": "AggregateRating",
          "ratingValue": avgRating.toFixed(1),
          "reviewCount": productReviews.length
        };
        productSchema.review = productReviews.slice(0, 5).map(r => ({
          "@type": "Review",
          "reviewRating": {
            "@type": "Rating",
            "ratingValue": r.rating
          },
          "author": {
            "@type": "Person",
            "name": r.userName
          },
          "reviewBody": r.text,
          "datePublished": new Date(r.date).toISOString().split('T')[0]
        }));
      }
      const existingScript = document.getElementById('product-schema');
      if (existingScript) existingScript.remove();
      const script = document.createElement('script');
      script.id = 'product-schema';
      script.type = 'application/ld+json';
      script.textContent = JSON.stringify(productSchema);
      document.head.appendChild(script);
    }

    function initProductDetailGallery(product) {
      const mainImage = document.getElementById('mainProductImage');
      const dotsContainer = document.getElementById('detailCarouselDots');
      const zoomBtn = document.getElementById('imageZoomBtn');
      if (!mainImage || !dotsContainer) return;
      currentProductImages = getProductImages(product);
      if (currentProductImages.length === 0) {
        currentProductImages = [getProductImage(product)];
      }
      currentImageIndex = 0;
      function updateMainImage() {
        if (currentProductImages[currentImageIndex]) {
          mainImage.style.backgroundImage = `url('${currentProductImages[currentImageIndex]}')`;
        }
      }
      function updateDots() {
        document.querySelectorAll('.detail-carousel-dot').forEach((dot, index) => {
          dot.classList.toggle('active', index === currentImageIndex);
        });
      }
      updateMainImage();
      dotsContainer.innerHTML = '';
      currentProductImages.forEach((_, index) => {
        const dot = document.createElement('div');
        dot.className = `detail-carousel-dot ${index === 0 ? 'active' : ''}`;
        dot.addEventListener('click', () => {
          pauseSlide();
          currentImageIndex = index;
          updateMainImage();
          updateDots();
          resumeSlideAfterDelay();
        });
        dotsContainer.appendChild(dot);
      });
      if (zoomBtn) {
        zoomBtn.replaceWith(zoomBtn.cloneNode(true));
        const newZoomBtn = document.getElementById('imageZoomBtn');
        newZoomBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          pauseSlide();
          openProductImageModal();
          resumeSlideAfterDelay();
        });
      }
      let touchStartX = 0;
      let touchStartY = 0;
      let touchEndX = 0;
      let touchEndY = 0;
      let isDragging = false;
      let isHorizontalSwipe = false;
      mainImage.addEventListener('touchstart', (e) => {
        pauseSlide();
        touchStartX = e.touches[0].screenX;
        touchStartY = e.touches[0].screenY;
        touchEndX = touchStartX;
        touchEndY = touchStartY;
        isDragging = true;
        isHorizontalSwipe = false;
        mainImage.style.transition = 'none';
      }, { passive: true });
      mainImage.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        const currentX = e.touches[0].screenX;
        const currentY = e.touches[0].screenY;
        const diffX = touchStartX - currentX;
        const diffY = touchStartY - currentY;
        if (!isHorizontalSwipe && Math.abs(diffX) > Math.abs(diffY)) {
          isHorizontalSwipe = true;
        }
        if (isHorizontalSwipe && Math.abs(diffX) > 10) {
          e.preventDefault();
          mainImage.style.transform = `translateX(${-diffX * 0.3}px)`;
          touchEndX = currentX;
        } else {
          touchEndX = touchStartX;
        }
        touchEndY = currentY;
      }, { passive: false });
      mainImage.addEventListener('touchend', (e) => {
        if (!isDragging) return;
        mainImage.style.transform = '';
        mainImage.style.transition = '';
        const diffX = touchStartX - touchEndX;
        const diffY = touchStartY - touchEndY;
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
          if (diffX > 0) {
            nextDetailImage();
          } else {
            prevDetailImage();
          }
        }
        isDragging = false;
        isHorizontalSwipe = false;
        resumeSlideAfterDelay();
      }, { passive: true });
      mainImage.addEventListener('mousedown', (e) => {
        pauseSlide();
        touchStartX = e.clientX;
        touchStartY = e.clientY;
        isDragging = true;
        isHorizontalSwipe = false;
        mainImage.style.transition = 'none';
      });
      mainImage.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const diffX = touchStartX - e.clientX;
        const diffY = touchStartY - e.clientY;
        if (!isHorizontalSwipe && Math.abs(diffX) > Math.abs(diffY)) {
          isHorizontalSwipe = true;
        }
        if (isHorizontalSwipe && Math.abs(diffX) > 10) {
          e.preventDefault();
          mainImage.style.transform = `translateX(${-diffX * 0.3}px)`;
          touchEndX = e.clientX;
        }
      });
      mainImage.addEventListener('mouseup', (e) => {
        if (!isDragging) return;
        mainImage.style.transform = '';
        mainImage.style.transition = '';
        const diffX = touchStartX - e.clientX;
        const diffY = touchStartY - e.clientY;
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 30) {
          if (diffX > 0) {
            nextDetailImage();
          } else {
            prevDetailImage();
          }
        }
        isDragging = false;
        isHorizontalSwipe = false;
        resumeSlideAfterDelay();
      });
      mainImage.addEventListener('mouseleave', () => {
        if (isDragging) {
          mainImage.style.transform = '';
          mainImage.style.transition = '';
          resumeSlideAfterDelay();
          isDragging = false;
          isHorizontalSwipe = false;
        }
      });
      startAutoSlide();
    }

    function startAutoSlide() {
      if (autoSlideInterval) clearInterval(autoSlideInterval);
      autoSlideInterval = setInterval(() => {
        if (!slidePaused && currentProductImages && currentProductImages.length > 1) {
          nextDetailImage();
        }
      }, 3000);
    }

    function pauseSlide() {
      slidePaused = true;
    }

    function resumeSlideAfterDelay() {
      setTimeout(() => {
        slidePaused = false;
      }, 3000);
    }

    function prevDetailImage() {
      if (!currentProductImages || currentProductImages.length <= 1) return;
      currentImageIndex = (currentImageIndex - 1 + currentProductImages.length) % currentProductImages.length;
      updateDetailImage();
    }

    function nextDetailImage() {
      if (!currentProductImages || currentProductImages.length <= 1) return;
      currentImageIndex = (currentImageIndex + 1) % currentProductImages.length;
      updateDetailImage();
    }

    function updateDetailImage() {
      const mainImage = document.getElementById('mainProductImage');
      if (mainImage && currentProductImages[currentImageIndex]) {
        mainImage.style.backgroundImage = `url('${currentProductImages[currentImageIndex]}')`;
      }
      document.querySelectorAll('.detail-carousel-dot').forEach((dot, index) => {
        dot.classList.toggle('active', index === currentImageIndex);
      });
    }

    function openProductImageModal() {
      if (!currentProduct) return;
      currentProductModalIndex = currentImageIndex;
      updateProductModalImage();
      document.getElementById('productImageModal').classList.add('active');
      const modalImage = document.getElementById('productImageModalImage');
      modalImage.removeEventListener('touchstart', handleModalTouchStart);
      modalImage.removeEventListener('touchmove', handleModalTouchMove);
      modalImage.removeEventListener('touchend', handleModalTouchEnd);
      modalImage.addEventListener('touchstart', handleModalTouchStart, { passive: true });
      modalImage.addEventListener('touchmove', handleModalTouchMove, { passive: false });
      modalImage.addEventListener('touchend', handleModalTouchEnd, { passive: true });
    }
    
    let modalTouchStartX = 0;
    let modalTouchEndX = 0;
    
    function handleModalTouchStart(e) {
      modalTouchStartX = e.touches[0].screenX;
    }
    
    function handleModalTouchMove(e) {
      if (Math.abs(modalTouchStartX - e.touches[0].screenX) > 10) {
        e.preventDefault();
      }
      modalTouchEndX = e.touches[0].screenX;
    }
    
    function handleModalTouchEnd(e) {
      const diff = modalTouchStartX - modalTouchEndX;
      const minSwipeDistance = 50;
      if (Math.abs(diff) > minSwipeDistance) {
        if (diff > 0) {
          nextProductModalImage();
        } else {
          prevProductModalImage();
        }
      }
      modalTouchStartX = 0;
      modalTouchEndX = 0;
    }

    function updateProductModalImage() {
      const modalImage = document.getElementById('productImageModalImage');
      const dotsContainer = document.getElementById('productImageModalDots');
      if (!modalImage || !dotsContainer) return;
      modalImage.src = currentProductImages[currentProductModalIndex];
      dotsContainer.innerHTML = '';
      currentProductImages.forEach((_, index) => {
        const dot = document.createElement('div');
        dot.className = `product-image-modal-dot ${index === currentProductModalIndex ? 'active' : ''}`;
        dot.addEventListener('click', () => {
          currentProductModalIndex = index;
          updateProductModalImage();
        });
        dotsContainer.appendChild(dot);
      });
    }

    function prevProductModalImage() {
      if (currentProductImages.length <= 1) return;
      currentProductModalIndex = (currentProductModalIndex - 1 + currentProductImages.length) % currentProductImages.length;
      updateProductModalImage();
    }

    function nextProductModalImage() {
      if (currentProductImages.length <= 1) return;
      currentProductModalIndex = (currentProductModalIndex + 1) % currentProductImages.length;
      updateProductModalImage();
    }

    function loadSimilarProducts(product) {
      let similarProducts = products
        .filter(p => p.id !== product.id && p.category === product.category)
        .slice(0, 20);
      const ratingMap = {};
      similarProducts.forEach(p => {
        const productReviews = reviews.filter(r => r.productId === p.id);
        if (productReviews.length) {
          const sum = productReviews.reduce((acc, r) => acc + r.rating, 0);
          ratingMap[p.id] = sum / productReviews.length;
        } else {
          ratingMap[p.id] = 0;
        }
      });
      similarProducts.sort((a, b) => (ratingMap[b.id] || 0) - (ratingMap[a.id] || 0));
      const firstRow = similarProducts.slice(0, 10);
      const secondRow = similarProducts.slice(10, 20);
      const container = document.getElementById('similarProductsSlider');
      if (!container) return;
      container.innerHTML = '';
      const fragment = document.createDocumentFragment();
      const rowDiv = document.createElement('div');
      rowDiv.style.display = 'flex';
      rowDiv.style.flexDirection = 'column';
      rowDiv.style.gap = '20px';
      rowDiv.style.width = '100%';
      const row1Div = document.createElement('div');
      row1Div.style.display = 'flex';
      row1Div.style.overflowX = 'auto';
      row1Div.style.gap = '15px';
      row1Div.style.paddingBottom = '10px';
      row1Div.style.scrollbarWidth = 'none';
      row1Div.style.msOverflowStyle = 'none';
      row1Div.className = 'slider-track';
      const row2Div = document.createElement('div');
      row2Div.style.display = 'flex';
      row2Div.style.overflowX = 'auto';
      row2Div.style.gap = '15px';
      row2Div.style.paddingBottom = '10px';
      row2Div.style.scrollbarWidth = 'none';
      row2Div.style.msOverflowStyle = 'none';
      row2Div.className = 'slider-track';
      firstRow.forEach(p => {
        const sliderItem = document.createElement('div');
        sliderItem.className = 'slider-item';
        sliderItem.style.minWidth = '200px';
        sliderItem.style.maxWidth = '200px';
        sliderItem.innerHTML = `
          <div class="slider-item-img" style="background-image: url('${getProductImage(p)}'); height: 150px; background-size: cover; background-position: center;"></div>
          <div class="slider-item-body">
            <div class="slider-item-title">${p.name || p.title || 'Product'}</div>
            <div class="slider-item-price">${formatPrice(p.price)}</div>
          </div>
        `;
        sliderItem.addEventListener('click', () => showProductDetail(p));
        row1Div.appendChild(sliderItem);
      });
      secondRow.forEach(p => {
        const sliderItem = document.createElement('div');
        sliderItem.className = 'slider-item';
        sliderItem.style.minWidth = '200px';
        sliderItem.style.maxWidth = '200px';
        sliderItem.innerHTML = `
          <div class="slider-item-img" style="background-image: url('${getProductImage(p)}'); height: 150px; background-size: cover; background-position: center;"></div>
          <div class="slider-item-body">
            <div class="slider-item-title">${p.name || p.title || 'Product'}</div>
            <div class="slider-item-price">${formatPrice(p.price)}</div>
          </div>
        `;
        sliderItem.addEventListener('click', () => showProductDetail(p));
        row2Div.appendChild(sliderItem);
      });
      if (firstRow.length > 0) rowDiv.appendChild(row1Div);
      if (secondRow.length > 0) rowDiv.appendChild(row2Div);
      if (firstRow.length === 0 && secondRow.length === 0) {
        rowDiv.innerHTML = '<p style="color:var(--muted);text-align:center;padding:20px;">No similar products found</p>';
      }
      container.appendChild(rowDiv);
    }

    function loadSimilarProductsSmall(product) {
      const container = document.getElementById('similarProductsSmallSlider');
      if (!container) return;
      let similarProducts = [];
      if (product.similarFromAdmin && Array.isArray(product.similarFromAdmin) && product.similarFromAdmin.length > 0) {
        similarProducts = product.similarFromAdmin.map(id => products.find(p => p.id === id)).filter(p => p);
      }
      if (similarProducts.length === 0) {
        similarProducts = products
          .filter(p => p.id !== product.id && p.category === product.category)
          .slice(0, 6);
        const ratingMap = {};
        similarProducts.forEach(p => {
          const productReviews = reviews.filter(r => r.productId === p.id);
          if (productReviews.length) {
            const sum = productReviews.reduce((acc, r) => acc + r.rating, 0);
            ratingMap[p.id] = sum / productReviews.length;
          } else {
            ratingMap[p.id] = 0;
          }
        });
        similarProducts.sort((a, b) => (ratingMap[b.id] || 0) - (ratingMap[a.id] || 0));
      }
      if (similarProducts.length === 0) {
        container.innerHTML = '<p style="color:var(--muted);text-align:center;padding:20px;">No similar products found</p>';
        return;
      }
      const fragment = document.createDocumentFragment();
      similarProducts.slice(0, 6).forEach(simProduct => {
        const item = document.createElement('div');
        item.className = 'similar-product-small';
        item.innerHTML = `
          <div class="similar-product-small-img" style="background-image: url('${getProductImage(simProduct)}')"></div>
          <div class="similar-product-small-info">
            <div class="similar-product-small-title">${(simProduct.name || simProduct.title || '').length > 20 ? (simProduct.name || simProduct.title || '').substring(0, 20) + '...' : (simProduct.name || simProduct.title || 'Product')}</div>
            <div class="similar-product-small-price">${formatPrice(simProduct.price)}</div>
          </div>
        `;
        item.addEventListener('click', () => showProductDetail(simProduct));
        fragment.appendChild(item);
      });
      container.innerHTML = '';
      container.appendChild(fragment);
    }

    function renderProductSlider(productsToRender, containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = '';
      const sliderContainer = document.createElement('div');
      sliderContainer.className = 'slider-container';
      const sliderTrack = document.createElement('div');
      sliderTrack.className = 'slider-track';
      productsToRender.forEach(product => {
        const sliderItem = document.createElement('div');
        sliderItem.className = 'slider-item';
        sliderItem.innerHTML = `
          <div class="slider-item-img" style="background-image: url('${getProductImage(product)}')"></div>
          <div class="slider-item-body">
            <div class="slider-item-title">${product.name || product.title || 'Product Name'}</div>
            <div class="slider-item-price">${formatPrice(product.price)}</div>
          </div>
        `;
        sliderItem.addEventListener('click', () => showProductDetail(product));
        sliderTrack.appendChild(sliderItem);
      });
      sliderContainer.appendChild(sliderTrack);
      container.appendChild(sliderContainer);
      if (window.sliderController) {
        setTimeout(() => {
          window.sliderController.registerSlider(sliderContainer);
        }, 100);
      }
    }

    function isInWishlist(productId) {
      let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
      return wishlist.includes(productId);
    }

    function toggleWishlist(productId) {
      let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
      const isWishlisted = wishlist.includes(productId);
      if (isWishlisted) {
        wishlist = wishlist.filter(id => id !== productId);
        showToast('Removed from wishlist', 'success');
      } else {
        wishlist.push(productId);
        showToast('Added to wishlist', 'success');
      }
      localStorage.setItem('wishlist', JSON.stringify(wishlist));
      updateWishlistButtons();
      if (document.getElementById('wishlistPage')?.classList.contains('active')) {
        renderWishlist();
      }
    }

    function toggleWishlistFromDetail() {
      if (!currentProduct) return;
      toggleWishlist(currentProduct.id);
      const wishlistBtn = document.getElementById('detailWishlistBtn');
      if (isInWishlist(currentProduct.id)) {
        wishlistBtn.textContent = 'Remove from Wishlist';
        wishlistBtn.classList.add('active');
      } else {
        wishlistBtn.textContent = 'Add to Wishlist';
        wishlistBtn.classList.remove('active');
      }
    }

    function updateWishlistButtons() {
      document.querySelectorAll('.wishlist-btn').forEach(btn => {
        const productId = btn.getAttribute('data-product-id');
        if (productId) {
          const isActive = isInWishlist(productId);
          btn.classList.toggle('active', isActive);
          const svg = btn.querySelector('svg');
          if (svg) {
            svg.setAttribute('fill', isActive ? 'red' : 'none');
          }
        }
      });
    }

    function renderWishlist() {
      const container = document.getElementById('wishlistItems');
      const empty = document.getElementById('emptyWishlist');
      if (!container || !empty) return;
      let wishlistProductIds = JSON.parse(localStorage.getItem('wishlist') || '[]');
      const wishlistProducts = products.filter(product => wishlistProductIds.includes(product.id));
      if (wishlistProducts.length === 0) {
        container.style.display = 'none';
        empty.style.display = 'block';
        return;
      }
      container.style.display = 'grid';
      container.className = 'product-grid';
      empty.style.display = 'none';
      renderProducts(wishlistProducts, 'wishlistItems');
    }

    function orderProductFromDetail() {
      if (!currentProduct) return;
      const quantity = currentProduct.quantity || currentProduct.stock || currentProduct.inventory || 0;
      if (quantity <= 0) {
        showToast('Product is out of stock', 'error');
        return;
      }
      document.getElementById('spTitle').textContent = currentProduct.name || currentProduct.title || 'Product';
      document.getElementById('spPrice').textContent = formatPrice(currentProduct.price);
      document.getElementById('spDesc').textContent = currentProduct.description || currentProduct.desc || '';
      document.getElementById('spFullDesc').textContent = currentProduct.fullDescription || currentProduct.fullDesc || currentProduct.details || currentProduct.description || '';
      const sizeOptionsContainer = document.getElementById('sizeOptions');
      sizeOptionsContainer.innerHTML = '';
      const sizesFromProduct = currentProduct.sizes || ['S', 'M', 'L', 'XL', 'XXL'];
      sizesFromProduct.forEach(sizeVal => {
        const opt = document.createElement('div');
        opt.className = 'size-option';
        opt.setAttribute('data-value', sizeVal);
        opt.textContent = sizeVal;
        opt.addEventListener('click', function() {
          document.querySelectorAll('#sizeOptions .size-option').forEach(opt => opt.classList.remove('selected'));
          this.classList.add('selected');
          document.getElementById('sizeValidationError')?.classList.remove('show');
        });
        sizeOptionsContainer.appendChild(opt);
      });
      document.getElementById('qtySelect').value = 1;
      initOrderPageGallery();
      showPage('orderPage');
    }

    function initOrderPageGallery() {
      if (!currentProduct) return;
      const galleryMain = document.getElementById('galleryMain');
      const dotsContainer = document.getElementById('orderCarouselDots');
      if (!galleryMain || !dotsContainer) return;
      const productImages = getProductImages(currentProduct);
      if (productImages.length === 0) {
        productImages.push(getProductImage(currentProduct));
      }
      galleryMain.style.backgroundImage = `url('${productImages[0]}')`;
      dotsContainer.innerHTML = '';
      productImages.forEach((_, index) => {
        const dot = document.createElement('div');
        dot.className = `carousel-dot ${index === 0 ? 'active' : ''}`;
        dot.addEventListener('click', () => {
          setOrderPageImage(index, productImages);
        });
        dotsContainer.appendChild(dot);
      });
      const prevBtn = galleryMain.querySelector('.carousel-control.prev');
      const nextBtn = galleryMain.querySelector('.carousel-control.next');
      if (prevBtn) {
        prevBtn.onclick = () => {
          const activeIndex = Array.from(dotsContainer.children).findIndex(dot => dot.classList.contains('active'));
          const newIndex = (activeIndex - 1 + productImages.length) % productImages.length;
          setOrderPageImage(newIndex, productImages);
        };
      }
      if (nextBtn) {
        nextBtn.onclick = () => {
          const activeIndex = Array.from(dotsContainer.children).findIndex(dot => dot.classList.contains('active'));
          const newIndex = (activeIndex + 1) % productImages.length;
          setOrderPageImage(newIndex, productImages);
        };
      }
    }

    function setOrderPageImage(index, productImages) {
      const galleryMain = document.getElementById('galleryMain');
      const dots = document.querySelectorAll('#orderCarouselDots .carousel-dot');
      if (galleryMain && productImages[index]) {
        galleryMain.style.backgroundImage = `url('${productImages[index]}')`;
      }
      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === index);
      });
    }

    function toUserInfo() {
      const selectedSize = document.querySelector('#sizeOptions .size-option.selected');
      if (!selectedSize) {
        document.getElementById('sizeValidationError').classList.add('show');
        showToast('Please select a size to continue', 'error');
        return;
      }
      showPage('userPage');
    }

    function toPayment() {
      const fullname = document.getElementById('fullname').value;
      const mobile = document.getElementById('mobile').value;
      const pincode = document.getElementById('pincode').value;
      const city = document.getElementById('city').value;
      const state = document.getElementById('state').value;
      const house = document.getElementById('house').value;
      if (!fullname || !mobile || !pincode || !city || !state || !house) {
        showToast('Please fill in all required fields', 'error');
        return;
      }
      userInfo = { fullName: fullname, mobile, pincode, city, state, house };
      showPage('paymentPage');
    }

    async function confirmOrder() {
      if (!currentUser) {
        showLoginModal();
        return;
      }
      if (!userInfo.fullName || !userInfo.mobile) {
        showToast('Please complete your information first', 'error');
        showPage('userPage');
        return;
      }
      if (!currentProduct) {
        showToast('No product selected', 'error');
        showPage('productsPage');
        return;
      }
      const orderId = generateOrderId();
      currentOrderId = orderId;
      const paymentMethod = document.querySelector('input[name="pay"]:checked')?.value || 'cod';
      const quantity = parseInt(document.getElementById('qtySelect')?.value) || 1;
      const size = document.querySelector('#sizeOptions .size-option.selected')?.getAttribute('data-value') || 'Not specified';
      const productPrice = parsePrice(currentProduct.price);
      const subtotal = productPrice * quantity;
      const deliveryCharge = adminSettings.deliveryCharge || 50;
      const gatewayChargePercent = adminSettings.gatewayChargePercent || 2;
      const gatewayCharge = paymentMethod === 'prepaid' ? subtotal * (gatewayChargePercent / 100) : 0;
      const total = subtotal + deliveryCharge + gatewayCharge;
      const confirmBtn = document.getElementById('confirmOrder');
      if (confirmBtn) {
        confirmBtn.innerHTML = '<div class="loading-spinner"></div> Placing Order...';
        confirmBtn.disabled = true;
      }
      try {
        const orderData = {
          orderId: orderId,
          userId: currentUser.uid,
          username: userInfo.fullName,
          userEmail: currentUser.email,
          productId: currentProduct.id,
          productName: currentProduct.name || currentProduct.title,
          productPrice: productPrice,
          quantity: quantity,
          size: size,
          subtotal: subtotal,
          deliveryCharge: deliveryCharge,
          gatewayCharge: gatewayCharge,
          totalAmount: total,
          paymentMethod: paymentMethod,
          status: 'confirmed',
          orderDate: Date.now(),
          userInfo: userInfo,
          deliveredDate: null,
          cancelledDate: null,
          tracking: {
            confirmed: Date.now(),
            shipped: null,
            delivered: null
          }
        };
        await window.firebase.set(window.firebase.ref(window.firebase.database, 'orders/' + orderId), orderData);
        const existingOrders = cacheManager.get(cacheManager.KEYS.ORDERS) || [];
        existingOrders.push(orderData);
        cacheManager.set(cacheManager.KEYS.ORDERS, existingOrders, cacheManager.TTL.ORDERS);
        sendOrderNotification(currentUser.email, orderId, currentProduct.name, total);
        document.getElementById('orderIdDisplay').textContent = orderId;
        showPage('successPage');
        showToast('Order placed successfully!', 'success');
        if (document.getElementById('myOrdersPage')?.classList.contains('active')) {
          showMyOrders();
        }
      } catch (error) {
        const offlineOrder = {
          orderId: orderId,
          userId: currentUser.uid,
          username: userInfo.fullName,
          userEmail: currentUser.email,
          productId: currentProduct.id,
          productName: currentProduct.name || currentProduct.title,
          productPrice: productPrice,
          quantity: quantity,
          size: size,
          subtotal: subtotal,
          deliveryCharge: deliveryCharge,
          gatewayCharge: gatewayCharge,
          totalAmount: total,
          paymentMethod: paymentMethod,
          status: 'confirmed',
          orderDate: Date.now(),
          userInfo: userInfo,
          isOffline: true
        };
        const existingOrders = cacheManager.get(cacheManager.KEYS.ORDERS) || [];
        existingOrders.push(offlineOrder);
        cacheManager.set(cacheManager.KEYS.ORDERS, existingOrders, cacheManager.TTL.ORDERS);
        document.getElementById('orderIdDisplay').textContent = orderId;
        showPage('successPage');
        showToast('Order saved locally. Will sync when online.', 'success');
        if (document.getElementById('myOrdersPage')?.classList.contains('active')) {
          showMyOrders();
        }
      } finally {
        if (confirmBtn) {
          confirmBtn.textContent = 'Confirm & Place Order';
          confirmBtn.disabled = false;
        }
      }
    }

    function updatePaymentSummary() {
      if (!currentProduct) {
        document.getElementById('sumProduct').textContent = '-';
        document.getElementById('sumQty').textContent = '-';
        document.getElementById('sumPrice').textContent = '-';
        document.getElementById('sumDel').textContent = `${getCurrencySymbol()}${adminSettings.deliveryCharge || 50}`;
        document.getElementById('sumGateway').textContent = `${getCurrencySymbol()}0`;
        document.getElementById('sumTotal').textContent = '-';
        return;
      }
      const quantity = parseInt(document.getElementById('qtySelect').value) || 1;
      const paymentMethod = document.querySelector('input[name="pay"]:checked').value;
      const productPrice = parsePrice(currentProduct.price);
      const subtotal = productPrice * quantity;
      const deliveryCharge = adminSettings.deliveryCharge || 50;
      const gatewayChargePercent = adminSettings.gatewayChargePercent || 2;
      const gatewayCharge = paymentMethod === 'prepaid' ? subtotal * (gatewayChargePercent / 100) : 0;
      const total = subtotal + deliveryCharge + gatewayCharge;
      document.getElementById('sumProduct').textContent = currentProduct.name || currentProduct.title || 'Product';
      document.getElementById('sumQty').textContent = quantity;
      document.getElementById('sumPrice').textContent = `${getCurrencySymbol()}${subtotal.toLocaleString()}`;
      document.getElementById('sumDel').textContent = `${getCurrencySymbol()}${deliveryCharge}`;
      document.getElementById('sumGateway').textContent = `${getCurrencySymbol()}${gatewayCharge.toFixed(2)}`;
      document.getElementById('sumTotal').textContent = `${getCurrencySymbol()}${total.toLocaleString()}`;
      const chargeNote = document.getElementById('paymentChargeNote');
      if (chargeNote) {
        chargeNote.style.display = paymentMethod === 'prepaid' ? 'block' : 'none';
      }
    }

    function decreaseQuantity() {
      const qtyInput = document.getElementById('qtySelect');
      let value = parseInt(qtyInput.value);
      if (value > 1) {
        qtyInput.value = value - 1;
      }
      if (document.getElementById('paymentPage')?.classList.contains('active')) {
        updatePaymentSummary();
      }
    }

    function increaseQuantity() {
      const qtyInput = document.getElementById('qtySelect');
      let value = parseInt(qtyInput.value);
      if (value < 3) {
        qtyInput.value = value + 1;
      } else {
        showToast('Maximum 3 units per order', 'error');
      }
      if (document.getElementById('paymentPage')?.classList.contains('active')) {
        updatePaymentSummary();
      }
    }

    function setRating(rating) {
      const stars = document.querySelectorAll('.rating-star');
      stars.forEach((star, index) => {
        if (index < rating) {
          star.classList.add('active');
        } else {
          star.classList.remove('active');
        }
      });
    }

    async function loadProductReviews(productId) {
      try {
        const snapshot = await window.firebase.get(
          window.firebase.query(
            window.firebase.ref(window.firebase.database, 'reviews'),
            window.firebase.orderByChild('productId'),
            window.firebase.equalTo(productId)
          )
        );
        const reviewsList = document.getElementById('reviewsList');
        if (!reviewsList) return;
        if (!snapshot.exists()) {
          reviewsList.innerHTML = '<p style="color:var(--muted);text-align:center">No reviews yet. Be the first to review!</p>';
          reviews = [];
          return;
        }
        const reviewsObj = snapshot.val();
        reviews = Object.keys(reviewsObj).map(key => ({
          id: key,
          ...reviewsObj[key]
        }));
        reviews.sort((a, b) => b.date - a.date);
        const topReviews = reviews.filter(r => r.rating === 5).slice(0, 8);
        renderReviews(topReviews, 'reviewsList');
      } catch (error) {
        const reviewsList = document.getElementById('reviewsList');
        if (reviewsList) {
          reviewsList.innerHTML = '<p style="color:var(--muted);text-align:center">Error loading reviews</p>';
        }
      }
    }

    function renderReviews(reviews, containerId) {
      const reviewsList = document.getElementById(containerId);
      if (!reviewsList) return;
      reviewsList.innerHTML = '';
      if (reviews.length === 0) {
        reviewsList.innerHTML = '<p style="color:var(--muted);text-align:center">No reviews yet.</p>';
        return;
      }
      reviews.forEach(review => {
        const reviewItem = document.createElement('div');
        reviewItem.className = 'review-item';
        const stars = '‚òÖ'.repeat(review.rating) + '‚òÜ'.repeat(5 - review.rating);
        const date = new Date(review.date).toLocaleDateString();
        const isVerified = review.isVerifiedPurchase ? '<span class="review-verified-badge">Verified Purchase</span>' : '';
        let fileHtml = '';
        if (review.fileUrl) {
          if (review.fileType === 'image') {
            fileHtml = `<div class="review-file-preview"><img src="${review.fileUrl}" alt="Review attachment"></div>`;
          } else if (review.fileType === 'video') {
            fileHtml = `<div class="review-file-preview"><video controls src="${review.fileUrl}"></video></div>`;
          }
        }
        reviewItem.innerHTML = `
          <div class="review-header">
            <div class="reviewer-name">${review.userName} ${isVerified}</div>
            <div class="review-date">${date}</div>
          </div>
          <div class="review-rating">${stars}</div>
          <div class="review-text">${review.text}</div>
          ${fileHtml}
          ${currentUser && (review.userId === currentUser.uid) ? 
            `<button class="review-delete-btn" data-review-id="${review.id}">Delete</button>` : ''}
          ${currentUser && (currentUser.uid === 'admin') ? 
            `<button class="review-delete-btn" data-review-id="${review.id}">Delete (Admin)</button>` : ''}
        `;
        const deleteBtn = reviewItem.querySelector('.review-delete-btn');
        if (deleteBtn) {
          deleteBtn.addEventListener('click', function() {
            deleteReview(review.id);
          });
        }
        reviewsList.appendChild(reviewItem);
      });
    }

    async function deleteReview(reviewId) {
      if (!currentUser) return;
      if (!confirm('Are you sure you want to delete this review?')) return;
      try {
        await window.firebase.remove(window.firebase.ref(window.firebase.database, 'reviews/' + reviewId));
        showToast('Review deleted successfully', 'success');
        if (currentProduct) {
          loadProductReviews(currentProduct.id);
        }
      } catch (error) {
        showToast('Failed to delete review', 'error');
      }
    }

    async function checkUserCanReview(productId) {
      if (!currentUser) return false;
      try {
        const snapshot = await window.firebase.get(
          window.firebase.query(
            window.firebase.ref(window.firebase.database, 'orders'),
            window.firebase.orderByChild('userId'),
            window.firebase.equalTo(currentUser.uid)
          )
        );
        if (!snapshot.exists()) return false;
        const ordersObj = snapshot.val();
        const userOrders = Object.keys(ordersObj).map(key => ordersObj[key]);
        return userOrders.some(order => 
          order.productId === productId && order.status === 'delivered'
        );
      } catch (error) {
        return false;
      }
    }

    async function submitProductReview() {
      if (!currentUser) {
        showLoginModal();
        return;
      }
      if (!currentProduct) {
        showToast('No product selected', 'error');
        return;
      }
      const canReview = await checkUserCanReview(currentProduct.id);
      if (!canReview) {
        document.getElementById('reviewError').textContent = 'Only customers who received this product can review.';
        document.getElementById('reviewError').style.display = 'block';
        return;
      }
      const activeStars = document.querySelectorAll('.rating-star.active');
      const rating = activeStars.length;
      const reviewTextValue = document.getElementById('reviewText').value.trim();
      if (rating === 0) {
        showToast('Please select a rating', 'error');
        return;
      }
      if (!reviewTextValue) {
        showToast('Please write a review', 'error');
        return;
      }
      const fileInput = document.getElementById('reviewFile');
      let fileUrl = null;
      let fileType = null;
      if (fileInput.files && fileInput.files[0]) {
        const file = fileInput.files[0];
        if (file.size > 5 * 1024 * 1024) {
          showToast('File size should be less than 5MB', 'error');
          return;
        }
        if (file.type.startsWith('image/')) {
          fileType = 'image';
          fileUrl = URL.createObjectURL(file);
        } else if (file.type.startsWith('video/')) {
          fileType = 'video';
          fileUrl = URL.createObjectURL(file);
        } else {
          showToast('Only image and video files are allowed', 'error');
          return;
        }
      }
      try {
        const reviewId = 'review_' + Date.now();
        const reviewData = {
          id: reviewId,
          productId: currentProduct.id,
          userId: currentUser.uid,
          userName: currentUser.displayName || 'Anonymous',
          rating: rating,
          text: reviewTextValue,
          date: Date.now(),
          isVerifiedPurchase: true,
          fileUrl: fileUrl,
          fileType: fileType
        };
        await window.firebase.set(window.firebase.ref(window.firebase.database, 'reviews/' + reviewId), reviewData);
        showToast('Review submitted successfully', 'success');
        setRating(0);
        document.getElementById('reviewText').value = '';
        document.getElementById('reviewFile').value = '';
        document.getElementById('filePreview').innerHTML = '';
        document.getElementById('reviewError').style.display = 'none';
        loadProductReviews(currentProduct.id);
      } catch (error) {
        showToast('Failed to submit review', 'error');
      }
    }

    async function showAllRatings() {
      if (!currentProduct) return;
      try {
        const snapshot = await window.firebase.get(
          window.firebase.query(
            window.firebase.ref(window.firebase.database, 'reviews'),
            window.firebase.orderByChild('productId'),
            window.firebase.equalTo(currentProduct.id)
          )
        );
        if (!snapshot.exists()) {
          document.getElementById('allRatingsList').innerHTML = '<p style="color:var(--muted);text-align:center">No reviews yet.</p>';
        } else {
          const reviewsObj = snapshot.val();
          const allReviews = Object.keys(reviewsObj).map(key => reviewsObj[key]);
          allReviews.sort((a, b) => b.date - a.date);
          renderReviews(allReviews, 'allRatingsList');
        }
        showPage('allRatingsPage');
      } catch (error) {
        showToast('Failed to load all ratings', 'error');
      }
    }

    function setupViewAllRatings() {
      const viewAllBtn = document.getElementById('viewAllRatingsBtn');
      if (viewAllBtn) {
        viewAllBtn.addEventListener('click', showAllRatings);
      }
    }

    function copyShareLink() {
      const shareLink = document.getElementById('productShareLink');
      shareLink.select();
      document.execCommand('copy');
      showToast('Link copied to clipboard', 'success');
    }

    async function showMyOrders() {
      const ordersList = document.getElementById('ordersList');
      const empty = document.getElementById('orders-empty');
      if (!ordersList || !empty) return;
      const cachedOrders = cacheManager.get(cacheManager.KEYS.ORDERS) || [];
      const userOrders = currentUser ? cachedOrders.filter(order => order.userId === currentUser.uid) : [];
      if (userOrders.length > 0) {
        renderOrders(userOrders);
        empty.style.display = 'none';
      } else {
        ordersList.innerHTML = '';
        empty.style.display = 'block';
      }
      if (!currentUser) return;
      try {
        const snapshot = await window.firebase.get(
          window.firebase.query(
            window.firebase.ref(window.firebase.database, 'orders'),
            window.firebase.orderByChild('userId'),
            window.firebase.equalTo(currentUser.uid)
          )
        );
        if (snapshot.exists()) {
          const ordersObj = snapshot.val();
          const firebaseOrders = Object.keys(ordersObj).map(key => ({
            id: key,
            ...ordersObj[key]
          }));
          firebaseOrders.sort((a, b) => b.orderDate - a.orderDate);
          const mergedOrders = [...firebaseOrders];
          userOrders.forEach(cachedOrder => {
            if (!mergedOrders.some(o => o.orderId === cachedOrder.orderId)) {
              mergedOrders.push(cachedOrder);
            }
          });
          mergedOrders.sort((a, b) => b.orderDate - a.orderDate);
          cacheManager.set(cacheManager.KEYS.ORDERS, mergedOrders, cacheManager.TTL.ORDERS);
          renderOrders(mergedOrders);
          empty.style.display = 'none';
        } else if (userOrders.length === 0) {
          empty.style.display = 'block';
        }
      } catch (error) {}
    }

    function renderOrders(orders) {
      const container = document.getElementById('ordersList');
      if (!container) return;
      container.innerHTML = '';
      orders.forEach(order => {
        const orderCard = document.createElement('div');
        orderCard.className = 'order-card';
        const statusClass = `status-${order.status}`;
        const statusText = order.status.charAt(0).toUpperCase() + order.status.slice(1);
        const orderDate = new Date(order.orderDate);
        const deliveredDate = order.deliveredDate ? new Date(order.deliveredDate) : null;
        let showReturnReplace = false;
        if (order.status === 'delivered' && deliveredDate) {
          const daysSinceDelivery = Math.floor((Date.now() - deliveredDate.getTime()) / (1000 * 60 * 60 * 24));
          if (daysSinceDelivery <= 3) {
            showReturnReplace = true;
          }
        }
        const product = products.find(p => p.id === order.productId);
        orderCard.innerHTML = `
          <div class="order-header">
            <div>
              <div class="order-id">${order.orderId}</div>
              <div class="order-date">${orderDate.toLocaleDateString()}</div>
            </div>
            <div class="order-status ${statusClass}">${statusText}</div>
          </div>
          <div class="order-details">
            <div class="order-product-image" style="background-image: url('${getProductImage(product)}')"></div>
            <div class="order-product-info">
              <div class="order-product-title">${order.productName}</div>
              <div class="order-product-price">${formatPrice(order.totalAmount)}</div>
              <div class="order-product-meta">Qty: ${order.quantity} | Size: ${order.size}</div>
            </div>
          </div>
          <div class="order-actions">
            ${order.status === 'confirmed' || order.status === 'shipped' ? 
              `<button class="order-action-btn cancel" onclick="cancelOrder('${order.id}')">Cancel Order</button>` : ''}
            ${showReturnReplace ? 
              `<button class="order-action-btn return" onclick="showReturnReplaceModal('${order.id}')">Return / Replace</button>` : ''}
          </div>
        `;
        orderCard.addEventListener('click', (e) => {
          if (e.target.tagName !== 'BUTTON') {
            const product = products.find(p => p.id === order.productId);
            if (product) {
              showProductDetail(product);
            }
          }
        });
        container.appendChild(orderCard);
      });
    }

    window.cancelOrder = function(orderId) {
      document.getElementById('cancellationModal').classList.add('active');
      document.getElementById('confirmCancel').onclick = async function() {
        const reason = document.querySelector('input[name="cancelReason"]:checked').value;
        try {
          await window.firebase.update(window.firebase.ref(window.firebase.database, 'orders/' + orderId), {
            status: 'cancelled',
            cancelledDate: Date.now(),
            cancellationReason: reason
          });
          showToast('Order cancelled successfully', 'success');
          document.getElementById('cancellationModal').classList.remove('active');
          showMyOrders();
        } catch (error) {
          showToast('Failed to cancel order', 'error');
        }
      };
    };

    window.showReturnReplaceModal = function(orderId) {
      document.getElementById('returnReplaceModal').classList.add('active');
      document.getElementById('confirmReturnReplace').onclick = async function() {
        const option = document.querySelector('input[name="returnReplaceReason"]:checked').value;
        try {
          await window.firebase.update(window.firebase.ref(window.firebase.database, 'orders/' + orderId), {
            status: option === 'return' ? 'return-requested' : 'replace-requested'
          });
          showToast(`${option === 'return' ? 'Return' : 'Replace'} request submitted`, 'success');
          document.getElementById('returnReplaceModal').classList.remove('active');
          showMyOrders();
        } catch (error) {
          showToast('Failed to submit request', 'error');
        }
      };
    };

    function showOrderDetail(order) {
      const container = document.getElementById('orderDetailContent');
      if (!container) return;
      const statusClass = `status-${order.status}`;
      const statusText = order.status.charAt(0).toUpperCase() + order.status.slice(1);
      container.innerHTML = `
        <div class="order-detail-section">
          <div class="order-detail-label">Order ID</div>
          <div class="order-detail-value">${order.orderId}</div>
        </div>
        <div class="order-detail-section">
          <div class="order-detail-label">Order Date</div>
          <div class="order-detail-value">${new Date(order.orderDate).toLocaleString()}</div>
        </div>
        <div class="order-detail-section">
          <div class="order-detail-label">Status</div>
          <div class="order-detail-value"><span class="order-status ${statusClass}">${statusText}</span></div>
        </div>
        <div class="order-detail-section">
          <div class="order-detail-label">Product</div>
          <div class="order-detail-product">
            <div class="order-detail-image" style="background-image: url('${getProductImage(products.find(p => p.id === order.productId))}')"></div>
            <div class="order-detail-product-info">
              <div style="font-weight:600;margin-bottom:8px">${order.productName}</div>
              <div style="color:var(--accent);font-weight:700;margin-bottom:8px">${formatPrice(order.productPrice)}</div>
              <div style="color:var(--muted);font-size:14px">
                Qty: ${order.quantity} | Size: ${order.size}
              </div>
            </div>
          </div>
        </div>
        <div class="order-detail-section">
          <div class="order-detail-label">Payment Details</div>
          <div class="order-detail-value">
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
              <span>Subtotal:</span>
              <span>${formatPrice(order.subtotal)}</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
              <span>Delivery:</span>
              <span>${formatPrice(order.deliveryCharge)}</span>
            </div>
            ${order.gatewayCharge > 0 ? `
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
              <span>Payment Gateway Charge:</span>
              <span>${formatPrice(order.gatewayCharge)}</span>
            </div>
            ` : ''}
            <div style="display:flex;justify-content:space-between;font-weight:700;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
              <span>Total Amount:</span>
              <span>${formatPrice(order.totalAmount)}</span>
            </div>
            <div style="margin-top:8px;color:var(--muted);font-size:14px">
              Payment Method: ${order.paymentMethod === 'prepaid' ? 'Prepaid (UPI/Card)' : 'Cash on Delivery'}
            </div>
          </div>
        </div>
        <div class="order-detail-section">
          <div class="order-detail-label">Delivery Address</div>
          <div class="order-detail-value">
            <div>${order.userInfo?.fullName || ''}</div>
            <div>${order.userInfo?.house || ''}</div>
            <div>${order.userInfo?.city || ''}, ${order.userInfo?.state || ''} - ${order.userInfo?.pincode || ''}</div>
            <div>Mobile: ${order.userInfo?.mobile || ''}</div>
          </div>
        </div>
      `;
      showPage('orderDetailPage');
    }

    async function addToRecentlyViewed(productId) {
      if (!currentUser) return;
      try {
        await window.firebase.set(window.firebase.ref(window.firebase.database, 'recentlyViewed/' + currentUser.uid + '/' + productId), Date.now());
        loadRecentlyViewed(currentUser);
      } catch (error) {}
    }

    async function loadRecentlyViewed(user) {
      try {
        const snapshot = await window.firebase.get(window.firebase.ref(window.firebase.database, 'recentlyViewed/' + user.uid));
        const recentlyViewedObj = snapshot.val();
        if (recentlyViewedObj) {
          recentlyViewed = Object.keys(recentlyViewedObj);
        } else {
          recentlyViewed = [];
        }
        if (recentlyViewed.length > 0) {
          renderRecentlyViewed();
        }
      } catch (error) {}
    }

    function renderRecentlyViewed() {
      const section = document.getElementById('recentlyViewedSection');
      const slider = document.getElementById('recentlyViewedSlider');
      if (!section || !slider) return;
      const recentlyViewedProducts = products.filter(product => 
        recentlyViewed.includes(product.id)
      ).slice(0, 10);
      if (recentlyViewedProducts.length === 0) {
        section.style.display = 'none';
        return;
      }
      section.style.display = 'block';
      renderProductSlider(recentlyViewedProducts, 'recentlyViewedSlider');
    }

    function filterByCategory(categoryId) {
      if (!categoryId || categoryId === 'all') {
        currentCategoryFilter = null;
        showPage('productsPage');
        document.querySelectorAll('.category-pill').forEach(pill => {
          pill.classList.remove('active');
          if (pill.textContent === 'All') {
            pill.classList.add('active');
          }
        });
        renderProducts(products, 'productGrid');
        updateProductsCount();
        return;
      }
      const category = categories.find(c => c.id === categoryId || c.name === categoryId);
      if (!category) return;
      currentCategoryFilter = category.id;
      let filteredProducts = products.filter(product => 
        product.category === category.id || product.category === category.name
      );
      const ratingMap = {};
      filteredProducts.forEach(p => {
        const productReviews = reviews.filter(r => r.productId === p.id);
        if (productReviews.length) {
          const sum = productReviews.reduce((acc, r) => acc + r.rating, 0);
          ratingMap[p.id] = sum / productReviews.length;
        } else {
          ratingMap[p.id] = 0;
        }
      });
      filteredProducts.sort((a, b) => (ratingMap[b.id] || 0) - (ratingMap[a.id] || 0));
      showPage('productsPage');
      document.querySelectorAll('.category-pill').forEach(pill => {
        pill.classList.remove('active');
        if (pill.textContent === category.name || pill.textContent === categoryId) {
          pill.classList.add('active');
        }
      });
      renderProducts(filteredProducts, 'productGrid');
      updateProductsCount();
    }

    function applyPriceFilter() {
      const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
      const maxPrice = parseFloat(document.getElementById('maxPrice').value) || 10000;
      let filteredProducts = products;
      if (currentCategoryFilter) {
        filteredProducts = filteredProducts.filter(product => 
          product.category === currentCategoryFilter
        );
      }
      filteredProducts = filteredProducts.filter(product => {
        const price = parsePrice(product.price);
        return price >= minPrice && price <= maxPrice;
      });
      const ratingMap = {};
      filteredProducts.forEach(p => {
        const productReviews = reviews.filter(r => r.productId === p.id);
        if (productReviews.length) {
          const sum = productReviews.reduce((acc, r) => acc + r.rating, 0);
          ratingMap[p.id] = sum / productReviews.length;
        } else {
          ratingMap[p.id] = 0;
        }
      });
      filteredProducts.sort((a, b) => (ratingMap[b.id] || 0) - (ratingMap[a.id] || 0));
      renderProducts(filteredProducts, 'productGrid');
      updateProductsCount();
    }

    function resetPriceFilter() {
      document.getElementById('minPrice').value = '0';
      document.getElementById('maxPrice').value = '10000';
      const minThumb = document.getElementById('priceMinThumb');
      const maxThumb = document.getElementById('priceMaxThumb');
      const priceSliderRange = document.getElementById('priceSliderRange');
      if (minThumb && maxThumb && priceSliderRange) {
        minThumb.style.left = '0%';
        maxThumb.style.left = '100%';
        priceSliderRange.style.left = '0%';
        priceSliderRange.style.width = '100%';
      }
      showPage('productsPage');
    }

    function resetAllFilters() {
      resetPriceFilter();
      document.querySelectorAll('.category-pill').forEach(pill => pill.classList.remove('active'));
      const allPill = Array.from(document.querySelectorAll('.category-pill')).find(p => p.textContent === 'All');
      if (allPill) allPill.classList.add('active');
      currentCategoryFilter = null;
      renderProducts(products, 'productGrid');
      updateProductsCount();
    }

    function updateProductsCount() {
      const container = document.getElementById('productGrid');
      const noProductsMessage = document.getElementById('noProductsMessage');
      const productsCount = document.getElementById('productsCount');
      if (!container || !noProductsMessage || !productsCount) return;
      const visibleProducts = container.querySelectorAll('.product-card').length;
      if (visibleProducts === 0) {
        noProductsMessage.style.display = 'block';
        productsCount.innerHTML = '';
      } else {
        noProductsMessage.style.display = 'none';
        productsCount.innerHTML = '';
      }
    }

    function renderCategories() {
      const container = document.getElementById('categoriesContainer');
      if (!container) return;
      const fragment = document.createDocumentFragment();
      const allCategory = document.createElement('div');
      allCategory.className = 'category-pill active';
      allCategory.textContent = 'All';
      allCategory.addEventListener('click', () => {
        currentCategoryFilter = null;
        document.querySelectorAll('.category-pill').forEach(pill => pill.classList.remove('active'));
        allCategory.classList.add('active');
        renderProducts(products, 'productGrid');
        updateProductsCount();
      });
      fragment.appendChild(allCategory);
      categories.forEach(category => {
        const categoryPill = document.createElement('div');
        categoryPill.className = 'category-pill';
        categoryPill.textContent = category.name || 'Category';
        categoryPill.addEventListener('click', () => filterByCategory(category.id));
        fragment.appendChild(categoryPill);
      });
      container.innerHTML = '';
      container.appendChild(fragment);
    }

    function renderCategoryCircles() {
      const container = document.getElementById('categoryCirclesContainer');
      if (!container) return;
      const fragment = document.createDocumentFragment();
      categories.forEach(category => {
        const circle = document.createElement('div');
        circle.className = 'category-circle';
        circle.innerHTML = `
          <div class="category-circle-image" style="background-image: url('${getProductImage(category)}')"></div>
          <div class="category-circle-name">${category.name || 'Category'}</div>
        `;
        circle.addEventListener('click', () => filterByCategory(category.id));
        fragment.appendChild(circle);
      });
      container.innerHTML = '';
      container.appendChild(fragment);
    }

    function renderProducts(productsToRender, containerId) {
      const container = document.getElementById(containerId);
      if (!container) {
        return;
      }
      const ratingMap = {};
      productsToRender.forEach(p => {
        const productReviews = reviews.filter(r => r.productId === p.id);
        if (productReviews.length) {
          const sum = productReviews.reduce((acc, r) => acc + r.rating, 0);
          ratingMap[p.id] = sum / productReviews.length;
        } else {
          ratingMap[p.id] = 0;
        }
      });
      const sorted = [...productsToRender].sort((a, b) => (ratingMap[b.id] || 0) - (ratingMap[a.id] || 0));
      container.innerHTML = '';
      if (!sorted || sorted.length === 0) {
        container.innerHTML = '<div class="card-panel center">No products found</div>';
        return;
      }
      const fragment = document.createDocumentFragment();
      sorted.forEach(product => {
        if (product) {
          fragment.appendChild(createProductCard(product));
        }
      });
      container.appendChild(fragment);
    }

    function renderBannerCarousel() {
      const track = document.getElementById('bannerTrack');
      const controls = document.getElementById('bannerControls');
      if (!track || !controls) return;
      const trackFragment = document.createDocumentFragment();
      const controlsFragment = document.createDocumentFragment();
      banners.forEach((banner, index) => {
        const slide = document.createElement('div');
        slide.className = 'banner-slide';
        slide.style.backgroundImage = `url('${getProductImage(banner)}')`;
        if (banner.link) {
          slide.style.cursor = 'pointer';
          slide.addEventListener('click', () => {
            window.open(banner.link, '_blank');
          });
        }
        trackFragment.appendChild(slide);
        const dot = document.createElement('div');
        dot.className = `banner-dot ${index === 0 ? 'active' : ''}`;
        dot.addEventListener('click', () => setBannerSlide(index));
        controlsFragment.appendChild(dot);
      });
      track.innerHTML = '';
      controls.innerHTML = '';
      track.appendChild(trackFragment);
      controls.appendChild(controlsFragment);
      document.getElementById('bannerCarousel')?.classList.remove('skeleton');
      setupBannerAutoSlide();
      setupBannerTouchEvents();
    }

    function setBannerSlide(index) {
      const track = document.getElementById('bannerTrack');
      const dots = document.querySelectorAll('.banner-dot');
      if (!track || !dots.length) return;
      index = Math.max(0, Math.min(index, banners.length - 1));
      track.style.transition = 'transform 0.3s ease';
      track.style.transform = `translateX(-${index * 100}%)`;
      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === index);
      });
    }

    function setupBannerAutoSlide() {
      if (banners.length <= 1) return;
      let currentBannerIndex = 0;
      if (bannerAutoSlideInterval) clearInterval(bannerAutoSlideInterval);
      bannerAutoSlideInterval = setInterval(() => {
        if (!slidePaused) {
          currentBannerIndex = (currentBannerIndex + 1) % banners.length;
          setBannerSlide(currentBannerIndex);
        }
      }, 3000);
    }

    function setupBannerTouchEvents() {
      const bannerCarousel = document.getElementById('bannerCarousel');
      if (!bannerCarousel) return;
      let touchStartX = 0;
      let touchStartY = 0;
      let touchEndX = 0;
      let touchEndY = 0;
      let isDragging = false;
      let currentTranslateX = 0;
      let startTransform = 0;
      const track = document.getElementById('bannerTrack');
      if (!track) return;
      bannerCarousel.addEventListener('touchstart', (e) => {
        pauseSlide();
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        touchEndX = touchStartX;
        touchEndY = touchStartY;
        isDragging = true;
        track.style.transition = 'none';
        const transform = track.style.transform;
        const match = transform.match(/translateX\((-?\d+\.?\d*)%\)/);
        startTransform = match ? parseFloat(match[1]) : 0;
      }, { passive: true });
      bannerCarousel.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        const currentX = e.touches[0].clientX;
        const currentY = e.touches[0].clientY;
        const diffX = touchStartX - currentX;
        const diffY = touchStartY - currentY;
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 5) {
          e.preventDefault();
          const dragPercent = (diffX / bannerCarousel.offsetWidth) * 100;
          const newTransform = startTransform - dragPercent;
          const maxDrag = 30;
          if (newTransform > -maxDrag && newTransform < (banners.length - 1) * 100 + maxDrag) {
            track.style.transform = `translateX(-${newTransform}%)`;
            touchEndX = currentX;
          }
        }
      }, { passive: false });
      bannerCarousel.addEventListener('touchend', (e) => {
        if (!isDragging) return;
        track.style.transition = '';
        const diffX = touchStartX - touchEndX;
        const diffY = touchStartY - touchEndY;
        const activeIndex = Array.from(document.querySelectorAll('.banner-dot')).findIndex(dot => dot.classList.contains('active'));
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
          if (diffX > 0) {
            const nextIndex = (activeIndex + 1) % banners.length;
            setBannerSlide(nextIndex);
          } else {
            const prevIndex = (activeIndex - 1 + banners.length) % banners.length;
            setBannerSlide(prevIndex);
          }
        } else {
          setBannerSlide(activeIndex);
        }
        isDragging = false;
        resumeSlideAfterDelay();
      }, { passive: true });
      bannerCarousel.addEventListener('mousedown', (e) => {
        e.preventDefault();
        pauseSlide();
        touchStartX = e.clientX;
        isDragging = true;
        track.style.transition = 'none';
        const transform = track.style.transform;
        const match = transform.match(/translateX\((-?\d+\.?\d*)%\)/);
        startTransform = match ? parseFloat(match[1]) : 0;
      });
      bannerCarousel.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
        const diffX = touchStartX - e.clientX;
        const dragPercent = (diffX / bannerCarousel.offsetWidth) * 100;
        const newTransform = startTransform - dragPercent;
        const maxDrag = 30;
        if (newTransform > -maxDrag && newTransform < (banners.length - 1) * 100 + maxDrag) {
          track.style.transform = `translateX(-${newTransform}%)`;
          touchEndX = e.clientX;
        }
      });
      bannerCarousel.addEventListener('mouseup', (e) => {
        if (!isDragging) return;
        track.style.transition = '';
        const diffX = touchStartX - e.clientX;
        const activeIndex = Array.from(document.querySelectorAll('.banner-dot')).findIndex(dot => dot.classList.contains('active'));
        if (Math.abs(diffX) > 50) {
          if (diffX > 0) {
            const nextIndex = (activeIndex + 1) % banners.length;
            setBannerSlide(nextIndex);
          } else {
            const prevIndex = (activeIndex - 1 + banners.length) % banners.length;
            setBannerSlide(prevIndex);
          }
        } else {
          setBannerSlide(activeIndex);
        }
        isDragging = false;
        resumeSlideAfterDelay();
      });
      bannerCarousel.addEventListener('mouseleave', () => {
        if (isDragging) {
          const activeIndex = Array.from(document.querySelectorAll('.banner-dot')).findIndex(dot => dot.classList.contains('active'));
          setBannerSlide(activeIndex);
          isDragging = false;
          resumeSlideAfterDelay();
        }
      });
    }

    function setupPriceSlider(minThumb, maxThumb, track, range, minInput, maxInput) {
      let minPercent = 0;
      let maxPercent = 100;
      const minPrice = 0;
      const maxPrice = 10000;
      function updateSlider() {
        minThumb.style.left = minPercent + '%';
        maxThumb.style.left = maxPercent + '%';
        range.style.left = minPercent + '%';
        range.style.width = (maxPercent - minPercent) + '%';
        const minValue = Math.round(minPrice + (minPercent / 100) * (maxPrice - minPrice));
        const maxValue = Math.round(minPrice + (maxPercent / 100) * (maxPrice - minPrice));
        minInput.value = minValue;
        maxInput.value = maxValue;
      }
      function onThumbMove(thumb, isMin) {
        return function(e) {
          e.preventDefault();
          const trackRect = track.getBoundingClientRect();
          let percent;
          if (e.type === 'touchmove') {
            percent = ((e.touches[0].clientX - trackRect.left) / trackRect.width) * 100;
          } else {
            percent = ((e.clientX - trackRect.left) / trackRect.width) * 100;
          }
          percent = Math.max(0, Math.min(100, percent));
          if (isMin) {
            if (percent < maxPercent - 5) {
              minPercent = percent;
            }
          } else {
            if (percent > minPercent + 5) {
              maxPercent = percent;
            }
          }
          updateSlider();
        };
      }
      function onThumbUp() {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onThumbUp);
        document.removeEventListener('touchmove', onTouchMove);
        document.removeEventListener('touchend', onThumbUp);
      }
      let onMouseMove, onTouchMove;
      function onThumbDown(isMin) {
        return function(e) {
          e.preventDefault();
          if (isMin) {
            onMouseMove = onThumbMove(minThumb, true);
            onTouchMove = onThumbMove(minThumb, true);
          } else {
            onMouseMove = onThumbMove(maxThumb, false);
            onTouchMove = onThumbMove(maxThumb, false);
          }
          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onThumbUp);
          document.addEventListener('touchmove', onTouchMove);
          document.addEventListener('touchend', onThumbUp);
        };
      }
      minThumb.addEventListener('mousedown', onThumbDown(true));
      maxThumb.addEventListener('mousedown', onThumbDown(false));
      minThumb.addEventListener('touchstart', onThumbDown(true));
      maxThumb.addEventListener('touchstart', onThumbDown(false));
      minInput.addEventListener('input', function() {
        const value = parseInt(this.value) || 0;
        minPercent = ((value - minPrice) / (maxPrice - minPrice)) * 100;
        if (minPercent >= maxPercent - 5) minPercent = maxPercent - 5;
        updateSlider();
      });
      maxInput.addEventListener('input', function() {
        const value = parseInt(this.value) || maxPrice;
        maxPercent = ((value - minPrice) / (maxPrice - minPrice)) * 100;
        if (maxPercent <= minPercent + 5) maxPercent = minPercent + 5;
        updateSlider();
      });
      updateSlider();
    }

    function setupTrendingAutoSlide() {
      const slider = document.getElementById('productSlider');
      if (!slider) return;
      const slides = slider.querySelectorAll('.slider-item');
      if (slides.length <= 1) return;
      let currentSlide = 0;
      let autoSlideEnabled = true;
      let autoSlideInterval;
      let indicators = slider.parentElement?.querySelector('.slide-indicators');
      if (!indicators && slider.parentElement) {
        indicators = document.createElement('div');
        indicators.className = 'slide-indicators';
        for (let i = 0; i < slides.length; i++) {
          const dot = document.createElement('span');
          dot.className = `slide-indicator ${i === 0 ? 'active' : ''}`;
          dot.dataset.index = i;
          dot.addEventListener('click', () => {
            currentSlide = i;
            updateSlidePosition();
            pauseAutoSlide();
            setTimeout(resumeAutoSlide, 3000);
          });
          indicators.appendChild(dot);
        }
        slider.parentElement.appendChild(indicators);
      }
      function updateSlidePosition() {
        const slideWidth = slides[0]?.offsetWidth || 0;
        slider.scrollTo({
          left: currentSlide * slideWidth,
          behavior: 'smooth'
        });
        document.querySelectorAll('.slide-indicator').forEach((dot, index) => {
          dot.style.background = index === currentSlide ? 'var(--accent)' : 'var(--muted)';
        });
      }
      function startAutoSlide() {
        if (autoSlideInterval) clearInterval(autoSlideInterval);
        autoSlideInterval = setInterval(() => {
          if (autoSlideEnabled) {
            currentSlide = (currentSlide + 1) % slides.length;
            updateSlidePosition();
          }
        }, 4000);
      }
      function pauseAutoSlide() {
        autoSlideEnabled = false;
      }
      function resumeAutoSlide() {
        autoSlideEnabled = true;
      }
      slider.addEventListener('mouseenter', pauseAutoSlide);
      slider.addEventListener('mouseleave', () => {
        pauseAutoSlide();
        setTimeout(resumeAutoSlide, 1500);
      });
      slider.addEventListener('touchstart', pauseAutoSlide, { passive: true });
      slider.addEventListener('touchend', () => {
        pauseAutoSlide();
        setTimeout(resumeAutoSlide, 3000);
      }, { passive: true });
      let scrollTimeout;
      slider.addEventListener('scroll', () => {
        pauseAutoSlide();
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          const scrollLeft = slider.scrollLeft;
          const slideWidth = slides[0]?.offsetWidth || 0;
          const newIndex = Math.round(scrollLeft / slideWidth);
          if (newIndex !== currentSlide && newIndex >= 0 && newIndex < slides.length) {
            currentSlide = newIndex;
            updateSlidePosition();
          }
          resumeAutoSlide();
        }, 150);
      }, { passive: true });
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          updateSlidePosition();
        }, 100);
      });
      startAutoSlide();
      window.trendingSliderCleanup = () => {
        if (autoSlideInterval) clearInterval(autoSlideInterval);
        slider.removeEventListener('mouseenter', pauseAutoSlide);
        slider.removeEventListener('mouseleave', pauseAutoSlide);
        slider.removeEventListener('touchstart', pauseAutoSlide);
        slider.removeEventListener('touchend', pauseAutoSlide);
      };
    }

    function parseHash() {
      const hash = window.location.hash.substring(1);
      if (hash.includes('productDetailPage?product=')) {
        return {
          page: 'productDetailPage',
          productId: hash.split('=')[1]
        };
      }
      const externalPages = ['notifications.html', 'offers.html', 'contact.html', 'refund.html', 'sellproduct.html'];
      if (externalPages.includes(hash)) {
        return {
          page: 'external',
          url: hash
        };
      }
      const internalPages = ['homePage', 'productsPage', 'myOrdersPage', 'wishlistPage', 'recentlyViewedPage'];
      if (internalPages.includes(hash)) {
        return {
          page: hash
        };
      }
      return { page: 'homePage' };
    }

    function handleNavigation(target) {
      const parsed = parseHash();
      if (parsed.page === 'external') {
        window.location.href = parsed.url;
        return;
      }
      if (parsed.page === 'productDetailPage' && parsed.productId) {
        const product = products.find(p => p.id === parsed.productId);
        if (product) {
          showProductDetail(product);
        } else {
          const checkInterval = setInterval(() => {
            const loadedProduct = products.find(p => p.id === parsed.productId);
            if (loadedProduct) {
              showProductDetail(loadedProduct);
              clearInterval(checkInterval);
            }
          }, 100);
          setTimeout(() => clearInterval(checkInterval), 5000);
        }
        return;
      }
      if (document.getElementById(parsed.page)) {
        showPage(parsed.page);
      } else {
        showPage('homePage');
      }
    }

    function updateMenuHandlers() {
      const notificationsItems = document.querySelectorAll('[onclick*="notifications.html"]');
      notificationsItems.forEach(item => {
        item.onclick = (e) => {
          e.preventDefault();
          window.location.href = 'notifications.html';
        };
      });
      const offersItems = document.querySelectorAll('[onclick*="offers.html"]');
      offersItems.forEach(item => {
        item.onclick = (e) => {
          e.preventDefault();
          window.location.href = 'offers.html';
        };
      });
      const contactItems = document.querySelectorAll('[onclick*="contact.html"]');
      contactItems.forEach(item => {
        item.onclick = (e) => {
          e.preventDefault();
          window.location.href = 'contact.html';
        };
      });
      const refundItems = document.querySelectorAll('[onclick*="refund.html"]');
      refundItems.forEach(item => {
        item.onclick = (e) => {
          e.preventDefault();
          window.location.href = 'refund.html';
        };
      });
      const sellItems = document.querySelectorAll('[onclick*="sellproduct.html"]');
      sellItems.forEach(item => {
        item.onclick = (e) => {
          e.preventDefault();
          window.location.href = 'sellproduct.html';
        };
      });
    }

    function showLoginModal() {
      document.getElementById('authModal').classList.add('active');
      switchAuthTab('login');
    }

    function switchAuthTab(tab) {
      document.getElementById('loginForm').classList.remove('active');
      document.getElementById('signupForm').classList.remove('active');
      document.getElementById('forgotPasswordForm').classList.remove('active');
      document.getElementById('loginTab').classList.remove('active');
      document.getElementById('signupTab').classList.remove('active');
      document.getElementById('loginError').textContent = '';
      document.getElementById('signupError').textContent = '';
      if (tab === 'login') {
        document.getElementById('loginTab').classList.add('active');
        document.getElementById('loginForm').classList.add('active');
      } else {
        document.getElementById('signupTab').classList.add('active');
        document.getElementById('signupForm').classList.add('active');
      }
    }

    async function handleLogin() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const loginError = document.getElementById('loginError');
      const loginBtn = document.getElementById('loginBtn');
      loginError.textContent = '';
      if (!email || !password) {
        loginError.textContent = 'Please fill in all fields';
        return;
      }
      try {
        loginBtn.disabled = true;
        loginBtn.innerHTML = '<div class="loading-spinner"></div> Logging in...';
        const userCredential = await window.firebase.signInWithEmailAndPassword(window.firebase.auth, email, password);
        sendLoginNotification(email);
        showToast('Login successful!', 'success');
        document.getElementById('authModal').classList.remove('active');
        document.getElementById('loginEmail').value = '';
        document.getElementById('loginPassword').value = '';
      } catch (err) {
        loginError.textContent = err.message;
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Login';
      }
    }

    async function handleSignup() {
      const name = document.getElementById('signupName').value;
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const signupError = document.getElementById('signupError');
      const signupBtn = document.getElementById('signupBtn');
      signupError.textContent = '';
      if (!name || !email || !password) {
        signupError.textContent = 'Please fill in all fields';
        return;
      }
      if (password.length < 6) {
        signupError.textContent = 'Password should be at least 6 characters';
        return;
      }
      try {
        signupBtn.disabled = true;
        signupBtn.innerHTML = '<div class="loading-spinner"></div> Creating account...';
        const userCredential = await window.firebase.createUserWithEmailAndPassword(window.firebase.auth, email, password);
        const user = userCredential.user;
        await window.firebase.set(window.firebase.ref(window.firebase.database, 'users/' + user.uid), {
          name: name,
          email: email,
          createdAt: Date.now(),
          lastLoginAt: Date.now()
        });
        sendWelcomeEmail(email, name);
        showToast('Account created successfully!', 'success');
        document.getElementById('authModal').classList.remove('active');
        document.getElementById('signupName').value = '';
        document.getElementById('signupEmail').value = '';
        document.getElementById('signupPassword').value = '';
      } catch (err) {
        signupError.textContent = err.message;
      } finally {
        signupBtn.disabled = false;
        signupBtn.textContent = 'Sign Up';
      }
    }

    async function handleGoogleLogin() {
      try {
        const provider = new window.firebase.GoogleAuthProvider();
        const result = await window.firebase.signInWithPopup(window.firebase.auth, provider);
        const user = result.user;
        const userRef = window.firebase.ref(window.firebase.database, 'users/' + user.uid);
        const snapshot = await window.firebase.get(userRef);
        if (!snapshot.exists()) {
          await window.firebase.set(userRef, {
            name: user.displayName,
            email: user.email,
            photoURL: user.photoURL,
            createdAt: Date.now(),
            lastLoginAt: Date.now()
          });
          sendWelcomeEmail(user.email, user.displayName);
        } else {
          await window.firebase.update(userRef, {
            lastLoginAt: Date.now()
          });
        }
        sendLoginNotification(user.email);
        showToast('Login successful!', 'success');
        document.getElementById('authModal').classList.remove('active');
      } catch (err) {
        const loginError = document.getElementById('loginError');
        const signupError = document.getElementById('signupError');
        if (document.getElementById('loginForm').classList.contains('active')) {
          loginError.textContent = err.message;
        } else {
          signupError.textContent = err.message;
        }
      }
    }

    async function handleResetPassword() {
      const email = document.getElementById('forgotPasswordEmail').value;
      const resetPasswordBtn = document.getElementById('resetPasswordBtn');
      if (!email) {
        showToast('Please enter your email address', 'error');
        return;
      }
      try {
        resetPasswordBtn.disabled = true;
        resetPasswordBtn.innerHTML = '<div class="loading-spinner"></div> Sending...';
        await window.firebase.sendPasswordResetEmail(window.firebase.auth, email);
        showToast('Password reset email sent! Check your inbox.', 'success');
        document.getElementById('forgotPasswordEmail').value = '';
        setTimeout(() => {
          document.getElementById('authModal').classList.remove('active');
        }, 2000);
      } catch (err) {
        showToast(err.message, 'error');
      } finally {
        resetPasswordBtn.disabled = false;
        resetPasswordBtn.textContent = 'Send Reset Link';
      }
    }

    function updateUIForUser(user) {
      document.getElementById('userProfile').style.display = 'flex';
      document.getElementById('openLoginTop').style.display = 'none';
      document.getElementById('mobileLoginBtn').style.display = 'none';
      document.getElementById('mobileUserProfile').style.display = 'flex';
      document.getElementById('mobileLogoutBtn').style.display = 'flex';
      document.getElementById('headerSearchContainer').style.display = 'block';
      updateUserProfile(user);
    }

    function updateUIForGuest() {
      document.getElementById('userProfile').style.display = 'none';
      document.getElementById('openLoginTop').style.display = 'block';
      document.getElementById('mobileLoginBtn').style.display = 'flex';
      document.getElementById('mobileUserProfile').style.display = 'none';
      document.getElementById('mobileLogoutBtn').style.display = 'none';
      document.getElementById('headerSearchContainer').style.display = 'block';
      document.getElementById('openLoginTop').textContent = 'Login / Sign Up';
    }

    function updateUserProfile(user) {
      const userAvatarImg = document.getElementById('userAvatarImg');
      const userAvatarInitial = document.getElementById('userAvatarInitial');
      const headerUserNameShort = document.getElementById('headerUserNameShort');
      if (user.photoURL) {
        userAvatarImg.src = user.photoURL;
        userAvatarImg.style.display = 'block';
        userAvatarInitial.style.display = 'none';
      } else {
        userAvatarImg.style.display = 'none';
        userAvatarInitial.style.display = 'block';
        userAvatarInitial.textContent = (user.displayName || 'U').charAt(0).toUpperCase();
      }
      const name = user.displayName || 'User';
      if (headerUserNameShort) {
        const shortName = name.split(' ')[0];
        headerUserNameShort.textContent = shortName.length > 10 ? shortName.substring(0, 10) + '...' : shortName;
      }
    }

    function showLogoutConfirmation() {
      document.getElementById('alertTitle').textContent = 'Logout Confirmation';
      document.getElementById('alertMessage').textContent = 'Are you sure you want to logout?';
      document.getElementById('alertModal').classList.add('active');
    }

    function confirmLogout() {
      window.firebase.signOut(window.firebase.auth).then(() => {
        showToast('Logged out successfully', 'success');
        document.getElementById('alertModal').classList.remove('active');
        showPage('homePage');
      }).catch(error => {
        showToast('Error logging out', 'error');
      });
    }

    async function loadSavedAddresses() {
      const addressesList = document.getElementById('savedAddressesList');
      const savedAddressesSection = document.getElementById('savedAddressesSection');
      if (!addressesList || !savedAddressesSection) return;
      const cachedAddresses = cacheManager.get(cacheManager.KEYS.ADDRESSES);
      if (cachedAddresses && cachedAddresses.length > 0) {
        savedAddresses = cachedAddresses;
        renderSavedAddresses();
        savedAddressesSection.style.display = 'block';
      } else {
        savedAddresses = [];
        savedAddressesSection.style.display = 'none';
      }
      if (currentUser) {
        try {
          const snapshot = await window.firebase.get(
            window.firebase.query(
              window.firebase.ref(window.firebase.database, 'addresses'),
              window.firebase.orderByChild('userId'),
              window.firebase.equalTo(currentUser.uid)
            )
          );
          if (snapshot.exists()) {
            const addressesObj = snapshot.val();
            const addresses = Object.keys(addressesObj).map(key => ({
              id: key,
              ...addressesObj[key]
            }));
            savedAddresses = addresses.sort((a, b) => 
              (b.isDefault ? 1 : 0) - (a.isDefault ? 1 : 0) || b.createdAt - a.createdAt
            );
            cacheManager.set(cacheManager.KEYS.ADDRESSES, savedAddresses, 30 * 24 * 60 * 60 * 1000);
            if (addresses.length > 0) {
              savedAddressesSection.style.display = 'block';
              renderSavedAddresses();
            } else {
              savedAddressesSection.style.display = 'none';
            }
          } else {
            savedAddressesSection.style.display = 'none';
          }
        } catch (error) {
          if (savedAddresses.length > 0) {
            savedAddressesSection.style.display = 'block';
            renderSavedAddresses();
          }
        }
      }
    }

    function renderSavedAddresses() {
      const addressesList = document.getElementById('savedAddressesList');
      if (!addressesList) return;
      addressesList.innerHTML = '';
      if (savedAddresses.length === 0) {
        addressesList.innerHTML = '<div class="card-panel center" style="padding:20px;">No saved addresses found.</div>';
        return;
      }
      savedAddresses.forEach(address => {
        const addressCard = document.createElement('div');
        addressCard.className = 'saved-address-card';
        addressCard.dataset.addressId = address.id;
        const isDefault = address.isDefault ? ' (Default)' : '';
        const addressTypeLabel = address.type === 'home' ? 'üè† Home' : address.type === 'work' ? 'üíº Work' : 'üìç Other';
        addressCard.innerHTML = `
          <div style="display:flex;align-items:flex-start;gap:10px;">
            <input type="radio" name="savedAddress" value="${address.id}" ${address.isDefault ? 'checked' : ''} class="address-radio">
            <div style="flex:1">
              <div style="font-weight:600;margin-bottom:4px;">
                ${address.name} ${isDefault}
                <span style="float:right;font-size:12px;color:var(--muted);background:var(--surface);padding:2px 8px;border-radius:12px;">${addressTypeLabel}</span>
              </div>
              <div style="color:var(--text);margin-bottom:4px;">${address.street}</div>
              <div style="color:var(--text);margin-bottom:4px;">${address.city}, ${address.state} - ${address.pincode}</div>
              <div style="color:var(--muted);font-size:13px;">Mobile: ${address.mobile}</div>
            </div>
          </div>
          <div class="address-actions" style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
            <button class="btn secondary small edit-address" data-id="${address.id}" style="padding:4px 12px;font-size:13px;">Edit</button>
            <button class="btn error small delete-address" data-id="${address.id}" style="padding:4px 12px;font-size:13px;">Delete</button>
            ${!address.isDefault ? `<button class="btn secondary small set-default-address" data-id="${address.id}" style="padding:4px 12px;font-size:13px;">Set as Default</button>` : ''}
          </div>
        `;
        const radio = addressCard.querySelector('.address-radio');
        radio.addEventListener('click', function(e) {
          e.stopPropagation();
          fillAddressForm(address);
          userInfo = { 
            fullName: address.name, 
            mobile: address.mobile, 
            pincode: address.pincode, 
            city: address.city, 
            state: address.state, 
            house: address.street 
          };
        });
        addressCard.addEventListener('click', function(e) {
          if (!e.target.closest('button')) {
            radio.checked = true;
            fillAddressForm(address);
            userInfo = { 
              fullName: address.name, 
              mobile: address.mobile, 
              pincode: address.pincode, 
              city: address.city, 
              state: address.state, 
              house: address.street 
            };
          }
        });
        const editBtn = addressCard.querySelector('.edit-address');
        editBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          editAddress(address);
        });
        const deleteBtn = addressCard.querySelector('.delete-address');
        deleteBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          deleteAddressConfirmation(address);
        });
        const defaultBtn = addressCard.querySelector('.set-default-address');
        if (defaultBtn) {
          defaultBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            setDefaultAddress(address.id);
          });
        }
        addressesList.appendChild(addressCard);
      });
    }

    function fillAddressForm(address) {
      document.getElementById('fullname').value = address.name;
      document.getElementById('mobile').value = address.mobile;
      document.getElementById('pincode').value = address.pincode;
      document.getElementById('city').value = address.city;
      document.getElementById('state').value = address.state;
      document.getElementById('house').value = address.street;
      document.getElementById('addressType').value = address.type || 'home';
    }

    async function saveUserInfoAndAddress() {
      const fullname = document.getElementById('fullname').value.trim();
      const mobile = document.getElementById('mobile').value.trim();
      const pincode = document.getElementById('pincode').value.trim();
      const city = document.getElementById('city').value.trim();
      const state = document.getElementById('state').value.trim();
      const house = document.getElementById('house').value.trim();
      const addressType = document.getElementById('addressType').value;
      if (!fullname || !mobile || !pincode || !city || !state || !house) {
        showToast('Please fill in all required fields', 'error');
        return false;
      }
      if (!/^\d{10}$/.test(mobile)) {
        showToast('Please enter a valid 10-digit mobile number', 'error');
        return false;
      }
      if (!/^\d{6}$/.test(pincode)) {
        showToast('Please enter a valid 6-digit pincode', 'error');
        return false;
      }
      userInfo = { fullName: fullname, mobile, pincode, city, state, house };
      if (!currentUser) {
        const guestAddresses = JSON.parse(localStorage.getItem('guest_addresses') || '[]');
        const guestAddress = {
          id: 'guest_' + Date.now(),
          name: fullname,
          mobile: mobile,
          pincode: pincode,
          city: city,
          state: state,
          street: house,
          type: addressType,
          isDefault: guestAddresses.length === 0,
          createdAt: Date.now(),
          isGuest: true
        };
        guestAddresses.push(guestAddress);
        localStorage.setItem('guest_addresses', JSON.stringify(guestAddresses));
        savedAddresses = guestAddresses;
        renderSavedAddresses();
        showToast('Address saved locally', 'success');
        return true;
      }
      const addressData = {
        name: fullname,
        mobile: mobile,
        pincode: pincode,
        city: city,
        state: state,
        street: house,
        type: addressType,
        userId: currentUser.uid,
        isDefault: savedAddresses.length === 0,
        createdAt: Date.now(),
        updatedAt: Date.now()
      };
      try {
        const addressId = 'address_' + Date.now();
        await window.firebase.set(window.firebase.ref(window.firebase.database, 'addresses/' + addressId), addressData);
        const updatedAddress = { id: addressId, ...addressData };
        savedAddresses.push(updatedAddress);
        cacheManager.set(cacheManager.KEYS.ADDRESSES, savedAddresses, 30 * 24 * 60 * 60 * 1000);
        showToast('Address saved successfully', 'success');
        await loadSavedAddresses();
        return true;
      } catch (error) {
        showToast('Failed to save address', 'error');
        return false;
      }
    }

    function showNewAddressForm() {
      document.getElementById('savedAddressesSection').style.display = 'block';
      document.getElementById('newAddressForm').style.display = 'block';
      document.getElementById('fullname').value = '';
      document.getElementById('mobile').value = '';
      document.getElementById('pincode').value = '';
      document.getElementById('city').value = '';
      document.getElementById('state').value = '';
      document.getElementById('house').value = '';
      document.getElementById('addressType').value = 'home';
      const saveBtn = document.getElementById('saveUserInfo');
      saveBtn.textContent = 'Save This Address';
      saveBtn.onclick = saveUserInfoAndAddress;
    }

    function editAddress(address) {
      fillAddressForm(address);
      document.getElementById('savedAddressesSection').style.display = 'none';
      document.getElementById('newAddressForm').style.display = 'block';
      const saveBtn = document.getElementById('saveUserInfo');
      saveBtn.textContent = 'Update Address';
      saveBtn.onclick = async function() {
        const fullname = document.getElementById('fullname').value.trim();
        const mobile = document.getElementById('mobile').value.trim();
        const pincode = document.getElementById('pincode').value.trim();
        const city = document.getElementById('city').value.trim();
        const state = document.getElementById('state').value.trim();
        const house = document.getElementById('house').value.trim();
        const addressType = document.getElementById('addressType').value;
        if (!fullname || !mobile || !pincode || !city || !state || !house) {
          showToast('Please fill in all required fields', 'error');
          return;
        }
        if (!/^\d{10}$/.test(mobile)) {
          showToast('Please enter a valid 10-digit mobile number', 'error');
          return;
        }
        if (!/^\d{6}$/.test(pincode)) {
          showToast('Please enter a valid 6-digit pincode', 'error');
          return;
        }
        const addressData = {
          name: fullname,
          mobile: mobile,
          pincode: pincode,
          city: city,
          state: state,
          street: house,
          type: addressType,
          userId: currentUser.uid,
          isDefault: address.isDefault
        };
        try {
          await window.firebase.update(window.firebase.ref(window.firebase.database, 'addresses/' + address.id), addressData);
          showToast('Address updated successfully', 'success');
          document.getElementById('savedAddressesSection').style.display = 'block';
          document.getElementById('newAddressForm').style.display = 'block';
          await loadSavedAddresses();
        } catch (error) {
          showToast('Failed to update address', 'error');
        }
      };
    }

    function deleteAddressConfirmation(address) {
      document.getElementById('alertTitle').textContent = 'Delete Address';
      document.getElementById('alertMessage').textContent = `Are you sure you want to delete the address for ${address.name}?`;
      document.getElementById('alertModal').classList.add('active');
      document.getElementById('alertConfirmBtn').onclick = async function() {
        try {
          if (currentUser && !address.isGuest) {
            await window.firebase.remove(window.firebase.ref(window.firebase.database, 'addresses/' + address.id));
          }
          savedAddresses = savedAddresses.filter(addr => addr.id !== address.id);
          if (address.isGuest) {
            localStorage.setItem('guest_addresses', JSON.stringify(savedAddresses));
          } else {
            cacheManager.set(cacheManager.KEYS.ADDRESSES, savedAddresses, 30 * 24 * 60 * 60 * 1000);
          }
          renderSavedAddresses();
          if (savedAddresses.length === 0) {
            document.getElementById('savedAddressesSection').style.display = 'none';
            showNewAddressForm();
          }
          showToast('Address deleted successfully', 'success');
          document.getElementById('alertModal').classList.remove('active');
        } catch (error) {
          showToast('Failed to delete address', 'error');
        }
      };
      document.getElementById('alertCancelBtn').onclick = function() {
        document.getElementById('alertModal').classList.remove('active');
      };
    }

    async function setDefaultAddress(addressId) {
      if (!currentUser) return;
      try {
        const updates = {};
        savedAddresses.forEach(addr => {
          if (addr.id === addressId) {
            updates[`addresses/${addr.id}/isDefault`] = true;
          } else {
            updates[`addresses/${addr.id}/isDefault`] = false;
          }
        });
        await window.firebase.update(window.firebase.ref(window.firebase.database), updates);
        savedAddresses.forEach(addr => {
          addr.isDefault = (addr.id === addressId);
        });
        cacheManager.set(cacheManager.KEYS.ADDRESSES, savedAddresses, 30 * 24 * 60 * 60 * 1000);
        renderSavedAddresses();
        showToast('Default address updated', 'success');
      } catch (error) {
        showToast('Failed to update default address', 'error');
      }
    }

    function sendLoginNotification(email) {}
    function sendWelcomeEmail(email, name) {}
    function sendOrderNotification(email, orderId, productName, total) {}

    function setupHeroMessages() {
      const messages = document.querySelectorAll('#heroMessages span');
      let currentIndex = 0;
      setInterval(() => {
        messages.forEach(msg => msg.classList.remove('active'));
        currentIndex = (currentIndex + 1) % messages.length;
        messages[currentIndex].classList.add('active');
      }, 3000);
    }

    function updateHeroContent() {
      const heroHeading = document.getElementById('heroHeading');
      const heroSubheading = document.getElementById('heroSubheading');
      const heroMessagesContainer = document.getElementById('heroMessages');
      if (heroHeading) heroHeading.innerHTML = adminSettings.heroHeading || 'Welcome to <span style="color:var(--accent)">Buyzo Cart</span>';
      if (heroSubheading) heroSubheading.textContent = adminSettings.heroSubheading || 'Clean, fast checkout. Hand‚Äëpicked products. Fully responsive UI.';
      if (heroMessagesContainer && adminSettings.heroMessages && adminSettings.heroMessages.length) {
        heroMessagesContainer.innerHTML = '';
        adminSettings.heroMessages.forEach((msg, index) => {
          const span = document.createElement('span');
          span.textContent = msg;
          if (index === 0) span.classList.add('active');
          heroMessagesContainer.appendChild(span);
        });
      }
    }

    function updateCurrencySymbols() {
      const symbol = getCurrencySymbol();
      document.querySelectorAll('[id^="currencySymbol"]').forEach(el => {
        if (el.id !== 'currencySymbolPriceFilter' && el.id !== 'currencySymbolPriceFilter2' && 
            el.id !== 'currencySymbolSearch1' && el.id !== 'currencySymbolSearch2') return;
        el.textContent = symbol;
      });
    }

    async function loadUserData(user) {
      try {
        const snapshot = await window.firebase.get(window.firebase.ref(window.firebase.database, 'users/' + user.uid));
        if (snapshot.exists()) {
          const userData = snapshot.val();
          userInfo = { ...userInfo, ...userData };
        }
      } catch (error) {}
    }

    function updateAdminSettingsUI() {
      document.getElementById('deliveryCharge').textContent = adminSettings.deliveryCharge;
      document.getElementById('gatewayChargePercent').textContent = `${adminSettings.gatewayChargePercent}%`;
      updateCurrencySymbols();
      updateHeroContent();
    }

    function fetchLiveData() {
      if (!window.firebase || !window.firebase.database) {
        return;
      }
      const database = window.firebase.database;
      const ref = window.firebase.ref;
      const get = window.firebase.get;
      const cachedProducts = cacheManager.get(cacheManager.KEYS.PRODUCTS);
      if (cachedProducts && cachedProducts.length > 0) {
        products = cachedProducts;
        function updateProductRendering() {
          const currentPage = document.querySelector('.page.active')?.id;
          if (currentPage === 'homePage') {
            renderProducts(products, 'homeProductGrid');
            const trendingProducts = products.filter(p => p.isTrending || p.trending);
            renderProductSlider(trendingProducts.length > 0 ? trendingProducts : products.slice(0, 10), 'productSlider');
          } else if (currentPage === 'productsPage') {
            renderProducts(products, 'productGrid');
            updateProductsCount();
          } else if (currentPage === 'searchResultsPage' && window.currentSearchQuery) {
            const filteredResults = products.filter(product => 
              (product.name || '').toLowerCase().includes(window.currentSearchQuery.toLowerCase()) ||
              (product.description || '').toLowerCase().includes(window.currentSearchQuery.toLowerCase()) ||
              (product.category || '').toLowerCase().includes(window.currentSearchQuery.toLowerCase()) ||
              (product.tags && product.tags.some(tag => (tag || '').toLowerCase().includes(window.currentSearchQuery.toLowerCase())))
            );
            window.currentSearchResults = filteredResults;
            renderSearchResults(filteredResults, window.currentSearchQuery);
          }
        }
        updateProductRendering();
      }
      get(ref(database, 'products')).then(snapshot => {
        const productsObj = snapshot.val();
        if (productsObj) {
          const newProducts = Object.keys(productsObj).map(key => {
            const product = productsObj[key];
            return {
              id: key,
              ...product,
              images: product.images ? 
                (Array.isArray(product.images) ? product.images : [product.images]) : 
                (product.image ? [product.image] : 
                 (product.img ? [product.img] : 
                  (product.imageUrl ? [product.imageUrl] : [])))
            };
          });
          products = cacheManager.mergeWithLiveData(cachedProducts, newProducts, ['price', 'stock']);
          cacheManager.set(cacheManager.KEYS.PRODUCTS, products, cacheManager.TTL.PRODUCTS);
          const currentPage = document.querySelector('.page.active')?.id;
          if (currentPage === 'homePage') {
            renderProducts(products, 'homeProductGrid');
            const trendingProducts = products.filter(p => p.isTrending || p.trending);
            if (trendingProducts.length > 0) {
              renderProductSlider(trendingProducts, 'productSlider');
            } else {
              renderProductSlider(products.slice(0, 10), 'productSlider');
            }
          } else if (currentPage === 'productsPage') {
            renderProducts(products, 'productGrid');
            updateProductsCount();
          } else if (currentPage === 'searchResultsPage' && window.currentSearchQuery) {
            const filteredResults = products.filter(product => 
              (product.name || '').toLowerCase().includes(window.currentSearchQuery.toLowerCase()) ||
              (product.description || '').toLowerCase().includes(window.currentSearchQuery.toLowerCase()) ||
              (product.category || '').toLowerCase().includes(window.currentSearchQuery.toLowerCase()) ||
              (product.tags && product.tags.some(tag => (tag || '').toLowerCase().includes(window.currentSearchQuery.toLowerCase())))
            );
            window.currentSearchResults = filteredResults;
            renderSearchResults(filteredResults, window.currentSearchQuery);
          }
        } else {
          if (!cachedProducts) {
            products = [];
            renderProducts([], 'homeProductGrid');
            renderProducts([], 'productGrid');
          }
        }
      }).catch(error => {
        if (!cachedProducts) {
          products = [];
          renderProducts([], 'homeProductGrid');
          renderProducts([], 'productGrid');
        }
      });
      get(ref(database, 'categories')).then(snapshot => {
        const categoriesObj = snapshot.val();
        if (categoriesObj) {
          const newCategories = Object.keys(categoriesObj).map(key => ({
            id: key,
            ...categoriesObj[key]
          }));
          categories = newCategories;
          cacheManager.set(cacheManager.KEYS.CATEGORIES, categories);
          if (document.getElementById('homePage')?.classList.contains('active') || 
              document.getElementById('productsPage')?.classList.contains('active')) {
            renderCategories();
            renderCategoryCircles();
          }
        } else {
          categories = [];
        }
      }).catch(error => {
        categories = [];
      });
      get(ref(database, 'banners')).then(snapshot => {
        const bannersObj = snapshot.val();
        if (bannersObj) {
          const newBanners = Object.keys(bannersObj).map(key => ({
            id: key,
            ...bannersObj[key]
          }));
          banners = newBanners;
          cacheManager.set(cacheManager.KEYS.BANNERS, banners);
          if (document.getElementById('homePage')?.classList.contains('active')) {
            renderBannerCarousel();
          }
        } else {
          banners = [];
        }
      }).catch(error => {
        banners = [];
      });
      get(ref(database, 'adminSettings')).then(snapshot => {
        const settingsObj = snapshot.val();
        if (settingsObj) {
          adminSettings = { ...adminSettings, ...settingsObj };
          cacheManager.set(cacheManager.KEYS.SETTINGS, adminSettings);
          updateAdminSettingsUI();
        }
      }).catch(error => {});
      get(ref(database, 'outOfStock')).then(snapshot => {
        const outOfStockObj = snapshot.val();
        if (outOfStockObj) {
          window.outOfStockItems = outOfStockObj;
        }
      }).catch(error => {});
    }

    function loadCachedData() {
      const cachedProducts = cacheManager.get(cacheManager.KEYS.PRODUCTS);
      if (cachedProducts && cachedProducts.length > 0) {
        products = cachedProducts;
        renderProducts(products, 'homeProductGrid');
        renderProducts(products, 'productGrid');
        const trendingProducts = products.filter(p => p.isTrending).slice(0, 10);
        renderProductSlider(trendingProducts.length > 0 ? trendingProducts : products.slice(0, 10), 'productSlider');
        const featuredProducts = products.filter(p => p.isFeatured);
        if (featuredProducts.length > 0) {
          renderProducts(featuredProducts, 'homeProductGrid');
        }
        updateProductsCount();
      }
      const cachedCategories = cacheManager.get(cacheManager.KEYS.CATEGORIES);
      if (cachedCategories && cachedCategories.length > 0) {
        categories = cachedCategories;
        renderCategories();
        renderCategoryCircles();
      }
      const cachedBanners = cacheManager.get(cacheManager.KEYS.BANNERS);
      if (cachedBanners && cachedBanners.length > 0) {
        banners = cachedBanners;
        renderBannerCarousel();
      }
      const cachedSettings = cacheManager.get(cacheManager.KEYS.SETTINGS);
      if (cachedSettings) {
        adminSettings = cachedSettings;
        updateAdminSettingsUI();
      }
    }

    function setupRealtimeListeners() {
      if (!window.firebase || !window.firebase.database) return;
      const database = window.firebase.database;
      const ref = window.firebase.ref;
      const onValue = window.firebase.onValue;
      onValue(ref(database, 'products'), snapshot => {
        const productsObj = snapshot.val();
        if (productsObj) {
          const newProducts = Object.keys(productsObj).map(key => {
            const product = productsObj[key];
            return {
              id: key,
              ...product,
              images: product.images ? 
                (Array.isArray(product.images) ? product.images : [product.images]) : 
                (product.image ? [product.image] : 
                 (product.img ? [product.img] : 
                  (product.imageUrl ? [product.imageUrl] : [])))
            };
          });
          products = newProducts;
          cacheManager.set(cacheManager.KEYS.PRODUCTS, products);
          const currentPage = document.querySelector('.page.active')?.id;
          if (currentPage === 'homePage' || currentPage === 'productsPage' || 
              currentPage === 'productDetailPage' || currentPage === 'searchResultsPage') {
            if (currentPage === 'homePage') {
              renderProducts(products, 'homeProductGrid');
              const trendingProducts = products.filter(p => p.isTrending);
              if (trendingProducts.length > 0) {
                renderProductSlider(trendingProducts, 'productSlider');
              } else {
                renderProductSlider(products.slice(0, 10), 'productSlider');
              }
            } else if (currentPage === 'productsPage') {
              renderProducts(products, 'productGrid');
              updateProductsCount();
            }
            if (document.getElementById('searchResultsPage')?.classList.contains('active') && window.currentSearchQuery) {
              const filteredResults = products.filter(product => 
                (product.name || '').toLowerCase().includes(window.currentSearchQuery.toLowerCase()) ||
                (product.description || '').toLowerCase().includes(window.currentSearchQuery.toLowerCase()) ||
                (product.category || '').toLowerCase().includes(window.currentSearchQuery.toLowerCase()) ||
                (product.tags && product.tags.some(tag => (tag || '').toLowerCase().includes(window.currentSearchQuery.toLowerCase())))
              );
              window.currentSearchResults = filteredResults;
              renderSearchResults(filteredResults, window.currentSearchQuery);
            }
          }
        } else {
          products = [];
        }
      });
      onValue(ref(database, 'categories'), snapshot => {
        const categoriesObj = snapshot.val();
        if (categoriesObj) {
          const newCategories = Object.keys(categoriesObj).map(key => ({
            id: key,
            ...categoriesObj[key]
          }));
          categories = newCategories;
          cacheManager.set(cacheManager.KEYS.CATEGORIES, categories);
          if (document.getElementById('homePage')?.classList.contains('active') || 
              document.getElementById('productsPage')?.classList.contains('active')) {
            renderCategories();
            renderCategoryCircles();
          }
        } else {
          categories = [];
        }
      });
      onValue(ref(database, 'banners'), snapshot => {
        const bannersObj = snapshot.val();
        if (bannersObj) {
          const newBanners = Object.keys(bannersObj).map(key => ({
            id: key,
            ...bannersObj[key]
          }));
          banners = newBanners;
          cacheManager.set(cacheManager.KEYS.BANNERS, banners);
          if (document.getElementById('homePage')?.classList.contains('active')) {
            renderBannerCarousel();
          }
        } else {
          banners = [];
        }
      });
      onValue(ref(database, 'adminSettings'), snapshot => {
        const settingsObj = snapshot.val();
        if (settingsObj) {
          adminSettings = { ...adminSettings, ...settingsObj };
          cacheManager.set(cacheManager.KEYS.SETTINGS, adminSettings);
          updateAdminSettingsUI();
        }
      });
      onValue(ref(database, 'outOfStock'), snapshot => {
        const outOfStockObj = snapshot.val();
        if (outOfStockObj) {
          window.outOfStockItems = outOfStockObj;
        }
      });
    }

    function setupOrderListener() {
      if (!window.firebase || !window.firebase.database || !currentUser) return;
      const ordersRef = window.firebase.ref(window.firebase.database, 'orders');
      const userOrdersQuery = window.firebase.query(
        ordersRef,
        window.firebase.orderByChild('userId'),
        window.firebase.equalTo(currentUser.uid)
      );
      window.firebase.onValue(userOrdersQuery, (snapshot) => {
        if (snapshot.exists()) {
          const ordersObj = snapshot.val();
          const orders = Object.keys(ordersObj).map(key => ({
            id: key,
            ...ordersObj[key]
          }));
          orders.sort((a, b) => b.orderDate - a.orderDate);
          cacheManager.set(cacheManager.KEYS.ORDERS, orders, cacheManager.TTL.ORDERS);
          if (document.getElementById('myOrdersPage')?.classList.contains('active')) {
            renderOrders(orders);
          }
        }
      });
    }

    function adjustZoom(delta) {
      currentZoomLevel += delta;
      currentZoomLevel = Math.max(0.5, Math.min(3, currentZoomLevel));
      document.getElementById('zoomImage').style.transform = `scale(${currentZoomLevel})`;
    }

    function resetZoom() {
      currentZoomLevel = 1;
      document.getElementById('zoomImage').style.transform = 'scale(1)';
    }

    function handleNewsletterSubscription() {
      const email = document.getElementById('newsletterEmail').value;
      if (!email) {
        showToast('Please enter your email address', 'error');
        return;
      }
      showToast('Thank you for subscribing!', 'success');
      document.getElementById('newsletterEmail').value = '';
    }

    function setupHeaderSearchScroll() {
      const headerSearchContainer = document.getElementById('headerSearchContainer');
      if (!headerSearchContainer) return;
      window.addEventListener('scroll', function() {
        headerSearchContainer.style.opacity = '1';
        headerSearchContainer.style.visibility = 'visible';
      }, false);
    }

    function setupBackButton() {
      window.addEventListener('popstate', function(event) {
        const currentPage = document.querySelector('.page.active').id;
        if (currentPage === 'productDetailPage') {
          showPage('productsPage');
        } else if (currentPage === 'orderPage' || currentPage === 'userPage' || currentPage === 'paymentPage') {
          if (currentPage === 'paymentPage') {
            showPage('userPage');
          } else if (currentPage === 'userPage') {
            showPage('orderPage');
          } else if (currentPage === 'orderPage') {
            showPage('productsPage');
          }
        } else {
          showPage('homePage');
        }
      });
    }

    function setupSearchInput() {
      const searchInput = document.getElementById('searchPanelInput');
      if (searchInput) {
        searchInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            performSearch(this.value);
          }
        });
        searchInput.addEventListener('input', function(e) {
          handleSearchPanelInput(e);
        });
      }
      const searchResultsInput = document.getElementById('searchResultsInput');
      const searchResultsBtn = document.getElementById('searchResultsBtn');
      if (searchResultsInput) {
        searchResultsInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            const query = this.value.trim();
            if (query) {
              window.currentSearchQuery = query;
              const filteredResults = products.filter(product => 
                (product.name || '').toLowerCase().includes(query.toLowerCase()) ||
                (product.description || '').toLowerCase().includes(query.toLowerCase()) ||
                (product.category || '').toLowerCase().includes(query.toLowerCase()) ||
                (product.tags && product.tags.some(tag => (tag || '').toLowerCase().includes(query.toLowerCase())))
              );
              window.currentSearchResults = filteredResults;
              renderSearchResults(filteredResults, query);
              document.getElementById('searchResultsInput').blur();
            }
          }
        });
      }
      if (searchResultsBtn) {
        searchResultsBtn.addEventListener('click', function() {
          const query = document.getElementById('searchResultsInput').value.trim();
          if (query) {
            window.currentSearchQuery = query;
            const filteredResults = products.filter(product => 
              (product.name || '').toLowerCase().includes(query.toLowerCase()) ||
              (product.description || '').toLowerCase().includes(query.toLowerCase()) ||
              (product.category || '').toLowerCase().includes(query.toLowerCase()) ||
              (product.tags && product.tags.some(tag => (tag || '').toLowerCase().includes(query.toLowerCase())))
            );
            window.currentSearchResults = filteredResults;
            renderSearchResults(filteredResults, query);
            document.getElementById('searchResultsInput').blur();
          }
        });
      }
    }

    function setupFileUpload() {
      const fileInput = document.getElementById('reviewFile');
      const filePreview = document.getElementById('filePreview');
      if (fileInput) {
        fileInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (!file) return;
          if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
              filePreview.innerHTML = `<img src="${e.target.result}" style="max-width:100%;max-height:200px;border-radius:5px;">`;
            };
            reader.readAsDataURL(file);
          } else if (file.type.startsWith('video/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
              filePreview.innerHTML = `<video controls src="${e.target.result}" style="max-width:100%;max-height:200px;border-radius:5px;"></video>`;
            };
            reader.readAsDataURL(file);
          }
        });
      }
    }

    function handleHashChange() {
      const hash = window.location.hash.substring(1);
      if (!hash) {
        showPage('homePage');
        return;
      }
      if (document.getElementById(hash)) {
        showPage(hash);
      }
      if (hash.includes('productDetailPage?product=')) {
        const productId = hash.split('=')[1];
        const product = products.find(p => p.id === productId);
        if (product) {
          showProductDetail(product);
        }
      }
    }

    function setupEventListeners() {
      if (window._listenersBound) return;
      window._listenersBound = true;
      const menuIcon = safeGetElement('menuIcon');
      const menuClose = safeGetElement('menuClose');
      const menuOverlay = safeGetElement('menuOverlay');
      if (menuIcon) safeAddEventListener(menuIcon, 'click', openMenu);
      if (menuClose) safeAddEventListener(menuClose, 'click', closeMenu);
      if (menuOverlay) safeAddEventListener(menuOverlay, 'click', closeMenu);
      const themeToggle = safeGetElement('themeToggle');
      if (themeToggle) safeAddEventListener(themeToggle, 'click', toggleTheme);
      const searchPanelClose = safeGetElement('searchPanelClose');
      const searchPanelInput = safeGetElement('searchPanelInput');
      const headerSearchInput = safeGetElement('headerSearchInput');
      if (searchPanelClose) safeAddEventListener(searchPanelClose, 'click', closeSearchPanel);
      if (searchPanelInput) safeAddEventListener(searchPanelInput, 'input', handleSearchPanelInput);
      if (headerSearchInput) safeAddEventListener(headerSearchInput, 'click', openSearchPanel);
      const authClose = safeGetElement('authClose');
      const openLoginTop = safeGetElement('openLoginTop');
      const mobileLoginBtn = safeGetElement('mobileLoginBtn');
      if (authClose) safeAddEventListener(authClose, 'click', () => safeGetElement('authModal')?.classList.remove('active'));
      if (openLoginTop) safeAddEventListener(openLoginTop, 'click', showLoginModal);
      if (mobileLoginBtn) safeAddEventListener(mobileLoginBtn, 'click', showLoginModal);
      const loginTab = safeGetElement('loginTab');
      const signupTab = safeGetElement('signupTab');
      const switchToLogin = safeGetElement('switchToLogin');
      if (loginTab) safeAddEventListener(loginTab, 'click', () => switchAuthTab('login'));
      if (signupTab) safeAddEventListener(signupTab, 'click', () => switchAuthTab('signup'));
      if (switchToLogin) safeAddEventListener(switchToLogin, 'click', () => switchAuthTab('login'));
      const loginBtn = safeGetElement('loginBtn');
      const signupBtn = safeGetElement('signupBtn');
      const googleLoginBtn = safeGetElement('googleLoginBtn');
      const googleSignupBtn = safeGetElement('googleSignupBtn');
      if (loginBtn) safeAddEventListener(loginBtn, 'click', handleLogin);
      if (signupBtn) safeAddEventListener(signupBtn, 'click', handleSignup);
      if (googleLoginBtn) safeAddEventListener(googleLoginBtn, 'click', handleGoogleLogin);
      if (googleSignupBtn) safeAddEventListener(googleSignupBtn, 'click', handleGoogleLogin);
      const forgotPasswordLink = safeGetElement('forgotPasswordLink');
      const backToLogin = safeGetElement('backToLogin');
      const resetPasswordBtn = safeGetElement('resetPasswordBtn');
      if (forgotPasswordLink) {
        safeAddEventListener(forgotPasswordLink, 'click', () => {
          safeGetElement('loginForm')?.classList.remove('active');
          safeGetElement('forgotPasswordForm')?.classList.add('active');
        });
      }
      if (backToLogin) {
        safeAddEventListener(backToLogin, 'click', () => {
          safeGetElement('forgotPasswordForm')?.classList.remove('active');
          safeGetElement('loginForm')?.classList.add('active');
        });
      }
      if (resetPasswordBtn) safeAddEventListener(resetPasswordBtn, 'click', handleResetPassword);
      const mobileLogoutBtn = safeGetElement('mobileLogoutBtn');
      const alertCancelBtn = safeGetElement('alertCancelBtn');
      const alertConfirmBtn = safeGetElement('alertConfirmBtn');
      if (mobileLogoutBtn) safeAddEventListener(mobileLogoutBtn, 'click', showLogoutConfirmation);
      if (alertCancelBtn) safeAddEventListener(alertCancelBtn, 'click', () => safeGetElement('alertModal')?.classList.remove('active'));
      if (alertConfirmBtn) safeAddEventListener(alertConfirmBtn, 'click', confirmLogout);
      const zoomClose = safeGetElement('zoomClose');
      const zoomIn = safeGetElement('zoomIn');
      const zoomOut = safeGetElement('zoomOut');
      const zoomReset = safeGetElement('zoomReset');
      if (zoomClose) safeAddEventListener(zoomClose, 'click', () => safeGetElement('zoomModal')?.classList.remove('active'));
      if (zoomIn) safeAddEventListener(zoomIn, 'click', () => adjustZoom(0.2));
      if (zoomOut) safeAddEventListener(zoomOut, 'click', () => adjustZoom(-0.2));
      if (zoomReset) safeAddEventListener(zoomReset, 'click', resetZoom);
      const productImageModalClose = safeGetElement('productImageModalClose');
      const productImageModalPrev = safeGetElement('productImageModalPrev');
      const productImageModalNext = safeGetElement('productImageModalNext');
      if (productImageModalClose) safeAddEventListener(productImageModalClose, 'click', () => safeGetElement('productImageModal')?.classList.remove('active'));
      if (productImageModalPrev) safeAddEventListener(productImageModalPrev, 'click', prevProductModalImage);
      if (productImageModalNext) safeAddEventListener(productImageModalNext, 'click', nextProductModalImage);
      const backToProducts = safeGetElement('backToProducts');
      const toUserInfo = safeGetElement('toUserInfo');
      const editOrder = safeGetElement('editOrder');
      const toPayment = safeGetElement('toPayment');
      const payBack = safeGetElement('payBack');
      const confirmOrderBtn = safeGetElement('confirmOrder');
      const goHome = safeGetElement('goHome');
      const viewOrders = safeGetElement('viewOrders');
      if (backToProducts) safeAddEventListener(backToProducts, 'click', () => showPage('productsPage'));
      if (toUserInfo) safeAddEventListener(toUserInfo, 'click', toUserInfo);
      if (editOrder) safeAddEventListener(editOrder, 'click', () => showPage('orderPage'));
      if (toPayment) safeAddEventListener(toPayment, 'click', toPayment);
      if (payBack) safeAddEventListener(payBack, 'click', () => showPage('userPage'));
      if (confirmOrderBtn) safeAddEventListener(confirmOrderBtn, 'click', confirmOrder);
      if (goHome) safeAddEventListener(goHome, 'click', () => showPage('homePage'));
      if (viewOrders) safeAddEventListener(viewOrders, 'click', () => checkAuthAndShowPage('myOrdersPage'));
      const qtyMinus = document.querySelector('.qty-minus');
      const qtyPlus = document.querySelector('.qty-plus');
      if (qtyMinus) safeAddEventListener(qtyMinus, 'click', decreaseQuantity);
      if (qtyPlus) safeAddEventListener(qtyPlus, 'click', increaseQuantity);
      const applyPriceFilterBtn = safeGetElement('applyPriceFilter');
      const resetPriceFilterBtn = safeGetElement('resetPriceFilter');
      const applySearchPriceFilterBtn = safeGetElement('applySearchPriceFilter');
      const resetSearchPriceFilterBtn = safeGetElement('resetSearchPriceFilter');
      if (applyPriceFilterBtn) safeAddEventListener(applyPriceFilterBtn, 'click', applyPriceFilter);
      if (resetPriceFilterBtn) safeAddEventListener(resetPriceFilterBtn, 'click', resetPriceFilter);
      if (applySearchPriceFilterBtn) safeAddEventListener(applySearchPriceFilterBtn, 'click', applySearchPriceFilter);
      if (resetSearchPriceFilterBtn) safeAddEventListener(resetSearchPriceFilterBtn, 'click', resetSearchPriceFilter);
      const subscribeBtn = safeGetElement('subscribeBtn');
      if (subscribeBtn) safeAddEventListener(subscribeBtn, 'click', handleNewsletterSubscription);
      const detailOrderBtn = safeGetElement('detailOrderBtn');
      const detailWishlistBtn = safeGetElement('detailWishlistBtn');
      if (detailOrderBtn) safeAddEventListener(detailOrderBtn, 'click', orderProductFromDetail);
      if (detailWishlistBtn) safeAddEventListener(detailWishlistBtn, 'click', toggleWishlistFromDetail);
      const prevControl = document.querySelector('.detail-carousel-control.prev');
      const nextControl = document.querySelector('.detail-carousel-control.next');
      if (prevControl) safeAddEventListener(prevControl, 'click', prevDetailImage);
      if (nextControl) safeAddEventListener(nextControl, 'click', nextDetailImage);
      const ratingStars = document.querySelectorAll('.rating-star');
      ratingStars.forEach(star => {
        safeAddEventListener(star, 'click', function() {
          const rating = parseInt(this.getAttribute('data-rating') || '0');
          setRating(rating);
        });
      });
      const submitReview = safeGetElement('submitReview');
      if (submitReview) safeAddEventListener(submitReview, 'click', submitProductReview);
      const copyShareLink = safeGetElement('copyShareLink');
      if (copyShareLink) safeAddEventListener(copyShareLink, 'click', copyShareLink);
      const saveUserInfo = safeGetElement('saveUserInfo');
      if (saveUserInfo) safeAddEventListener(saveUserInfo, 'click', saveUserInfoAndAddress);
      document.querySelectorAll('input[name="pay"]').forEach(radio => {
        safeAddEventListener(radio, 'change', updatePaymentSummary);
      });
      const cancelCancel = safeGetElement('cancelCancel');
      const cancelReturnReplace = safeGetElement('cancelReturnReplace');
      if (cancelCancel) safeAddEventListener(cancelCancel, 'click', () => safeGetElement('cancellationModal')?.classList.remove('active'));
      if (cancelReturnReplace) safeAddEventListener(cancelReturnReplace, 'click', () => safeGetElement('returnReplaceModal')?.classList.remove('active'));
      const whatsappLink = document.querySelector('a[href*="wa.me"]');
      if (whatsappLink) {
        safeAddEventListener(whatsappLink, 'click', function(e) {
          e.preventDefault();
          const message = "Hello Buyzo Cart, I need help with my order üòÇ Please assist me with my query.";
          const phone = "9557987574";
          window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
        });
      }
      const clearHistoryBtn = safeGetElement('clearHistoryBtn');
      if (clearHistoryBtn) safeAddEventListener(clearHistoryBtn, 'click', clearSearchHistory);
      window.addEventListener('hashchange', handleHashChange);
      setupFileUpload();
    }

    function initApp() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      recentSearches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
      setupEventListeners();
      if (window.firebase && window.firebase.auth) {
        window.firebase.onAuthStateChanged(window.firebase.auth, user => {
          if (user) {
            currentUser = user;
            updateUIForUser(user);
            loadUserData(user);
            loadRecentlyViewed(user);
            loadSavedAddresses();
            setupOrderListener();
            document.getElementById('authModal')?.classList.remove('active');
          } else {
            currentUser = null;
            updateUIForGuest();
          }
        });
      }
      loadCachedData();
      fetchLiveData();
      setupRealtimeListeners();
      showPage('homePage');
      setupHeroMessages();
      updateBottomNav();
      setupHeaderSearchScroll();
      setupBackButton();
      setupSearchInput();
      setupViewAllRatings();
      updateAdminSettingsUI();
      updateMenuHandlers();
      window.sliderController = new GlobalSliderController();
      if (window.location.hash && window.location.hash.includes('productDetailPage?product=')) {
        const productId = window.location.hash.split('=')[1];
        const checkProducts = setInterval(() => {
          if (products.length > 0) {
            const product = products.find(p => p.id === productId);
            if (product) {
              showProductDetail(product);
            }
            clearInterval(checkProducts);
          }
        }, 100);
      }
      window.addEventListener('beforeunload', () => {
        if (window.sliderController) {
          window.sliderController.destroy();
        }
        if (autoSlideInterval) clearInterval(autoSlideInterval);
        if (bannerAutoSlideInterval) clearInterval(bannerAutoSlideInterval);
        if (trendingAutoSlideInterval) clearInterval(trendingAutoSlideInterval);
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      if (typeof initApp === 'function') {
        initApp();
      }
    });
  </script>
</body>
</html>