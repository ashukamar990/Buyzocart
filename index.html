<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyzocart Shop - Best Deals & Products</title>
  <meta name="description" content="Buyzo Cart - Best online shopping deals, secure checkout, and superfast delivery."/>
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://buyzocartshop.com/">
  <meta property="og:image" content="https://buyzocartshop.com/logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://images.unsplash.com"/>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <style>
    /* All the CSS styles from the original file remain here */
    /* ... (CSS content remains exactly the same) ... */
  </style>
</head>
<body>
  <!-- Mobile Menu Overlay -->
  <div class="menu-overlay" id="menuOverlay"></div>
  
  <!-- Mobile Menu -->
  <div class="mobile-menu" id="mobileMenu">
    <!-- Mobile menu content remains the same -->
    <!-- ... (Mobile menu content remains the same) ... -->
  </div>

  <header>
    <!-- Header content remains the same -->
    <!-- ... (Header content remains the same) ... -->
  </header>

  <main class="container">
    <!-- Home Page -->
    <section class="page active" id="homePage">
      <!-- Home page content remains the same -->
      <!-- ... (Home page content remains the same) ... -->
    </section>

    <!-- Products Page -->
    <section class="page" id="productsPage">
      <!-- Products page content remains the same -->
      <!-- ... (Products page content remains the same) ... -->
    </section>

    <!-- Product Detail Page -->
    <section class="page" id="productDetailPage">
      <div class="product-detail-page">
        <!-- Breadcrumb Navigation -->
        <div class="breadcrumb">
          <a href="#" onclick="showPage('homePage')">Home</a>
          <span>></span>
          <a href="#" onclick="showPage('productsPage')">Products</a>
          <span>></span>
          <span id="breadcrumbProductName">Product Details</span>
        </div>
        
        <div class="back-to-products" onclick="showPage('productsPage')">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back to Products
        </div>
        
        <div class="product-detail-container">
          <div class="product-detail-gallery">
            <div class="product-detail-main-image" id="productDetailMainImage">
              <button class="detail-carousel-control prev">&#10094;</button>
              <button class="detail-carousel-control next">&#10095;</button>
              <div class="detail-carousel-dots" id="detailCarouselDots"></div>
            </div>
            <div class="product-detail-thumbnails" id="productDetailThumbnails"></div>
          </div>
          
          <div class="product-detail-info">
            <h1 class="product-detail-title" id="detailTitle"></h1>
            <!-- Product SKU -->
            <div class="product-sku" id="detailSku"></div>
            <div class="product-detail-price" id="detailPrice"></div>
            <!-- Stock Status -->
            <div class="stock-status in-stock" id="detailStockStatus">In Stock</div>
            <div class="product-detail-desc" id="detailDesc"></div>
            <div class="product-detail-full-desc" id="detailFullDesc"></div>
            
            <!-- NEW: Enhanced Rating and Reviews Section -->
            <div class="product-detail-meta">
              <h4>Customer Reviews</h4>
              <div class="product-rating-overview">
                <div class="rating-stars">
                  <span class="stars">★★★★★</span>
                  <span class="rating-value">4.5</span>
                  <span class="review-count">(128 reviews)</span>
                </div>
                <button class="btn secondary" id="writeReviewBtn">Write a Review</button>
              </div>
              
              <!-- Review Form (Initially Hidden) -->
              <div class="review-form" id="reviewForm" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                <h5>Write Your Review</h5>
                <div class="rating-input" style="margin-bottom: 12px;">
                  <label>Your Rating:</label>
                  <div class="star-rating" id="starRating">
                    <span data-rating="1">☆</span>
                    <span data-rating="2">☆</span>
                    <span data-rating="3">☆</span>
                    <span data-rating="4">☆</span>
                    <span data-rating="5">☆</span>
                  </div>
                </div>
                <div style="margin-bottom: 12px;">
                  <label for="reviewTitle">Review Title</label>
                  <input type="text" id="reviewTitle" placeholder="Give your review a title" style="width: 100%; padding: 8px; border-radius: var(--radius); border: 1px solid var(--border);">
                </div>
                <div style="margin-bottom: 12px;">
                  <label for="reviewMessage">Your Review</label>
                  <textarea id="reviewMessage" placeholder="Share your experience with this product" rows="3" style="width: 100%; padding: 8px; border-radius: var(--radius); border: 1px solid var(--border);"></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                  <button class="btn" id="submitReviewBtn">Submit Review</button>
                  <button class="btn secondary" id="cancelReviewBtn">Cancel</button>
                </div>
              </div>
              
              <!-- Reviews List -->
              <div class="reviews-list" id="reviewsList" style="margin-top: 16px;">
                <!-- Reviews will be dynamically loaded here -->
              </div>
            </div>
            
            <!-- NEW: Share Link Section -->
            <div class="product-detail-meta" style="margin-top: 20px;">
              <h4>Share This Product</h4>
              <div style="display: flex; gap: 10px; margin-top: 10px;">
                <input type="text" id="productShareLink" readonly style="flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: var(--radius); background: #f8fafc;">
                <button class="btn secondary" id="copyShareLink">Copy Link</button>
              </div>
            </div>
            
            <!-- Social Sharing Buttons -->
            <div class="social-sharing">
              <button class="share-btn facebook" data-platform="facebook">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                </svg>
                Share
              </button>
              <button class="share-btn twitter" data-platform="twitter">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                </svg>
                Tweet
              </button>
              <button class="share-btn whatsapp" data-platform="whatsapp">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335 .157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                </svg>
                Share
              </button>
            </div>
            
            <!-- NEW: Sticky Order and Wishlist Buttons -->
            <div class="sticky-product-actions">
              <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:20px;">
                <button class="btn" id="detailOrderBtn">Order Now</button>
                <button class="btn secondary" id="detailWishlistBtn">Add to Wishlist</button>
                <button class="btn secondary" onclick="showPage('productsPage')">Continue Shopping</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Similar Products Section -->
        <div class="similar-products">
          <h2 class="similar-title">Similar Products</h2>
          <div class="slider-container">
            <div class="slider-track" id="similarProductsSlider"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Order Details Page -->
    <section class="page" id="orderPage">
      <!-- Order page content remains the same -->
      <!-- ... (Order page content remains the same) ... -->
    </section>

    <!-- User Info Page -->
    <section class="page" id="userPage">
      <div class="card-panel">
        <h3 style="margin-top:0">Your Contact & Delivery Address</h3>
        <p style="color:var(--muted)">We do not use saved addresses. Please provide a fresh delivery address for this order.</p>

        <div style="display:flex;gap:16px;flex-direction:column">
          <div>
            <label>Full Name *</label>
            <input id="fullname" placeholder="Enter full name" />
          </div>
          <div class="row">
            <div class="col"><label>Mobile Number *</label><input id="mobile" placeholder="10-digit mobile number" /></div>
            <div class="col"><label>Pincode *</label><input id="pincode" placeholder="Pincode" /></div>
          </div>
          <div class="row">
            <div class="col"><label>City *</label><input id="city" /></div>
            <div class="col"><label>State *</label><input id="state" /></div>
          </div>
          <div>
            <label>House / Street *</label>
            <input id="house" />
          </div>
          
          <!-- NEW: Save Address Checkbox -->
          <div style="margin-top: 12px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="saveAddressCheckbox" />
              <span>Save this address to my account</span>
            </label>
          </div>
          
          <div style="display:flex;gap:10px;margin-top:16px;flex-wrap:wrap">
            <button id="toPayment" class="btn" style="flex:1">Continue to Payment</button>
            <button id="editOrder" class="btn secondary" style="flex:1">Edit Order Details</button>
            <button id="saveUserInfo" class="btn secondary" style="flex:1">Save Information</button>
          </div>
          <div style="margin-top:16px;color:var(--muted);font-size:14px">
            <strong>Note:</strong> If you prefer to change products, click "Edit Order Details" or use "Products" to go back.
          </div>
        </div>
      </div>
    </section>

    <!-- Payment Page -->
    <section class="page" id="paymentPage">
      <div class="card-panel">
        <h3 style="margin-top:0">Payment Method</h3>
        
        <!-- NEW: Payment Gateway Charge Note -->
        <div class="payment-charge-note" style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: var(--radius); padding: 12px; margin-bottom: 16px;">
          <strong>Note:</strong> For online payments, a payment gateway charge of 2% may apply. This charge will be added to your total amount.
        </div>
        
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px">
          <label style="flex:1;display:flex;align-items:center;gap:8px;padding:12px;border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;">
            <input type="radio" name="pay" value="prepaid" checked /> Prepaid (UPI / Card)
          </label>
          <label style="flex:1;display:flex;align-items:center;gap:8px;padding:12px;border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;">
            <input type="radio" name="pay" value="cod" /> Cash on Delivery (Note: may increase processing time)
          </label>
        </div>
        
        <div class="summary">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px"><div>Product</div><div id="sumProduct">-</div></div>
          <div style="display:flex;justify-content:space-between;margin-bottom:8px"><div>Qty</div><div id="sumQty">-</div></div>
          <div style="display:flex;justify-content:space-between;margin-bottom:8px"><div>Price</div><div id="sumPrice">-</div></div>
          <div style="display:flex;justify-content:space-between;margin-bottom:8px"><div>Delivery</div><div id="sumDel">₹50</div></div>
          
          <!-- NEW: Payment Gateway Charge Line -->
          <div style="display:flex;justify-content:space-between;margin-bottom:12px;padding-bottom:8px;border-bottom:1px dashed var(--border);display:none;" id="paymentChargeRow">
            <div>Payment Gateway Charge</div>
            <div id="sumCharge">₹0</div>
          </div>
          
          <div style="display:flex;justify-content:space-between;font-weight:700;margin-top:8px;font-size:18px"><div>Total</div><div id="sumTotal">-</div></div>
        </div>
        
        <div style="height:16px"></div>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <button id="confirmOrder" class="btn" style="flex:1">Confirm & Place Order</button>
          <button id="payBack" class="btn secondary" style="flex:1">Back</button>
        </div>
      </div>
    </section>

    <!-- Order Success (hidden) -->
    <section class="page center" id="successPage">
      <div class="card-panel" style="max-width:520px;margin:32px auto;padding:32px">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin:0 auto 16px">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        <div style="font-size:24px;font-weight:700;color:var(--success);margin-bottom:8px" id="successTitle">Your Order is Placed ✅</div>
        <div style="margin-top:10px;color:var(--muted)" id="successMessage">
          Order ID: <strong id="orderIdDisplay"></strong><br>
          Take screenshot for future reference.
        </div>
        <div style="margin-top:24px;display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
          <button id="goHome" class="btn">Back to Home</button>
          <button id="viewOrders" class="btn secondary">View My Orders</button>
        </div>
      </div>
    </section>

    <!-- My Orders Page -->
    <section class="page" id="myOrdersPage">
      <div class="policy-page">
        <div class="back-button" onclick="showPage('homePage')">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back to Home
        </div>
        
        <div class="orders-container">
          <h2>My Orders</h2>
          <p style="color:var(--muted);margin-bottom:24px">View and manage your recent orders</p>
          
          <div id="ordersList">
            <!-- Orders will be dynamically inserted here -->
          </div>
          
          <div id="orders-empty" class="empty-state" style="display:none">
            <img src="https://cdn-icons-png.flaticon.com/512/891/891419.png" class="empty-icon">
            <h3>No Orders Yet</h3>
            <p>Your orders will appear here after you place them.</p>
            <a href="#" class="empty-btn" onclick="showPage('productsPage')">Start Shopping</a>
          </div>
        </div>
      </div>
    </section>

    <!-- Order Detail Page -->
    <section class="page" id="orderDetailPage">
      <div class="policy-page">
        <div class="back-button" onclick="showMyOrders(); showPage('myOrdersPage');">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back to My Orders
        </div>
        
        <div class="orders-container">
          <h2>Order Details</h2>
          
          <div class="order-detail-page" id="orderDetailContent">
            <!-- Order details will be dynamically inserted here -->
          </div>
        </div>
      </div>
    </section>

    <!-- Other pages remain the same -->
    <!-- ... (Other pages remain the same) ... -->

    <!-- Account Page -->
    <section class="page" id="accountPage">
      <div class="account-page">
        <div class="back-button" onclick="showPage('homePage')">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back to Home
        </div>
        
        <!-- NEW: Professional Account Header -->
        <div class="professional-header">
          <div class="account-header">
            <div class="account-avatar" id="accountPageAvatar">
              <img class="account-avatar-img" id="accountPageAvatarImg" style="display:none;" />
              <span id="accountPageAvatarInitial">U</span>
            </div>
            <div class="account-info">
              <h2 id="accountPageName">User Name</h2>
              <p id="accountPageEmail">user@example.com</p>
            </div>
          </div>
        </div>
        
        <div class="account-menu">
          <div class="account-menu-item" onclick="showPage('myOrdersPage')">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="9" cy="21" r="1"></circle>
              <circle cx="20" cy="21" r="1"></circle>
              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg>
            <span>My Orders</span>
          </div>
          <div class="account-menu-item" onclick="showPage('wishlistPage')">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
            <span>Wishlist</span>
          </div>
          <div class="account-menu-item" onclick="showPage('addressPage')">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            <span>Addresses</span>
          </div>
          <div class="account-menu-item" onclick="showPage('settingsPage')">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
            <span>Settings</span>
          </div>
        </div>
        
        <div class="account-section professional">
          <h3>Profile Information</h3>
          <div class="profile-form">
            <div>
              <label>Full Name</label>
              <input type="text" id="profileName" placeholder="Enter your full name">
            </div>
            <div>
              <label>Email Address</label>
              <input type="email" id="profileEmail" placeholder="Enter your email" readonly>
            </div>
            <div>
              <label>Phone Number</label>
              <input type="tel" id="profilePhone" placeholder="Enter your phone number">
            </div>
            <button class="btn" id="saveProfile">Save Changes</button>
          </div>
        </div>
        
        <div class="account-section professional">
          <h3>Account Security</h3>
          <div class="setting-item">
            <div class="setting-info">
              <h4>Change Password</h4>
              <p>Update your password regularly to keep your account secure</p>
            </div>
            <button class="btn secondary" id="changePasswordBtn">Change</button>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <h4>Two-Factor Authentication</h4>
              <p>Add an extra layer of security to your account</p>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="twoFactorToggle">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
        
        <div class="account-section professional">
          <h3>Login Activity</h3>
          <p>Last login: <span id="lastLoginTime">Loading...</span></p>
          <button class="btn secondary" id="viewLoginActivity">View All Activity</button>
        </div>

        <!-- NEW: Logout Section - Added at the bottom -->
        <div class="account-section professional">
          <h3>Session</h3>
          <p>Sign out from your account on this device.</p>
          <button class="logout-btn" id="accountLogoutBtn" style="margin-top: 16px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Logout
          </button>
        </div>
        
        <div class="account-section danger-zone">
          <h3>Danger Zone</h3>
          <p>Once you delete your account, there is no going back. Please be certain.</p>
          <button class="btn error" id="deleteAccountBtn">Delete Account</button>
        </div>
      </div>
    </section>

    <!-- Settings Page -->
    <section class="page" id="settingsPage">
      <div class="account-page">
        <div class="back-button" onclick="showPage('accountPage')">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back to Account
        </div>
        
        <h2>Settings</h2>
        
        <div class="account-section professional">
          <h3>Notifications</h3>
          <div class="setting-item">
            <div class="setting-info">
              <h4>Email Notifications</h4>
              <p>Receive order updates and promotional emails</p>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="emailNotifications" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <h4>SMS Notifications</h4>
              <p>Receive order updates via SMS</p>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="smsNotifications" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <h4>Push Notifications</h4>
              <p>Receive push notifications on your device</p>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="pushNotifications" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
        
        <div class="account-section professional">
          <h3>Privacy</h3>
          <div class="setting-item">
            <div class="setting-info">
              <h4>Personalized Recommendations</h4>
              <p>Get product recommendations based on your browsing history</p>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="personalizedRecs" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <h4>Data Sharing</h4>
              <p>Allow us to use your data to improve our services</p>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="dataSharing" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
        
        <div class="account-section professional">
          <h3>Appearance</h3>
          <div class="setting-item">
            <div class="setting-info">
              <h4>Dark Mode</h4>
              <p>Toggle between light and dark theme</p>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="darkModeToggle">
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <h4>Language</h4>
              <p>Select your preferred language</p>
            </div>
            <select id="languageSelect">
              <option value="en">English</option>
              <option value="hi">Hindi</option>
            </select>
          </div>
        </div>
        
        <div class="account-section professional">
          <h3>Preferences</h3>
          <div class="setting-item">
            <div class="setting-info">
              <h4>Currency</h4>
              <p>Select your preferred currency</p>
            </div>
            <select id="currencySelect">
              <option value="INR">Indian Rupee (₹)</option>
              <option value="USD">US Dollar ($)</option>
            </select>
          </div>
        </div>
        
        <button class="btn" id="saveSettings">Save Settings</button>
      </div>
    </section>

    <!-- Address Page -->
    <section class="page" id="addressPage">
      <div class="account-page">
        <div class="back-button" onclick="showPage('accountPage')">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back to Account
        </div>
        
        <h2>My Addresses</h2>
        
        <div class="account-section professional">
          <h3>Saved Addresses</h3>
          <div id="savedAddresses">
            <!-- Address cards will be dynamically inserted here -->
          </div>
          <button class="btn" id="addNewAddress" style="margin-top: 16px;">Add New Address</button>
        </div>
        
        <div class="account-section professional" id="newAddressForm" style="display: none;">
          <h3>Add New Address</h3>
          <div class="profile-form">
            <div>
              <label>Full Name *</label>
              <input type="text" id="addressName" placeholder="Enter full name">
            </div>
            <div>
              <label>Mobile Number *</label>
              <input type="tel" id="addressMobile" placeholder="10-digit mobile number">
            </div>
            <div class="row">
              <div class="col">
                <label>Pincode *</label>
                <input type="text" id="addressPincode" placeholder="Pincode">
              </div>
              <div class="col">
                <label>City *</label>
                <input type="text" id="addressCity" placeholder="City">
              </div>
            </div>
            <div class="row">
              <div class="col">
                <label>State *</label>
                <input type="text" id="addressState" placeholder="State">
              </div>
              <div class="col">
                <label>Address Type</label>
                <select id="addressType">
                  <option value="home">Home</option>
                  <option value="work">Work</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
            <div>
              <label>House / Street *</label>
              <textarea id="addressStreet" placeholder="House no., Building, Street, Area" rows="3"></textarea>
            </div>
            <div class="row">
              <div class="col">
                <button class="btn" id="saveAddress">Save Address</button>
              </div>
              <div class="col">
                <button class="btn secondary" id="cancelAddAddress">Cancel</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <!-- Footer content remains the same -->
    <!-- ... (Footer content remains the same) ... -->
  </footer>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <!-- Login/Signup Modal -->
  <div class="modal-overlay" id="authModal">
    <div class="auth-modal">
      <button class="auth-close" id="authClose">×</button>
      <h3>Welcome to Buyzo Cart</h3>
      
      <div class="auth-tabs">
        <div class="auth-tab active" id="loginTab">Login</div>
        <div class="auth-tab" id="signupTab">Sign Up</div>
      </div>
      
      <!-- Login Form -->
      <div class="auth-form active" id="loginForm">
        <div class="auth-form-group">
          <label>Email</label>
          <input type="email" id="loginEmail" placeholder="Enter your email">
        </div>
        <div class="auth-form-group">
          <label>Password</label>
          <input type="password" id="loginPassword" placeholder="Enter your password">
        </div>
        <!-- NEW: Login Error Display -->
        <div id="loginError" style="color:red; font-size:14px; margin-bottom:12px;"></div>
        <button class="btn" id="loginBtn" style="width:100%">Login</button>
        
        <div class="divider"><span>or</span></div>
        
        <button class="google-signin-btn" id="googleLoginBtn">
          <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google">
          Continue with Google
        </button>
        
        <div class="auth-form-footer">
          <a id="forgotPasswordLink">Forgot Password?</a>
        </div>
      </div>
      
      <!-- Signup Form -->
      <div class="auth-form" id="signupForm">
        <div class="auth-form-group">
          <label>Full Name</label>
          <input type="text" id="signupName" placeholder="Enter your full name">
        </div>
        <div class="auth-form-group">
          <label>Email</label>
          <input type="email" id="signupEmail" placeholder="Enter your email">
        </div>
        <div class="auth-form-group">
          <label>Password</label>
          <input type="password" id="signupPassword" placeholder="Create a password">
        </div>
        <!-- NEW: Signup Error Display -->
        <div id="signupError" style="color:red; font-size:14px; margin-bottom:12px;"></div>
        <button class="btn" id="signupBtn" style="width:100%">Sign Up</button>
        
        <div class="divider"><span>or</span></div>
        
        <button class="google-signin-btn" id="googleSignupBtn">
          <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google">
          Continue with Google
        </button>
        
        <div class="auth-form-footer">
          Already have an account? <a id="switchToLogin">Login</a>
        </div>
      </div>
      
      <!-- Forgot Password Form -->
      <div class="forgot-password-form" id="forgotPasswordForm">
        <div class="auth-form-group">
          <label>Email</label>
          <input type="email" id="forgotPasswordEmail" placeholder="Enter your email">
        </div>
        <button class="btn" id="resetPasswordBtn" style="width:100%">Reset Password</button>
        <div class="back-to-login" id="backToLogin">Back to Login</div>
      </div>
    </div>
  </div>

  <!-- Image Zoom Modal -->
  <div class="modal-overlay zoom-modal" id="zoomModal">
    <div class="zoom-content">
      <button class="zoom-close" id="zoomClose">×</button>
      <img class="zoom-image" id="zoomImage" src="" alt="Zoomed product image">
      <div class="zoom-controls">
        <button class="zoom-btn" id="zoomIn">+</button>
        <button class="zoom-btn" id="zoomOut">-</button>
        <button class="zoom-btn" id="zoomReset">⟲</button>
      </div>
    </div>
  </div>

  <!-- Cancellation Modal -->
  <div class="modal-overlay" id="cancellationModal">
    <div class="cancellation-modal">
      <h3>Cancel Order</h3>
      <p>Please select a reason for cancellation:</p>
      
      <div class="cancellation-reason selected">
        <label>
          <input type="radio" name="cancelReason" value="changed-mind" checked> Changed my mind
        </label>
      </div>
      <div class="cancellation-reason">
        <label>
          <input type="radio" name="cancelReason" value="shipping-delay"> Shipping is taking too long
        </label>
      </div>
      <div class="cancellation-reason">
        <label>
          <input type="radio" name="cancelReason" value="found-better-price"> Found a better price elsewhere
        </label>
      </div>
      <div class="cancellation-reason">
        <label>
          <input type="radio" name="cancelReason" value="ordered-by-mistake"> Ordered by mistake
        </label>
      </div>
      <div class="cancellation-reason">
        <label>
          <input type="radio" name="cancelReason" value="other"> Other reason
        </label>
      </div>
      
      <div class="cancellation-actions">
        <button class="btn secondary" id="cancelCancel">Cancel</button>
        <button class="btn error" id="confirmCancel">Confirm Cancellation</button>
      </div>
    </div>
  </div>

  <!-- Cancel Order Confirmation Modal -->
  <div class="modal-overlay" id="cancelConfirmModal">
    <div class="cancel-confirm-modal">
      <h3>Cancel Order</h3>
      <p>Are you sure you want to cancel this order? This action cannot be undone.</p>
      
      <div class="payment-charge-note">
        <strong>Note:</strong> If you paid online, your refund will be processed within 5-7 business days.
      </div>
      
      <div class="refund-calculation">
        <p><strong>Refund Details:</strong></p>
        <p>Order Total: <span id="refundOrderTotal">₹0</span></p>
        <p>Payment Gateway Charges (if any): <span id="refundCharges">₹0</span></p>
        <p style="font-weight:bold;color:var(--success)">Net Refund Amount: <span id="refundNetAmount">₹0</span></p>
      </div>
      
      <div class="cancel-confirm-actions">
        <button class="btn secondary" id="cancelCancelConfirm">No, Keep Order</button>
        <button class="btn error" id="finalConfirmCancel">Yes, Cancel Order</button>
      </div>
    </div>
  </div>

  <!-- Alert Modal -->
  <div class="modal-overlay" id="alertModal">
    <div class="alert-modal">
      <div class="alert-icon">⚠️</div>
      <h3 id="alertTitle">Alert</h3>
      <p id="alertMessage">This is an alert message.</p>
      <!-- NEW: Updated buttons for alert modal -->
      <div class="alert-modal-buttons">
        <button class="btn secondary" id="alertCancelBtn">Cancel</button>
        <button class="btn" id="alertConfirmBtn">Yes</button>
      </div>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div class="modal-overlay" id="changePasswordModal">
    <div class="auth-modal">
      <button class="auth-close" id="changePasswordClose">×</button>
      <h3>Change Password</h3>
      <p>Enter your email address to receive a password reset link.</p>
      
      <div class="auth-form-group">
        <label>Email Address</label>
        <input type="email" id="changePasswordEmail" placeholder="Enter your email">
      </div>
      
      <button class="btn" id="sendResetLink" style="width:100%">Send Reset Link</button>
    </div>
  </div>

  <!-- Firebase Configuration -->
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAeB7VzIxJaNYagUPoKd-kN5HXmLbS2-Vw",
      authDomain: "videomanager-23d98.firebaseapp.com",
      databaseURL: "https://videomanager-23d98-default-rtdb.firebaseio.com",
      projectId: "videomanager-23d98",
      storageBucket: "videomanager-23d98.firebasestorage.app",
      messagingSenderId: "847321523576",
      appId: "1:847321523576:web:bda3f5026e3e163603548d",
      measurementId: "G-YBSJ1KMPV4"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const realtimeDb = firebase.database();

    // Initialize EmailJS
    emailjs.init("user_your_emailjs_user_id_here");
  </script>

  <!-- JavaScript -->
  <script>
    // Global variables
    let currentUser = null;
    let currentProduct = null;
    let userInfo = {};
    let currentOrderId = null;
    let products = [];
    let categories = [];
    let banners = [];
    let wishlist = [];
    let recentlyViewed = [];
    let currentImageIndex = 0;
    let currentZoomLevel = 1;
    let currentCategoryFilter = null;
    let currentRating = 0;
    let pageHistory = ['homePage'];

    // NEW: Mobile back button handling
    window.addEventListener('popstate', function(event) {
      if (pageHistory.length > 1) {
        pageHistory.pop();
        const previousPage = pageHistory[pageHistory.length - 1];
        showPage(previousPage);
      } else {
        // If no more history, stay on current page
        window.history.pushState(null, null, window.location.href);
      }
    });

    // Product Image Helper Function
    function getProductImage(product, idx = 0) {
      if (!product) return "assets/placeholder.png";
      if (Array.isArray(product.images) && product.images.length > 0) {
        if (idx < product.images.length) return product.images[idx];
        return product.images[0];
      }
      if (product.image) return product.image;
      if (product.img) return product.img;
      if (product.imageUrl) return product.imageUrl;
      if (product.photo) return product.photo;
      return "assets/placeholder.png";
    }

    // NEW: Order ID Generation Function
    function generateOrderId() {
        const date = new Date();
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        const randomNum = Math.floor(100000 + Math.random() * 900000); 
        return `ORDER-${yyyy}${mm}${dd}-${randomNum}`;
    }

    // NEW: LocalStorage Helper Functions
    function saveToLocalStorage(key, data) {
      const item = {
        data: data,
        timestamp: new Date().getTime()
      };
      localStorage.setItem(key, JSON.stringify(item));
    }

    function loadFromLocalStorage(key, maxAge = 5 * 60 * 1000) { // 5 minutes default
      const item = localStorage.getItem(key);
      if (!item) return null;

      const parsed = JSON.parse(item);
      const now = new Date().getTime();
      if (now - parsed.timestamp > maxAge) {
        localStorage.removeItem(key);
        return null;
      }

      return parsed.data;
    }

    // NEW: Realtime Database Listeners
    function setupRealtimeListeners() {
      // Products listener
      realtimeDb.ref('products').on('value', snapshot => {
        const productsObj = snapshot.val();
        if (productsObj) {
          const newProducts = Object.keys(productsObj).map(key => ({
            id: key,
            ...productsObj[key]
          }));
          
          products = newProducts;
          saveToLocalStorage('products', products);
          
          // Update UI if on relevant pages
          if (document.getElementById('homePage').classList.contains('active') || 
              document.getElementById('productsPage').classList.contains('active') ||
              document.getElementById('productDetailPage').classList.contains('active')) {
            renderProducts(products, 'homeProductGrid');
            renderProducts(products, 'productGrid');
            renderProductSlider(products.slice(0, 10), 'productSlider');
          }
        }
      }, error => {
        console.error('Products listener error:', error);
      });

      // Categories listener
      realtimeDb.ref('categories').on('value', snapshot => {
        const categoriesObj = snapshot.val();
        if (categoriesObj) {
          const newCategories = Object.keys(categoriesObj).map(key => ({
            id: key,
            ...categoriesObj[key]
          }));
          
          categories = newCategories;
          saveToLocalStorage('categories', categories);
          
          // Update UI if on relevant pages
          if (document.getElementById('homePage').classList.contains('active') || 
              document.getElementById('productsPage').classList.contains('active')) {
            renderCategories();
            renderCategoryCircles();
          }
        }
      }, error => {
        console.error('Categories listener error:', error);
      });

      // Banners listener
      realtimeDb.ref('banners').on('value', snapshot => {
        const bannersObj = snapshot.val();
        if (bannersObj) {
          const newBanners = Object.keys(bannersObj).map(key => ({
            id: key,
            ...bannersObj[key]
          }));
          
          banners = newBanners;
          saveToLocalStorage('banners', banners);
          
          // Update UI if on home page
          if (document.getElementById('homePage').classList.contains('active')) {
            renderBannerCarousel();
          }
        }
      }, error => {
        console.error('Banners listener error:', error);
      });

      // Orders listener for current user
      if (currentUser) {
        realtimeDb.ref('orders').orderByChild('userId').equalTo(currentUser.uid)
          .on('value', snapshot => {
            const ordersObj = snapshot.val();
            if (ordersObj) {
              const orders = Object.keys(ordersObj).map(key => ({
                id: key,
                ...ordersObj[key]
              }));
              
              // Sort by order date
              orders.sort((a, b) => b.orderDate - a.orderDate);
              
              // Update UI if on orders page
              if (document.getElementById('myOrdersPage').classList.contains('active')) {
                renderOrders(orders);
              }
            } else {
              // No orders
              if (document.getElementById('myOrdersPage').classList.contains('active')) {
                renderOrders([]);
              }
            }
          }, error => {
            console.error('Orders listener error:', error);
          });
      }
    }

    // DOM Elements
    const menuIcon = document.getElementById('menuIcon');
    const mobileMenu = document.getElementById('mobileMenu');
    const menuOverlay = document.getElementById('menuOverlay');
    const menuClose = document.getElementById('menuClose');
    const themeToggle = document.getElementById('themeToggle');
    const toast = document.getElementById('toast');
    const authModal = document.getElementById('authModal');
    const authClose = document.getElementById('authClose');
    const loginTab = document.getElementById('loginTab');
    const signupTab = document.getElementById('signupTab');
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const googleLoginBtn = document.getElementById('googleLoginBtn');
    const googleSignupBtn = document.getElementById('googleSignupBtn');
    const switchToLogin = document.getElementById('switchToLogin');
    const forgotPasswordLink = document.getElementById('forgotPasswordLink');
    const forgotPasswordForm = document.getElementById('forgotPasswordForm');
    const backToLogin = document.getElementById('backToLogin');
    const resetPasswordBtn = document.getElementById('resetPasswordBtn');
    const openLoginTop = document.getElementById('openLoginTop');
    const userProfile = document.getElementById('userProfile');
    const userAvatar = document.getElementById('userAvatar');
    const userAvatarImg = document.getElementById('userAvatarImg');
    const userAvatarInitial = document.getElementById('userAvatarInitial');
    const userName = document.getElementById('userName');
    const mobileLoginBtn = document.getElementById('mobileLoginBtn');
    const mobileUserProfile = document.getElementById('mobileUserProfile');
    const mobileUserName = document.getElementById('mobileUserName');
    const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
    const openMyOrdersTop = document.getElementById('openMyOrdersTop');
    const openContactTop = document.getElementById('openContactTop');
    const accountLogoutBtn = document.getElementById('accountLogoutBtn');
    const zoomModal = document.getElementById('zoomModal');
    const zoomClose = document.getElementById('zoomClose');
    const zoomImage = document.getElementById('zoomImage');
    const zoomIn = document.getElementById('zoomIn');
    const zoomOut = document.getElementById('zoomOut');
    const zoomReset = document.getElementById('zoomReset');
    const changePasswordModal = document.getElementById('changePasswordModal');
    const changePasswordClose = document.getElementById('changePasswordClose');
    const sendResetLink = document.getElementById('sendResetLink');

    // NEW: Error Display Elements
    const loginError = document.getElementById('loginError');
    const signupError = document.getElementById('signupError');

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
      initApp();
      setupEventListeners();
      loadInitialData();
      setupHeroMessages();
      updateStepPills();
      
      // Check authentication state
      auth.onAuthStateChanged(user => {
        if (user) {
          currentUser = user;
          updateUIForUser(user);
          loadUserData(user);
          loadWishlist(user);
          loadRecentlyViewed(user);
          setupRealtimeListeners();
          // NEW: Auto close login modal after successful login
          authModal.classList.remove('active');
        } else {
          currentUser = null;
          updateUIForGuest();
        }
      });
    });

    function initApp() {
      // Set initial theme
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      if (savedTheme === 'dark') {
        document.getElementById('darkModeToggle').checked = true;
      }
      
      // Show home page by default
      showPage('homePage');
      
      // NEW: Push initial state to history
      window.history.pushState({ page: 'homePage' }, null, '');
    }

    // NEW: Load initial data with localStorage caching
    function loadInitialData() {
      // Try to load from localStorage first
      const cachedProducts = loadFromLocalStorage('products');
      const cachedCategories = loadFromLocalStorage('categories');
      const cachedBanners = loadFromLocalStorage('banners');
      
      if (cachedProducts) {
        products = cachedProducts;
        renderProducts(products, 'homeProductGrid');
        renderProducts(products, 'productGrid');
        renderProductSlider(products.slice(0, 10), 'productSlider');
      }
      
      if (cachedCategories) {
        categories = cachedCategories;
        renderCategories();
        renderCategoryCircles();
      }
      
      if (cachedBanners) {
        banners = cachedBanners;
        renderBannerCarousel();
      }
      
      // Then load from Firebase
      loadProducts();
      loadCategories();
      loadBanners();
    }

    function setupEventListeners() {
      // Mobile menu
      menuIcon.addEventListener('click', openMenu);
      menuClose.addEventListener('click', closeMenu);
      menuOverlay.addEventListener('click', closeMenu);
      
      // Theme toggle
      themeToggle.addEventListener('click', toggleTheme);
      
      // Auth modal
      authClose.addEventListener('click', () => authModal.classList.remove('active'));
      openLoginTop.addEventListener('click', showLoginModal);
      mobileLoginBtn.addEventListener('click', showLoginModal);
      
      // Auth tabs
      loginTab.addEventListener('click', () => switchAuthTab('login'));
      signupTab.addEventListener('click', () => switchAuthTab('signup'));
      switchToLogin.addEventListener('click', () => switchAuthTab('login'));
      
      // Auth forms
      loginBtn.addEventListener('click', handleLogin);
      signupBtn.addEventListener('click', handleSignup);
      googleLoginBtn.addEventListener('click', handleGoogleLogin);
      googleSignupBtn.addEventListener('click', handleGoogleLogin);
      
      // Forgot password
      forgotPasswordLink.addEventListener('click', () => {
        loginForm.classList.remove('active');
        forgotPasswordForm.classList.add('active');
      });
      backToLogin.addEventListener('click', () => {
        forgotPasswordForm.classList.remove('active');
        loginForm.classList.add('active');
      });
      resetPasswordBtn.addEventListener('click', handleResetPassword);
      
      // User profile - NEW: Direct navigation to account page
      userProfile.addEventListener('click', () => showPage('accountPage'));
      
      // NEW: Logout buttons
      accountLogoutBtn.addEventListener('click', logout);
      mobileLogoutBtn.addEventListener('click', logout);
      
      // Navigation
      openMyOrdersTop.addEventListener('click', () => checkAuthAndShowPage('myOrdersPage'));
      openContactTop.addEventListener('click', () => showPage('contactPage'));
      
      // Image zoom
      zoomClose.addEventListener('click', () => zoomModal.classList.remove('active'));
      zoomIn.addEventListener('click', () => adjustZoom(0.2));
      zoomOut.addEventListener('click', () => adjustZoom(-0.2));
      zoomReset.addEventListener('click', resetZoom);
      
      // Search functionality
      const searchInput = document.getElementById('searchInput');
      const homeSearchInput = document.getElementById('homeSearchInput');
      
      if (searchInput) {
        searchInput.addEventListener('input', handleSearch);
      }
      
      if (homeSearchInput) {
        homeSearchInput.addEventListener('input', handleHomeSearch);
      }
      
      // Order flow buttons
      document.getElementById('backToProducts')?.addEventListener('click', () => showPage('productsPage'));
      document.getElementById('toUserInfo')?.addEventListener('click', toUserInfo);
      document.getElementById('editOrder')?.addEventListener('click', () => showPage('orderPage'));
      document.getElementById('toPayment')?.addEventListener('click', toPayment);
      document.getElementById('payBack')?.addEventListener('click', () => showPage('userPage'));
      document.getElementById('confirmOrder')?.addEventListener('click', confirmOrder);
      document.getElementById('goHome')?.addEventListener('click', () => showPage('homePage'));
      document.getElementById('viewOrders')?.addEventListener('click', () => checkAuthAndShowPage('myOrdersPage'));
      
      // Quantity controls
      document.querySelector('.qty-minus')?.addEventListener('click', decreaseQuantity);
      document.querySelector('.qty-plus')?.addEventListener('click', increaseQuantity);
      
      // Size selection
      document.querySelectorAll('.size-option').forEach(option => {
        option.addEventListener('click', function() {
          document.querySelectorAll('.size-option').forEach(opt => opt.classList.remove('selected'));
          this.classList.add('selected');
          document.getElementById('sizeValidationError').classList.remove('show');
        });
      });
      
      // Price filter
      document.getElementById('applyPriceFilter')?.addEventListener('click', applyPriceFilter);
      document.getElementById('resetPriceFilter')?.addEventListener('click', resetPriceFilter);
      
      // Newsletter
      document.getElementById('subscribeBtn')?.addEventListener('click', handleNewsletterSubscription);
      
      // Share buttons
      document.querySelectorAll('.share-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const platform = this.getAttribute('data-platform');
          shareProduct(platform);
        });
      });
      
      // Copy share link
      document.getElementById('copyShareLink')?.addEventListener('click', copyShareLink);
      
      // Product detail buttons
      document.getElementById('detailOrderBtn')?.addEventListener('click', orderProductFromDetail);
      document.getElementById('detailWishlistBtn')?.addEventListener('click', toggleWishlistFromDetail);
      
      // NEW: Review functionality
      document.getElementById('writeReviewBtn')?.addEventListener('click', showReviewForm);
      document.getElementById('cancelReviewBtn')?.addEventListener('click', hideReviewForm);
      document.getElementById('submitReviewBtn')?.addEventListener('click', submitReview);
      
      // NEW: Star rating
      document.querySelectorAll('#starRating span').forEach(star => {
        star.addEventListener('click', function() {
          const rating = parseInt(this.getAttribute('data-rating'));
          setRating(rating);
        });
      });
      
      // NEW: Payment method change
      document.querySelectorAll('input[name="pay"]').forEach(radio => {
        radio.addEventListener('change', updatePaymentSummary);
      });
      
      // Account page
      document.getElementById('saveProfile')?.addEventListener('click', saveProfile);
      document.getElementById('changePasswordBtn')?.addEventListener('click', showChangePasswordModal);
      document.getElementById('deleteAccountBtn')?.addEventListener('click', deleteAccount);
      document.getElementById('saveSettings')?.addEventListener('click', saveSettings);
      
      // NEW: Change password modal
      changePasswordClose.addEventListener('click', () => changePasswordModal.classList.remove('active'));
      sendResetLink.addEventListener('click', handleChangePassword);
      
      // Address page
      document.getElementById('addNewAddress')?.addEventListener('click', showNewAddressForm);
      document.getElementById('cancelAddAddress')?.addEventListener('click', hideNewAddressForm);
      document.getElementById('saveAddress')?.addEventListener('click', saveAddress);
      
      // Dark mode toggle in settings
      document.getElementById('darkModeToggle')?.addEventListener('change', function() {
        toggleTheme();
      });

      // Product detail image click to open zoom
      document.getElementById('productDetailMainImage')?.addEventListener('click', openImageZoom);
      
      // Product detail carousel controls
      document.querySelector('.detail-carousel-control.prev')?.addEventListener('click', prevDetailImage);
      document.querySelector('.detail-carousel-control.next')?.addEventListener('click', nextDetailImage);
      
      // NEW: Banner swipe functionality
      setupBannerSwipe();
    }

    // NEW: Banner swipe functionality
    function setupBannerSwipe() {
      const bannerTrack = document.getElementById('bannerTrack');
      if (!bannerTrack) return;
      
      let startX = 0;
      let currentX = 0;
      let isSwiping = false;
      
      bannerTrack.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        isSwiping = true;
      });
      
      bannerTrack.addEventListener('touchmove', (e) => {
        if (!isSwiping) return;
        currentX = e.touches[0].clientX;
      });
      
      bannerTrack.addEventListener('touchend', () => {
        if (!isSwiping) return;
        
        const diff = startX - currentX;
        const activeIndex = banners.findIndex((_, index) => 
          document.querySelector(`.banner-dot:nth-child(${index + 1})`).classList.contains('active')
        );
        
        if (diff > 50 && activeIndex < banners.length - 1) {
          // Swipe left - next slide
          setBannerSlide(activeIndex + 1);
        } else if (diff < -50 && activeIndex > 0) {
          // Swipe right - previous slide
          setBannerSlide(activeIndex - 1);
        }
        
        isSwiping = false;
      });
    }

    // NEW: Improved Authentication Functions with Error Handling
    async function handleLogin() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      // Clear previous errors
      loginError.textContent = '';
      
      if (!email || !password) {
        loginError.textContent = 'Please fill in all fields';
        return;
      }
      
      try {
        loginBtn.disabled = true;
        loginBtn.innerHTML = '<div class="loading-spinner"></div> Logging in...';
        
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        
        // Update last login time
        await realtimeDb.ref('users/' + userCredential.user.uid).update({
          lastLoginAt: Date.now()
        });
        
        showToast('Login successful!', 'success');
        authModal.classList.remove('active');
        
        // Clear form
        document.getElementById('loginEmail').value = '';
        document.getElementById('loginPassword').value = '';
      } catch (err) {
        console.error('Login error:', err);
        // Display error in the form, not as popup
        loginError.textContent = err.message;
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Login';
      }
    }

    async function handleSignup() {
      const name = document.getElementById('signupName').value;
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      
      // Clear previous errors
      signupError.textContent = '';
      
      if (!name || !email || !password) {
        signupError.textContent = 'Please fill in all fields';
        return;
      }
      
      if (password.length < 6) {
        signupError.textContent = 'Password should be at least 6 characters';
        return;
      }
      
      try {
        signupBtn.disabled = true;
        signupBtn.innerHTML = '<div class="loading-spinner"></div> Creating account...';
        
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Save user profile
        await realtimeDb.ref('users/' + user.uid).set({
          name: name,
          email: email,
          createdAt: Date.now(),
          lastLoginAt: Date.now()
        });
        
        showToast('Account created successfully!', 'success');
        authModal.classList.remove('active');
        
        // Clear form
        document.getElementById('signupName').value = '';
        document.getElementById('signupEmail').value = '';
        document.getElementById('signupPassword').value = '';
      } catch (err) {
        console.error('Signup error:', err);
        // Display error in the form, not as popup
        signupError.textContent = err.message;
      } finally {
        signupBtn.disabled = false;
        signupBtn.textContent = 'Sign Up';
      }
    }

    async function handleGoogleLogin() {
      const provider = new firebase.auth.GoogleAuthProvider();
      
      try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        
        // Check if user exists in Realtime Database
        const userSnapshot = await realtimeDb.ref('users/' + user.uid).once('value');
        
        if (!userSnapshot.exists()) {
          // Create new user document
          await realtimeDb.ref('users/' + user.uid).set({
            name: user.displayName,
            email: user.email,
            photoURL: user.photoURL,
            createdAt: Date.now(),
            lastLoginAt: Date.now()
          });
        } else {
          // Update last login time
          await realtimeDb.ref('users/' + user.uid).update({
            lastLoginAt: Date.now()
          });
        }
        
        showToast('Login successful!', 'success');
        authModal.classList.remove('active');
      } catch (err) {
        console.error('Google login error:', err);
        // Display error in appropriate form
        if (loginForm.classList.contains('active')) {
          loginError.textContent = err.message;
        } else {
          signupError.textContent = err.message;
        }
      }
    }

    async function handleResetPassword() {
      const email = document.getElementById('forgotPasswordEmail').value;
      
      if (!email) {
        showToast('Please enter your email address', 'error');
        return;
      }
      
      try {
        resetPasswordBtn.disabled = true;
        resetPasswordBtn.innerHTML = '<div class="loading-spinner"></div> Sending...';
        
        await auth.sendPasswordResetEmail(email);
        showToast('Password reset email sent!', 'success');
        forgotPasswordForm.classList.remove('active');
        loginForm.classList.add('active');
        
        // Clear form
        document.getElementById('forgotPasswordEmail').value = '';
      } catch (err) {
        console.error('Password reset error:', err);
        showToast(err.message, 'error');
      } finally {
        resetPasswordBtn.disabled = false;
        resetPasswordBtn.textContent = 'Reset Password';
      }
    }

    // NEW: Change password function
    function showChangePasswordModal() {
      changePasswordModal.classList.add('active');
    }

    async function handleChangePassword() {
      const email = document.getElementById('changePasswordEmail').value;
      
      if (!email) {
        showToast('Please enter your email address', 'error');
        return;
      }
      
      try {
        sendResetLink.disabled = true;
        sendResetLink.innerHTML = '<div class="loading-spinner"></div> Sending...';
        
        await auth.sendPasswordResetEmail(email);
        showToast('Password reset link sent to your email!', 'success');
        changePasswordModal.classList.remove('active');
        
        // Clear form
        document.getElementById('changePasswordEmail').value = '';
      } catch (err) {
        console.error('Password reset error:', err);
        showToast(err.message, 'error');
      } finally {
        sendResetLink.disabled = false;
        sendResetLink.textContent = 'Send Reset Link';
      }
    }

    // NEW: Improved Order Placement with Order ID
    async function confirmOrder() {
      if (!currentUser) {
        showLoginModal();
        return;
      }
      
      // Generate Order ID
      const orderId = generateOrderId();
      currentOrderId = orderId;
      
      const paymentMethod = document.querySelector('input[name="pay"]:checked').value;
      const quantity = parseInt(document.getElementById('qtySelect').value);
      const size = document.querySelector('.size-option.selected')?.getAttribute('data-value') || 'Not specified';
      
      // Calculate total with payment gateway charge if applicable
      const productPrice = parseFloat(currentProduct.price.replace('₹', ''));
      const subtotal = productPrice * quantity;
      const deliveryCharge = 50;
      let paymentCharge = 0;
      
      if (paymentMethod === 'prepaid') {
        paymentCharge = subtotal * 0.02; // 2% payment gateway charge
      }
      
      const total = subtotal + deliveryCharge + paymentCharge;
      
      const orderData = {
        orderId: orderId,
        userId: currentUser.uid,
        username: userInfo.fullName || 'Customer',
        productId: currentProduct.id,
        productName: currentProduct.name,
        price: total,
        quantity: quantity,
        size: size,
        paymentMethod: paymentMethod,
        status: 'confirmed',
        orderDate: Date.now(),
        userInfo: userInfo,
        // NEW: Add tracking information
        tracking: {
          status: 'confirmed',
          estimatedDelivery: Date.now() + (7 * 24 * 60 * 60 * 1000), // 7 days from now
          steps: [
            { status: 'confirmed', date: Date.now(), description: 'Order Confirmed' },
            { status: 'processing', date: null, description: 'Processing' },
            { status: 'shipped', date: null, description: 'Shipped' },
            { status: 'delivered', date: null, description: 'Delivered' }
          ]
        }
      };
      
      try {
        // Save to Realtime Database
        await realtimeDb.ref('orders/' + orderId).set(orderData);
        
        // Update UI with order ID
        document.getElementById('orderIdDisplay').textContent = orderId;
        
        // Show success page
        showPage('successPage');
        
        // Send confirmation email
        sendOrderConfirmationEmail(orderData);
        
        // NEW: Save address if checkbox is checked
        const saveAddressCheckbox = document.getElementById('saveAddressCheckbox');
        if (saveAddressCheckbox && saveAddressCheckbox.checked) {
          saveAddressFromOrder(userInfo);
        }
        
        // Clear user info for next order
        userInfo = {};
        
      } catch (error) {
        console.error('Error placing order:', error);
        showToast('Failed to place order. Please try again.', 'error');
      }
    }

    // NEW: Save address from order
    async function saveAddressFromOrder(addressInfo) {
      if (!currentUser) return;
      
      const addressId = 'address_' + Date.now();
      
      try {
        await realtimeDb.ref('addresses/' + addressId).set({
          userId: currentUser.uid,
          name: addressInfo.fullName,
          mobile: addressInfo.mobile,
          pincode: addressInfo.pincode,
          city: addressInfo.city,
          state: addressInfo.state,
          type: 'home',
          street: addressInfo.house,
          isDefault: false,
          createdAt: Date.now()
        });
        
        showToast('Address saved successfully', 'success');
      } catch (error) {
        console.error('Error saving address:', error);
      }
    }

    // Page navigation
    function showPage(pageId) {
      // NEW: Update page history
      if (pageHistory[pageHistory.length - 1] !== pageId) {
        pageHistory.push(pageId);
        window.history.pushState({ page: pageId }, null, '');
      }
      
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(pageId).classList.add('active');
      
      // Update step pills based on current page
      updateStepPills();
      
      // Scroll to top
      window.scrollTo(0, 0);
    }

    function checkAuthAndShowPage(pageId) {
      if (!currentUser) {
        showLoginModal();
        return;
      }
      showPage(pageId);
    }

    function showLoginModal() {
      authModal.classList.add('active');
      switchAuthTab('login');
    }

    function switchAuthTab(tab) {
      // Reset forms
      loginForm.classList.remove('active');
      signupForm.classList.remove('active');
      forgotPasswordForm.classList.remove('active');
      
      // Reset tabs
      loginTab.classList.remove('active');
      signupTab.classList.remove('active');
      
      // Clear errors
      loginError.textContent = '';
      signupError.textContent = '';
      
      if (tab === 'login') {
        loginTab.classList.add('active');
        loginForm.classList.add('active');
      } else {
        signupTab.classList.add('active');
        signupForm.classList.add('active');
      }
    }

    function logout() {
      auth.signOut().then(() => {
        showToast('Logged out successfully', 'success');
        showPage('homePage');
      }).catch(error => {
        console.error('Logout error:', error);
        showToast('Error logging out', 'error');
      });
    }

    // Mobile menu functions
    function openMenu() {
      mobileMenu.classList.add('active');
      menuOverlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      mobileMenu.classList.remove('active');
      menuOverlay.classList.remove('active');
      document.body.style.overflow = '';
    }

    // Theme functions
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      // Update toggle in settings if it exists
      const darkModeToggle = document.getElementById('darkModeToggle');
      if (darkModeToggle) {
        darkModeToggle.checked = newTheme === 'dark';
      }
    }

    // Toast notification
    function showToast(message, type = 'success') {
      toast.textContent = message;
      toast.className = 'toast ' + type;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // User interface updates
    function updateUIForUser(user) {
      userProfile.style.display = 'flex';
      openLoginTop.style.display = 'none';
      mobileLoginBtn.style.display = 'none';
      mobileUserProfile.style.display = 'flex';
      mobileLogoutBtn.style.display = 'flex';
      
      // NEW: Update profile with Google data
      updateUserProfile(user);
      
      // Load user data to display
      realtimeDb.ref('users/' + user.uid).once('value').then(snapshot => {
        if (snapshot.exists()) {
          const userData = snapshot.val();
          userName.textContent = userData.name || user.displayName || 'User';
          mobileUserName.textContent = userData.name || user.displayName || 'User';
          
          // Update account page if open
          if (document.getElementById('accountPageName')) {
            document.getElementById('accountPageName').textContent = userData.name || user.displayName || 'User';
            document.getElementById('accountPageEmail').textContent = user.email;
            document.getElementById('profileName').value = userData.name || user.displayName || '';
            document.getElementById('profileEmail').value = user.email;
            document.getElementById('profilePhone').value = userData.phone || '';
            
            // Update last login time
            if (userData.lastLoginAt) {
              const lastLoginTime = new Date(userData.lastLoginAt).toLocaleString();
              document.getElementById('lastLoginTime').textContent = lastLoginTime;
            }
          }
        }
      });
    }

    // NEW: Function to update user profile with Google data
    function updateUserProfile(user) {
      // Update header avatar and name
      if (user.photoURL) {
        userAvatarImg.src = user.photoURL;
        userAvatarImg.style.display = 'block';
        userAvatarInitial.style.display = 'none';
      } else {
        userAvatarImg.style.display = 'none';
        userAvatarInitial.style.display = 'block';
        userAvatarInitial.textContent = (user.displayName || 'U').charAt(0).toUpperCase();
      }
      
      userName.textContent = user.displayName || 'User';
      
      // Update mobile menu
      mobileUserName.textContent = user.displayName || 'User';
      
      // Update account page
      if (document.getElementById('accountPageAvatarImg')) {
        if (user.photoURL) {
          document.getElementById('accountPageAvatarImg').src = user.photoURL;
          document.getElementById('accountPageAvatarImg').style.display = 'block';
          document.getElementById('accountPageAvatarInitial').style.display = 'none';
        } else {
          document.getElementById('accountPageAvatarImg').style.display = 'none';
          document.getElementById('accountPageAvatarInitial').style.display = 'block';
          document.getElementById('accountPageAvatarInitial').textContent = (user.displayName || 'U').charAt(0).toUpperCase();
        }
        
        document.getElementById('accountPageName').textContent = user.displayName || 'User';
        document.getElementById('accountPageEmail').textContent = user.email;
      }
    }

    function updateUIForGuest() {
      userProfile.style.display = 'none';
      openLoginTop.style.display = 'block';
      mobileLoginBtn.style.display = 'flex';
      mobileUserProfile.style.display = 'none';
      mobileLogoutBtn.style.display = 'none';
    }

    // Data loading functions
    async function loadProducts() {
      try {
        const snapshot = await realtimeDb.ref('products').once('value');
        const productsObj = snapshot.val();
        if (productsObj) {
          const newProducts = Object.keys(productsObj).map(key => ({
            id: key,
            ...productsObj[key]
          }));
          
          products = newProducts;
          saveToLocalStorage('products', products);
          
          renderProducts(products, 'homeProductGrid');
          renderProducts(products, 'productGrid');
          renderProductSlider(products.slice(0, 10), 'productSlider');
        }
      } catch (error) {
        console.error('Error loading products:', error);
        // Fallback to sample products if Firebase fails
        loadSampleProducts();
      }
    }

    async function loadCategories() {
      try {
        const snapshot = await realtimeDb.ref('categories').once('value');
        const categoriesObj = snapshot.val();
        if (categoriesObj) {
          const newCategories = Object.keys(categoriesObj).map(key => ({
            id: key,
            ...categoriesObj[key]
          }));
          
          categories = newCategories;
          saveToLocalStorage('categories', categories);
          
          renderCategories();
          renderCategoryCircles();
        }
      } catch (error) {
        console.error('Error loading categories:', error);
        // Fallback to sample categories
        loadSampleCategories();
      }
    }

    async function loadBanners() {
      try {
        const snapshot = await realtimeDb.ref('banners').once('value');
        const bannersObj = snapshot.val();
        if (bannersObj) {
          const newBanners = Object.keys(bannersObj).map(key => ({
            id: key,
            ...bannersObj[key]
          }));
          
          banners = newBanners;
          saveToLocalStorage('banners', banners);
          
          renderBannerCarousel();
        }
      } catch (error) {
        console.error('Error loading banners:', error);
        // Fallback to sample banners
        loadSampleBanners();
      }
    }

    function loadUserData(user) {
      realtimeDb.ref('users/' + user.uid).once('value').then(snapshot => {
        if (snapshot.exists()) {
          const userData = snapshot.val();
          userInfo = { ...userInfo, ...userData };
          
          // Update last login time in account page
          if (userData.lastLoginAt && document.getElementById('lastLoginTime')) {
            const lastLoginTime = new Date(userData.lastLoginAt).toLocaleString();
            document.getElementById('lastLoginTime').textContent = lastLoginTime;
          }
        }
      }).catch(error => {
        console.error('Error loading user data:', error);
      });
    }

    async function loadWishlist(user) {
      try {
        const snapshot = await realtimeDb.ref('wishlist/' + user.uid).once('value');
        const wishlistObj = snapshot.val();
        if (wishlistObj) {
          wishlist = Object.keys(wishlistObj);
        } else {
          wishlist = [];
        }
        
        updateWishlistButtons();
        
        // Render wishlist page if open
        if (document.getElementById('wishlistPage').classList.contains('active')) {
          renderWishlist();
        }
      } catch (error) {
        console.error('Error loading wishlist:', error);
      }
    }

    async function loadRecentlyViewed(user) {
      try {
        const snapshot = await realtimeDb.ref('recentlyViewed/' + user.uid).once('value');
        const recentlyViewedObj = snapshot.val();
        if (recentlyViewedObj) {
          recentlyViewed = Object.keys(recentlyViewedObj);
        } else {
          recentlyViewed = [];
        }
        
        // Render recently viewed section if there are items
        if (recentlyViewed.length > 0) {
          renderRecentlyViewed();
        }
      } catch (error) {
        console.error('Error loading recently viewed:', error);
      }
    }

    // Product rendering functions
    function renderProducts(productsToRender, containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      container.innerHTML = '';
      
      productsToRender.forEach(product => {
        const productCard = createProductCard(product);
        container.appendChild(productCard);
      });
    }

    function createProductCard(product) {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <div class="product-card-image" style="background-image: url('${getProductImage(product)}')">
          ${product.badge ? `<div class="product-card-badge">${product.badge}</div>` : ''}
          ${product.professional ? `<div class="professional-badge">PRO</div>` : ''}
        </div>
        <div class="product-card-body">
          <div class="product-card-title">${product.name}</div>
          <div class="product-card-rating">
            <div class="product-card-stars">★★★★★</div>
            <div class="product-card-review-count">(${product.reviews || '0'})</div>
          </div>
          <div class="product-card-price">
            <div class="product-card-current-price">${product.price}</div>
            ${product.originalPrice ? `<div class="product-card-original-price">${product.originalPrice}</div>` : ''}
          </div>
          <div class="product-card-actions">
            <button class="action-btn wishlist-btn ${isInWishlist(product.id) ? 'active' : ''}" data-product-id="${product.id}">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="${isInWishlist(product.id) ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
              </svg>
            </button>
            <button class="action-btn share-btn" data-product-id="${product.id}">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="18" cy="5" r="3"></circle>
                <circle cx="6" cy="12" r="3"></circle>
                <circle cx="18" cy="19" r="3"></circle>
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
              </svg>
            </button>
          </div>
        </div>
      `;
      
      // Add event listeners
      card.querySelector('.product-card-image').addEventListener('click', () => showProductDetail(product));
      card.querySelector('.wishlist-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        toggleWishlist(product.id);
      });
      card.querySelector('.share-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        shareProduct('default', product);
      });
      
      return card;
    }

    // NEW: Check if product is in wishlist (localStorage fallback)
    function isInWishlist(productId) {
      if (currentUser) {
        return wishlist.includes(productId);
      } else {
        // Fallback to localStorage for guests
        const guestWishlist = JSON.parse(localStorage.getItem('guestWishlist') || '[]');
        return guestWishlist.includes(productId);
      }
    }

    function renderProductSlider(productsToRender, containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      container.innerHTML = '';
      
      productsToRender.forEach(product => {
        const sliderItem = document.createElement('div');
        sliderItem.className = 'slider-item';
        sliderItem.innerHTML = `
          <div class="slider-item-img" style="background-image: url('${getProductImage(product)}')"></div>
          <div class="slider-item-body">
            <div class="slider-item-title">${product.name}</div>
            <div class="slider-item-price">${product.price}</div>
          </div>
        `;
        
        sliderItem.addEventListener('click', () => showProductDetail(product));
        container.appendChild(sliderItem);
      });
    }

    function renderCategories() {
      const container = document.getElementById('categoriesContainer');
      if (!container) return;
      
      container.innerHTML = '';
      
      categories.forEach(category => {
        const categoryPill = document.createElement('div');
        categoryPill.className = 'category-pill';
        categoryPill.textContent = category.name;
        categoryPill.addEventListener('click', () => filterByCategory(category.id));
        container.appendChild(categoryPill);
      });
    }

    function renderCategoryCircles() {
      const container = document.getElementById('categoryCirclesContainer');
      if (!container) return;
      
      container.innerHTML = '';
      
      categories.forEach(category => {
        const circle = document.createElement('div');
        circle.className = 'category-circle';
        circle.innerHTML = `
          <div class="category-circle-image" style="background-image: url('${getProductImage(category)}')"></div>
          <div class="category-circle-name">${category.name}</div>
        `;
        
        circle.addEventListener('click', () => filterByCategory(category.id));
        container.appendChild(circle);
      });
    }

    function renderBannerCarousel() {
      const track = document.getElementById('bannerTrack');
      const controls = document.getElementById('bannerControls');
      
      if (!track || !controls) return;
      
      track.innerHTML = '';
      controls.innerHTML = '';
      
      banners.forEach((banner, index) => {
        const slide = document.createElement('div');
        slide.className = 'banner-slide';
        slide.style.backgroundImage = `url('${getProductImage(banner)}')`;
        track.appendChild(slide);
        
        const dot = document.createElement('div');
        dot.className = `banner-dot ${index === 0 ? 'active' : ''}`;
        dot.addEventListener('click', () => setBannerSlide(index));
        controls.appendChild(dot);
      });
      
      // Auto-rotate banners
      setInterval(() => {
        const activeIndex = banners.findIndex((_, index) => 
          document.querySelector(`.banner-dot:nth-child(${index + 1})`).classList.contains('active')
        );
        const nextIndex = (activeIndex + 1) % banners.length;
        setBannerSlide(nextIndex);
      }, 5000);
    }

    function setBannerSlide(index) {
      const track = document.getElementById('bannerTrack');
      const dots = document.querySelectorAll('.banner-dot');
      
      if (!track || !dots.length) return;
      
      track.style.transform = `translateX(-${index * 100}%)`;
      
      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === index);
      });
    }

    // Product detail functions
    function showProductDetail(product) {
      currentProduct = product;
      
      // Update product detail page
      document.getElementById('detailTitle').textContent = product.name;
      document.getElementById('detailPrice').textContent = product.price;
      document.getElementById('detailDesc').textContent = product.description || '';
      document.getElementById('detailFullDesc').textContent = product.fullDescription || product.description || 'No description available.';
      document.getElementById('detailSku').textContent = `SKU: ${product.sku || 'N/A'}`;
      
      // Update stock status
      const stockStatus = document.getElementById('detailStockStatus');
      if (product.stock === 'in') {
        stockStatus.textContent = 'In Stock';
        stockStatus.className = 'stock-status in-stock';
      } else if (product.stock === 'low') {
        stockStatus.textContent = 'Low Stock';
        stockStatus.className = 'stock-status low-stock';
      } else {
        stockStatus.textContent = 'Out of Stock';
        stockStatus.className = 'stock-status out-of-stock';
      }
      
      // Initialize product detail gallery
      initProductDetailGallery(product);
      
      // Update share link
      document.getElementById('productShareLink').value = window.location.origin + window.location.pathname + '?product=' + product.id;
      
      // Update wishlist button
      const wishlistBtn = document.getElementById('detailWishlistBtn');
      if (isInWishlist(product.id)) {
        wishlistBtn.textContent = 'Remove from Wishlist';
        wishlistBtn.classList.add('active');
      } else {
        wishlistBtn.textContent = 'Add to Wishlist';
        wishlistBtn.classList.remove('active');
      }
      
      // Load similar products
      loadSimilarProducts(product);
      
      // Load reviews
      loadProductReviews(product.id);
      
      // Add to recently viewed if user is logged in
      if (currentUser) {
        addToRecentlyViewed(product.id);
      }
      
      // Show product detail page
      showPage('productDetailPage');
    }

    // NEW: Initialize product detail gallery
    function initProductDetailGallery(product) {
      const mainImage = document.getElementById('productDetailMainImage');
      const thumbnails = document.getElementById('productDetailThumbnails');
      const dots = document.getElementById('detailCarouselDots');
      
      if (!mainImage || !thumbnails || !dots) return;
      
      // Clear existing content
      thumbnails.innerHTML = '';
      dots.innerHTML = '';
      
      // Get images for the product
      const productImages = [];
      if (Array.isArray(product.images) && product.images.length > 0) {
        productImages.push(...product.images);
      } else {
        productImages.push(getProductImage(product));
      }
      
      // Set initial main image
      currentImageIndex = 0;
      updateMainImage();
      
      // Create thumbnails and dots
      productImages.forEach((image, index) => {
        // Create thumbnail
        const thumb = document.createElement('div');
        thumb.className = `product-detail-thumbnail ${index === 0 ? 'active' : ''}`;
        thumb.style.backgroundImage = `url('${image}')`;
        thumb.addEventListener('click', () => {
          currentImageIndex = index;
          updateMainImage();
          updateThumbnails();
          updateDots();
        });
        thumbnails.appendChild(thumb);
        
        // Create dot
        const dot = document.createElement('div');
        dot.className = `detail-carousel-dot ${index === 0 ? 'active' : ''}`;
        dot.addEventListener('click', () => {
          currentImageIndex = index;
          updateMainImage();
          updateThumbnails();
          updateDots();
        });
        dots.appendChild(dot);
      });
      
      function updateMainImage() {
        mainImage.style.backgroundImage = `url('${productImages[currentImageIndex]}')`;
      }
      
      function updateThumbnails() {
        document.querySelectorAll('.product-detail-thumbnail').forEach((thumb, index) => {
          thumb.classList.toggle('active', index === currentImageIndex);
        });
      }
      
      function updateDots() {
        document.querySelectorAll('.detail-carousel-dot').forEach((dot, index) => {
          dot.classList.toggle('active', index === currentImageIndex);
        });
      }
    }

    // NEW: Product detail image navigation
    function prevDetailImage() {
      const productImages = getProductImages();
      if (productImages.length <= 1) return;
      
      currentImageIndex = (currentImageIndex - 1 + productImages.length) % productImages.length;
      updateProductDetailImage();
    }

    function nextDetailImage() {
      const productImages = getProductImages();
      if (productImages.length <= 1) return;
      
      currentImageIndex = (currentImageIndex + 1) % productImages.length;
      updateProductDetailImage();
    }

    function getProductImages() {
      if (!currentProduct) return [];
      
      if (Array.isArray(currentProduct.images) && currentProduct.images.length > 0) {
        return currentProduct.images;
      } else {
        return [getProductImage(currentProduct)];
      }
    }

    function updateProductDetailImage() {
      const productImages = getProductImages();
      const mainImage = document.getElementById('productDetailMainImage');
      
      if (mainImage && productImages[currentImageIndex]) {
        mainImage.style.backgroundImage = `url('${productImages[currentImageIndex]}')`;
        
        // Update active thumbnail
        document.querySelectorAll('.product-detail-thumbnail').forEach((thumb, index) => {
          thumb.classList.toggle('active', index === currentImageIndex);
        });
        
        // Update active dot
        document.querySelectorAll('.detail-carousel-dot').forEach((dot, index) => {
          dot.classList.toggle('active', index === currentImageIndex);
        });
      }
    }

    function loadSimilarProducts(product) {
      // For now, just show random products from the same category if available
      const similarProducts = products
        .filter(p => p.id !== product.id)
        .slice(0, 10);
      
      renderProductSlider(similarProducts, 'similarProductsSlider');
    }

    // NEW: Review functions
    function showReviewForm() {
      document.getElementById('reviewForm').style.display = 'block';
      document.getElementById('writeReviewBtn').style.display = 'none';
    }

    function hideReviewForm() {
      document.getElementById('reviewForm').style.display = 'none';
      document.getElementById('writeReviewBtn').style.display = 'block';
      resetRating();
    }

    function setRating(rating) {
      currentRating = rating;
      const stars = document.querySelectorAll('#starRating span');
      
      stars.forEach((star, index) => {
        if (index < rating) {
          star.textContent = '★';
          star.style.color = '#ffc107';
        } else {
          star.textContent = '☆';
          star.style.color = '#ccc';
        }
      });
    }

    function resetRating() {
      currentRating = 0;
      const stars = document.querySelectorAll('#starRating span');
      
      stars.forEach(star => {
        star.textContent = '☆';
        star.style.color = '#ccc';
      });
    }

    async function submitReview() {
      if (!currentUser) {
        showLoginModal();
        return;
      }
      
      if (currentRating === 0) {
        showToast('Please select a rating', 'error');
        return;
      }
      
      const title = document.getElementById('reviewTitle').value;
      const message = document.getElementById('reviewMessage').value;
      
      if (!title || !message) {
        showToast('Please fill in all fields', 'error');
        return;
      }
      
      const reviewData = {
        productId: currentProduct.id,
        userId: currentUser.uid,
        userName: currentUser.displayName || 'Anonymous',
        rating: currentRating,
        title: title,
        message: message,
        date: Date.now()
      };
      
      try {
        const reviewId = 'review_' + Date.now();
        await realtimeDb.ref('reviews/' + reviewId).set(reviewData);
        
        showToast('Review submitted successfully', 'success');
        hideReviewForm();
        loadProductReviews(currentProduct.id);
      } catch (error) {
        console.error('Error submitting review:', error);
        showToast('Failed to submit review', 'error');
      }
    }

    async function loadProductReviews(productId) {
      try {
        const snapshot = await realtimeDb.ref('reviews').orderByChild('productId').equalTo(productId).once('value');
        const reviewsObj = snapshot.val();
        const reviewsList = document.getElementById('reviewsList');
        
        if (!reviewsList) return;
        
        reviewsList.innerHTML = '';
        
        if (!reviewsObj) {
          reviewsList.innerHTML = '<p style="color:var(--muted);text-align:center">No reviews yet. Be the first to review this product!</p>';
          return;
        }
        
        const reviews = Object.keys(reviewsObj).map(key => ({
          id: key,
          ...reviewsObj[key]
        }));
        
        // Sort by date (newest first)
        reviews.sort((a, b) => b.date - a.date);
        
        reviews.forEach(review => {
          const reviewElement = document.createElement('div');
          reviewElement.className = 'review-item';
          reviewElement.style.padding = '12px 0';
          reviewElement.style.borderBottom = '1px solid var(--border)';
          
          const stars = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating);
          
          reviewElement.innerHTML = `
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
              <strong>${review.userName}</strong>
              <div style="color:#ffc107">${stars}</div>
            </div>
            <div style="font-weight:600;margin-bottom:4px">${review.title}</div>
            <div style="color:var(--muted);margin-bottom:4px">${review.message}</div>
            <div style="font-size:12px;color:var(--muted-light)">${new Date(review.date).toLocaleDateString()}</div>
          `;
          
          reviewsList.appendChild(reviewElement);
        });
      } catch (error) {
        console.error('Error loading reviews:', error);
      }
    }

    // Order flow functions
    function toUserInfo() {
      // Validate size selection
      const selectedSize = document.querySelector('.size-option.selected');
      if (!selectedSize) {
        document.getElementById('sizeValidationError').classList.add('show');
        return;
      }
      
      showPage('userPage');
    }

    function toPayment() {
      // Validate user info
      const fullname = document.getElementById('fullname').value;
      const mobile = document.getElementById('mobile').value;
      const pincode = document.getElementById('pincode').value;
      const city = document.getElementById('city').value;
      const state = document.getElementById('state').value;
      const house = document.getElementById('house').value;
      
      if (!fullname || !mobile || !pincode || !city || !state || !house) {
        showToast('Please fill in all required fields', 'error');
        return;
      }
      
      // Save user info
      userInfo = {
        fullName: fullname,
        mobile: mobile,
        pincode: pincode,
        city: city,
        state: state,
        house: house
      };
      
      // Update summary
      updatePaymentSummary();
      
      showPage('paymentPage');
    }

    // NEW: Update payment summary with gateway charges
    function updatePaymentSummary() {
      if (!currentProduct) return;
      
      const paymentMethod = document.querySelector('input[name="pay"]:checked').value;
      const quantity = parseInt(document.getElementById('qtySelect').value);
      const productPrice = parseFloat(currentProduct.price.replace('₹', ''));
      const subtotal = productPrice * quantity;
      const deliveryCharge = 50;
      let paymentCharge = 0;
      
      if (paymentMethod === 'prepaid') {
        paymentCharge = subtotal * 0.02; // 2% payment gateway charge
      }
      
      const total = subtotal + deliveryCharge + paymentCharge;
      
      document.getElementById('sumProduct').textContent = currentProduct.name;
      document.getElementById('sumQty').textContent = quantity;
      document.getElementById('sumPrice').textContent = `₹${subtotal}`;
      document.getElementById('sumTotal').textContent = `₹${total}`;
      
      // Show/hide payment charge row
      const paymentChargeRow = document.getElementById('paymentChargeRow');
      const sumCharge = document.getElementById('sumCharge');
      
      if (paymentMethod === 'prepaid') {
        paymentChargeRow.style.display = 'flex';
        sumCharge.textContent = `₹${paymentCharge.toFixed(2)}`;
      } else {
        paymentChargeRow.style.display = 'none';
      }
    }

    // Wishlist functions
    async function toggleWishlist(productId) {
      if (!currentUser) {
        // For guests, use localStorage
        let guestWishlist = JSON.parse(localStorage.getItem('guestWishlist') || '[]');
        
        if (!guestWishlist.includes(productId)) {
          // Add to wishlist
          guestWishlist.push(productId);
          localStorage.setItem('guestWishlist', JSON.stringify(guestWishlist));
          showToast('Added to wishlist', 'success');
        } else {
          // Remove from wishlist
          guestWishlist = guestWishlist.filter(id => id !== productId);
          localStorage.setItem('guestWishlist', JSON.stringify(guestWishlist));
          showToast('Removed from wishlist', 'success');
        }
        
        updateWishlistButtons();
        
        // Update detail page if open
        if (document.getElementById('productDetailPage').classList.contains('active') && 
            currentProduct && currentProduct.id === productId) {
          const wishlistBtn = document.getElementById('detailWishlistBtn');
          if (isInWishlist(productId)) {
            wishlistBtn.textContent = 'Remove from Wishlist';
            wishlistBtn.classList.add('active');
          } else {
            wishlistBtn.textContent = 'Add to Wishlist';
            wishlistBtn.classList.remove('active');
          }
        }
        
        // Update wishlist page if open
        if (document.getElementById('wishlistPage').classList.contains('active')) {
          renderWishlist();
        }
        
        return;
      }
      
      try {
        const wishlistRef = realtimeDb.ref('wishlist/' + currentUser.uid + '/' + productId);
        const snapshot = await wishlistRef.once('value');
        
        if (!snapshot.exists()) {
          // Add to wishlist
          await wishlistRef.set(true);
          
          wishlist.push(productId);
          showToast('Added to wishlist', 'success');
        } else {
          // Remove from wishlist
          await wishlistRef.remove();
          
          wishlist = wishlist.filter(id => id !== productId);
          showToast('Removed from wishlist', 'success');
        }
        
        updateWishlistButtons();
        
        // Update detail page if open
        if (document.getElementById('productDetailPage').classList.contains('active') && 
            currentProduct && currentProduct.id === productId) {
          const wishlistBtn = document.getElementById('detailWishlistBtn');
          if (isInWishlist(productId)) {
            wishlistBtn.textContent = 'Remove from Wishlist';
            wishlistBtn.classList.add('active');
          } else {
            wishlistBtn.textContent = 'Add to Wishlist';
            wishlistBtn.classList.remove('active');
          }
        }
        
        // Update wishlist page if open
        if (document.getElementById('wishlistPage').classList.contains('active')) {
          renderWishlist();
        }
      } catch (error) {
        console.error('Error updating wishlist:', error);
        showToast('Failed to update wishlist', 'error');
      }
    }

    function toggleWishlistFromDetail() {
      if (!currentProduct) return;
      toggleWishlist(currentProduct.id);
    }

    function updateWishlistButtons() {
      document.querySelectorAll('.wishlist-btn').forEach(btn => {
        const productId = btn.getAttribute('data-product-id');
        if (isInWishlist(productId)) {
          btn.classList.add('active');
          btn.querySelector('svg').setAttribute('fill', 'currentColor');
        } else {
          btn.classList.remove('active');
          btn.querySelector('svg').setAttribute('fill', 'none');
        }
      });
    }

    function renderWishlist() {
      const container = document.getElementById('wishlistItems');
      const empty = document.getElementById('emptyWishlist');
      
      if (!container || !empty) return;
      
      // Get wishlist product IDs
      let wishlistProductIds = [];
      if (currentUser) {
        wishlistProductIds = wishlist;
      } else {
        // For guests, get from localStorage
        wishlistProductIds = JSON.parse(localStorage.getItem('guestWishlist') || '[]');
      }
      
      const wishlistProducts = products.filter(product => wishlistProductIds.includes(product.id));
      
      if (wishlistProducts.length === 0) {
        container.style.display = 'none';
        empty.style.display = 'block';
        return;
      }
      
      container.style.display = 'block';
      empty.style.display = 'none';
      container.innerHTML = '';
      
      wishlistProducts.forEach(product => {
        const productCard = createProductCard(product);
        container.appendChild(productCard);
      });
    }

    // Recently viewed functions
    async function addToRecentlyViewed(productId) {
      if (!currentUser) return;
      
      try {
        // Add/update entry
        await realtimeDb.ref('recentlyViewed/' + currentUser.uid + '/' + productId).set(Date.now());
        
        // Reload recently viewed
        loadRecentlyViewed(currentUser);
      } catch (error) {
        console.error('Error adding to recently viewed:', error);
      }
    }

    function renderRecentlyViewed() {
      const section = document.getElementById('recentlyViewedSection');
      const slider = document.getElementById('recentlyViewedSlider');
      
      if (!section || !slider) return;
      
      const recentlyViewedProducts = products.filter(product => 
        recentlyViewed.includes(product.id)
      ).slice(0, 10);
      
      if (recentlyViewedProducts.length === 0) {
        section.style.display = 'none';
        return;
      }
      
      section.style.display = 'block';
      renderProductSlider(recentlyViewedProducts, 'recentlyViewedSlider');
    }

    // Search functions
    function handleSearch() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      filterProducts(query, 'productGrid');
    }

    function handleHomeSearch() {
      const query = document.getElementById('homeSearchInput').value.toLowerCase();
      const resultsContainer = document.getElementById('homeSearchResults');
      
      if (query.length === 0) {
        resultsContainer.style.display = 'none';
        document.getElementById('homeProductGrid').style.display = 'grid';
        return;
      }
      
      const filteredProducts = products.filter(product => 
        product.name.toLowerCase().includes(query) ||
        (product.description && product.description.toLowerCase().includes(query))
      );
      
      if (filteredProducts.length === 0) {
        resultsContainer.innerHTML = '<div class="card-panel center">No products found</div>';
      } else {
        renderProducts(filteredProducts, 'homeSearchResults');
      }
      
      resultsContainer.style.display = 'grid';
      document.getElementById('homeProductGrid').style.display = 'none';
    }

    function filterProducts(query, containerId) {
      const filteredProducts = query ? 
        products.filter(product => 
          product.name.toLowerCase().includes(query) ||
          (product.description && product.description.toLowerCase().includes(query))
        ) : 
        products;
      
      renderProducts(filteredProducts, containerId);
    }

    // NEW: Improved category filtering
    function filterByCategory(categoryId) {
      currentCategoryFilter = categoryId;
      
      const filteredProducts = products.filter(product => 
        product.category === categoryId
      );
      
      renderProducts(filteredProducts, 'productGrid');
      
      // Update active category pill
      document.querySelectorAll('.category-pill').forEach(pill => {
        pill.classList.remove('active');
      });
      
      document.querySelectorAll('.category-pill').forEach(pill => {
        if (pill.textContent === categories.find(c => c.id === categoryId)?.name) {
          pill.classList.add('active');
        }
      });
      
      // Show products page if not already there
      showPage('productsPage');
    }

    // Price filter functions
    function applyPriceFilter() {
      const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
      const maxPrice = parseFloat(document.getElementById('maxPrice').value) || 5000;
      
      let filteredProducts = products;
      
      // Apply category filter if active
      if (currentCategoryFilter) {
        filteredProducts = filteredProducts.filter(product => 
          product.category === currentCategoryFilter
        );
      }
      
      // Apply price filter
      filteredProducts = filteredProducts.filter(product => {
        const price = parseFloat(product.price.replace('₹', ''));
        return price >= minPrice && price <= maxPrice;
      });
      
      renderProducts(filteredProducts, 'productGrid');
    }

    function resetPriceFilter() {
      document.getElementById('minPrice').value = '';
      document.getElementById('maxPrice').value = '';
      document.getElementById('minPriceSlider').value = 0;
      document.getElementById('maxPriceSlider').value = 5000;
      document.getElementById('minPriceValue').textContent = '₹0';
      document.getElementById('maxPriceValue').textContent = '₹5000';
      
      let filteredProducts = products;
      
      // Apply category filter if active
      if (currentCategoryFilter) {
        filteredProducts = filteredProducts.filter(product => 
          product.category === currentCategoryFilter
        );
      }
      
      renderProducts(filteredProducts, 'productGrid');
    }

    // Quantity functions
    function decreaseQuantity() {
      const qtyInput = document.getElementById('qtySelect');
      let value = parseInt(qtyInput.value);
      if (value > 1) {
        qtyInput.value = value - 1;
      }
    }

    function increaseQuantity() {
      const qtyInput = document.getElementById('qtySelect');
      let value = parseInt(qtyInput.value);
      if (value < 10) {
        qtyInput.value = value + 1;
      }
    }

    // Order from product detail
    function orderProductFromDetail() {
      if (!currentProduct) return;
      
      // Set current product for order flow
      currentProduct = currentProduct;
      
      // Update order page
      document.getElementById('spTitle').textContent = currentProduct.name;
      document.getElementById('spPrice').textContent = currentProduct.price;
      document.getElementById('spDesc').textContent = currentProduct.description || '';
      document.getElementById('spFullDesc').textContent = currentProduct.fullDescription || currentProduct.description || '';
      
      // Update gallery
      const galleryMain = document.getElementById('galleryMain');
      galleryMain.style.backgroundImage = `url('${getProductImage(currentProduct)}')`;
      
      // Show order page
      showPage('orderPage');
    }

    // Sharing functions
    function shareProduct(platform, product = null) {
      const shareProduct = product || currentProduct;
      if (!shareProduct) return;
      
      const shareUrl = window.location.origin + window.location.pathname + '?product=' + shareProduct.id;
      const shareText = `Check out ${shareProduct.name} on Buyzo Cart - ${shareProduct.price}`;
      
      let shareLink = '';
      
      switch (platform) {
        case 'facebook':
          shareLink = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;
          break;
        case 'twitter':
          shareLink = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`;
          break;
        case 'whatsapp':
          shareLink = `https://wa.me/?text=${encodeURIComponent(shareText + ' ' + shareUrl)}`;
          break;
        default:
          // Fallback to Web Share API if available
          if (navigator.share) {
            navigator.share({
              title: shareProduct.name,
              text: shareText,
              url: shareUrl
            });
            return;
          }
          break;
      }
      
      if (shareLink) {
        window.open(shareLink, '_blank');
      }
    }

    function copyShareLink() {
      const shareLink = document.getElementById('productShareLink');
      shareLink.select();
      document.execCommand('copy');
      showToast('Link copied to clipboard', 'success');
    }

    // Image zoom functions
    function openImageZoom() {
      if (!currentProduct) return;
      
      const productImages = getProductImages();
      const imageUrl = productImages[currentImageIndex];
      
      zoomImage.src = imageUrl;
      zoomModal.classList.add('active');
      resetZoom();
    }

    function adjustZoom(delta) {
      currentZoomLevel += delta;
      currentZoomLevel = Math.max(0.5, Math.min(3, currentZoomLevel));
      zoomImage.style.transform = `scale(${currentZoomLevel})`;
    }

    function resetZoom() {
      currentZoomLevel = 1;
      zoomImage.style.transform = 'scale(1)';
    }

    // Newsletter subscription
    function handleNewsletterSubscription() {
      const email = document.getElementById('newsletterEmail').value;
      
      if (!email) {
        showToast('Please enter your email address', 'error');
        return;
      }
      
      // In a real app, you would save this to your database
      showToast('Thank you for subscribing!', 'success');
      document.getElementById('newsletterEmail').value = '';
    }

    // Account functions
    function saveProfile() {
      const name = document.getElementById('profileName').value;
      const phone = document.getElementById('profilePhone').value;
      
      if (!currentUser) return;
      
      realtimeDb.ref('users/' + currentUser.uid).update({
        name: name,
        phone: phone,
        updatedAt: Date.now()
      }).then(() => {
        showToast('Profile updated successfully', 'success');
        // Update UI
        userName.textContent = name;
        mobileUserName.textContent = name;
        userAvatarInitial.textContent = name.charAt(0).toUpperCase();
      }).catch(error => {
        console.error('Error updating profile:', error);
        showToast('Failed to update profile', 'error');
      });
    }

    function deleteAccount() {
      if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
        // In a real app, you would delete the user account
        showToast('Account deletion feature coming soon', 'info');
      }
    }

    function saveSettings() {
      const emailNotifications = document.getElementById('emailNotifications').checked;
      const smsNotifications = document.getElementById('smsNotifications').checked;
      const pushNotifications = document.getElementById('pushNotifications').checked;
      const personalizedRecs = document.getElementById('personalizedRecs').checked;
      const dataSharing = document.getElementById('dataSharing').checked;
      const language = document.getElementById('languageSelect').value;
      const currency = document.getElementById('currencySelect').value;
      
      if (!currentUser) return;
      
      realtimeDb.ref('users/' + currentUser.uid + '/settings').set({
        emailNotifications,
        smsNotifications,
        pushNotifications,
        personalizedRecs,
        dataSharing,
        language,
        currency
      }).then(() => {
        showToast('Settings saved successfully', 'success');
      }).catch(error => {
        console.error('Error saving settings:', error);
        showToast('Failed to save settings', 'error');
      });
    }

    // Address functions
    function showNewAddressForm() {
      document.getElementById('newAddressForm').style.display = 'block';
    }

    function hideNewAddressForm() {
      document.getElementById('newAddressForm').style.display = 'none';
    }

    function saveAddress() {
      const name = document.getElementById('addressName').value;
      const mobile = document.getElementById('addressMobile').value;
      const pincode = document.getElementById('addressPincode').value;
      const city = document.getElementById('addressCity').value;
      const state = document.getElementById('addressState').value;
      const type = document.getElementById('addressType').value;
      const street = document.getElementById('addressStreet').value;
      
      if (!name || !mobile || !pincode || !city || !state || !street) {
        showToast('Please fill in all required fields', 'error');
        return;
      }
      
      if (!currentUser) return;
      
      const addressId = 'address_' + Date.now();
      
      realtimeDb.ref('addresses/' + addressId).set({
        userId: currentUser.uid,
        name: name,
        mobile: mobile,
        pincode: pincode,
        city: city,
        state: state,
        type: type,
        street: street,
        isDefault: false, // You might want to implement logic for default address
        createdAt: Date.now()
      }).then(() => {
        showToast('Address saved successfully', 'success');
        hideNewAddressForm();
        loadAddresses();
      }).catch(error => {
        console.error('Error saving address:', error);
        showToast('Failed to save address', 'error');
      });
    }

    function loadAddresses() {
      if (!currentUser) return;
      
      realtimeDb.ref('addresses').orderByChild('userId').equalTo(currentUser.uid)
        .once('value')
        .then(snapshot => {
          const container = document.getElementById('savedAddresses');
          container.innerHTML = '';
          
          if (!snapshot.exists()) {
            container.innerHTML = '<p style="color:var(--muted);text-align:center">No addresses saved yet</p>';
            return;
          }
          
          const addressesObj = snapshot.val();
          const addresses = Object.keys(addressesObj).map(key => ({
            id: key,
            ...addressesObj[key]
          }));
          
          // Sort by creation date
          addresses.sort((a, b) => b.createdAt - a.createdAt);
          
          addresses.forEach(address => {
            const addressCard = document.createElement('div');
            addressCard.className = 'address-card';
            addressCard.innerHTML = `
              <div style="font-weight:600">${address.name}</div>
              <div>${address.street}</div>
              <div>${address.city}, ${address.state} - ${address.pincode}</div>
              <div>Mobile: ${address.mobile}</div>
              <div class="address-actions">
                <button class="btn secondary edit-address" data-id="${address.id}">Edit</button>
                <button class="btn secondary delete-address" data-id="${address.id}">Delete</button>
              </div>
            `;
            container.appendChild(addressCard);
          });
        })
        .catch(error => {
          console.error('Error loading addresses:', error);
        });
    }

    // Step pills update
    function updateStepPills() {
      const currentPage = document.querySelector('.page.active').id;
      
      document.querySelectorAll('.step-pill').forEach(pill => {
        pill.classList.remove('disabled');
      });
      
      switch (currentPage) {
        case 'homePage':
        case 'productsPage':
          document.getElementById('pill-order').classList.add('disabled');
          document.getElementById('pill-user').classList.add('disabled');
          document.getElementById('pill-pay').classList.add('disabled');
          break;
        case 'orderPage':
          document.getElementById('pill-user').classList.add('disabled');
          document.getElementById('pill-pay').classList.add('disabled');
          break;
        case 'userPage':
          document.getElementById('pill-pay').classList.add('disabled');
          break;
      }
    }

    // Hero messages rotation
    function setupHeroMessages() {
      const messages = document.querySelectorAll('#heroMessages span');
      let currentIndex = 0;
      
      setInterval(() => {
        messages.forEach(msg => msg.classList.remove('active'));
        currentIndex = (currentIndex + 1) % messages.length;
        messages[currentIndex].classList.add('active');
      }, 3000);
    }

    // Email sending function
    function sendOrderConfirmationEmail(orderData) {
      // This would use EmailJS or your email service in a real app
      console.log('Order confirmation email would be sent for:', orderData);
    }

    // Orders rendering function
    function renderOrders(orders) {
      const container = document.getElementById('ordersList');
      const empty = document.getElementById('orders-empty');
      
      if (!container || !empty) return;
      
      if (orders.length === 0) {
        container.style.display = 'none';
        empty.style.display = 'block';
        return;
      }
      
      container.style.display = 'block';
      empty.style.display = 'none';
      container.innerHTML = '';
      
      orders.forEach(order => {
        const orderCard = document.createElement('div');
        orderCard.className = 'order-card';
        orderCard.innerHTML = `
          <div class="order-header">
            <div>
              <div class="order-id">${order.orderId}</div>
              <div class="order-date">${new Date(order.orderDate).toLocaleDateString()}</div>
            </div>
            <div class="order-status status-${order.status}">${order.status}</div>
          </div>
          <div class="order-details">
            <div class="order-product-image" style="background-image: url('${getProductImage(products.find(p => p.id === order.productId))}')"></div>
            <div class="order-product-info">
              <div class="order-product-title">${order.productName}</div>
              <div class="order-product-price">₹${order.price}</div>
              <div class="order-product-meta">Qty: ${order.quantity} | Size: ${order.size}</div>
            </div>
          </div>
          <div class="order-actions">
            <button class="btn secondary view-order-details" data-order-id="${order.id}">View Details</button>
            ${order.status === 'delivered' && isWithinRefundPeriod(order.orderDate) ? 
              `<button class="btn error request-refund" data-order-id="${order.id}">Request Refund</button>` : ''}
          </div>
        `;
        
        orderCard.addEventListener('click', () => showOrderDetail(order));
        container.appendChild(orderCard);
      });
    }

    // NEW: Check if order is within refund period (5 days)
    function isWithinRefundPeriod(orderDate) {
      const fiveDaysAgo = Date.now() - (5 * 24 * 60 * 60 * 1000);
      return orderDate > fiveDaysAgo;
    }

    function showOrderDetail(order) {
      // Implementation for showing order details
      showPage('orderDetailPage');
    }

    function showMyOrders() {
      if (!currentUser) return;
      
      realtimeDb.ref('orders').orderByChild('userId').equalTo(currentUser.uid)
        .once('value')
        .then(snapshot => {
          if (snapshot.exists()) {
            const ordersObj = snapshot.val();
            const orders = Object.keys(ordersObj).map(key => ({
              id: key,
              ...ordersObj[key]
            }));
            
            // Sort by order date
            orders.sort((a, b) => b.orderDate - a.orderDate);
            renderOrders(orders);
          } else {
            renderOrders([]);
          }
        })
        .catch(error => {
          console.error('Error loading orders:', error);
        });
    }

    // Sample data fallbacks
    function loadSampleProducts() {
      products = [
        {
          id: '1',
          name: 'Wireless Bluetooth Earbuds',
          price: '₹1,299',
          originalPrice: '₹2,499',
          image: 'https://images.unsplash.com/photo-1590658165737-15a047b8b5e3?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8ZWFyYnVkc3xlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=500&q=60',
          description: 'High-quality wireless earbuds with noise cancellation',
          badge: '50% OFF',
          reviews: '124'
        },
        {
          id: '2',
          name: 'Smart Fitness Band',
          price: '₹1,999',
          image: 'https://images.unsplash.com/photo-1575311373937-040b8e1f4ed5?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NXx8Zml0bmVzcyUyMGJhbmR8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60',
          description: 'Track your fitness activities with this smart band',
          badge: 'NEW',
          reviews: '89'
        }
      ];
      
      renderProducts(products, 'homeProductGrid');
      renderProducts(products, 'productGrid');
      renderProductSlider(products.slice(0, 10), 'productSlider');
    }

    function loadSampleCategories() {
      categories = [
        {
          id: '1',
          name: 'Electronics',
          image: 'https://images.unsplash.com/photo-1498049794561-7780e7231661?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8ZWxlY3Ryb25pY3N8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60'
        },
        {
          id: '2',
          name: 'Fashion',
          image: 'https://images.unsplash.com/photo-1445205170230-053b83016050?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8ZmFzaGlvbnxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=500&q=60'
        }
      ];
      
      renderCategories();
      renderCategoryCircles();
    }

    function loadSampleBanners() {
      banners = [
        {
          id: '1',
          image: 'https://images.unsplash.com/photo-1607082350899-7e105aa886ae?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8c2hvcHBpbmclMjBiYW5uZXJ8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=1200&q=60'
        },
        {
          id: '2',
          image: 'https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NXx8c2hvcHBpbmclMjBiYW5uZXJ8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=1200&q=60'
        }
      ];
      
      renderBannerCarousel();
    }
  </script>
</body>
</html>